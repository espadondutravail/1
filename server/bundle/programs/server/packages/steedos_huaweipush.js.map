{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos:huaweipush/checkNpm.js","meteor://ðŸ’»app/packages/steedos:huaweipush/server/huaweiProvider.js"],"names":["checkNpmVersions","module","link","v","request","require","tokenUrl","apiUrl","timeout","HuaweiPush","authInfo","default_package_name","undefined","debug","Meteor","settings","push","huawei","config","forEach","val","package_name","access_token_expire","console","info","sendMany","notification","tokenDataList","timeToLive","android","title","mapTokenData","tokenData","error","tokenList","token","doSendMany","tokens","checkToken","tokenError","log","postData","getPostData","post","url","replace","client_id","body","JSON","stringify","access_token","maxAttempts","retryDelay","time","retryStrategy","RetryStrategies","NetworkError","response","statusCode","message","extras","sendAll","callback","Date","now","form","grant_type","client_secret","data","parse","expires_in","formatHuaweiDate","date","moment","format","Array","isArray","extraArray","keys","Object","key"],"mappings":"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","file":"/packages/steedos_huaweipush.js","sourcesContent":["import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\n","const request = require('requestretry');\nconst tokenUrl = \"https://oauth-login.cloud.huawei.com/oauth2/v3/token\";\nconst apiUrl = \"https://push-api.cloud.huawei.com/v1/[clientid]/messages:send\";\nconst timeout = 5000;\n\nHuaweiPush = {\n\tauthInfo: {},\n\tdefault_package_name: undefined,\n\tdebug: Meteor.settings.push && Meteor.settings.push.huawei && Meteor.settings.push.huawei.debug\n};\n\nHuaweiPush.config = function(config) {\n\tconfig.forEach((val) => {\n\t\tif (this.authInfo[val.package_name])\n\t\t\treturn\n\t\tthis.authInfo[val.package_name] = val;\n\t\tval.access_token_expire = 0;\n\t\tif (!this.default_package_name) {\n\t\t\tthis.default_package_name = val.package_name;\n\t\t\tif (HuaweiPush.debug)\n\t\t\t\tconsole.info('huawei default package name ', this.default_package_name);\n\t\t}\n\t});\n}\n\nHuaweiPush.sendMany = function(notification, tokenDataList, timeToLive) {\n\tif (notification.android.title) {\n\t\tconst mapTokenData = {};\n\t\tfor (const tokenData of tokenDataList) {\n\t\t\tconst package_name = tokenData.package_name || this.default_package_name;\n\t\t\tif (!this.authInfo[package_name]) {\n\t\t\t\tconsole.error('huawei package name not supported: ', package_name);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst tokenList = mapTokenData[package_name] || [];\n\t\t\ttokenList.push(tokenData.token);\n\t\t\tmapTokenData[package_name] = tokenList;\n\t\t}\n\n\t\tfor (const package_name in mapTokenData) {\n\t\t\tthis.doSendMany(notification, package_name, mapTokenData[package_name], timeToLive);\n\t\t}\n\t}\n}\n\nHuaweiPush.doSendMany = function(notification, package_name, tokens, timeToLive) {\n\tthis.checkToken(package_name, (tokenError) => {\n\t\tif (!tokenError) {\n\t\t\tif (HuaweiPush.debug)\n\t\t\t\tconsole.log(\"sendMany \", notification, timeToLive);\n\t\t\tconst postData = this.getPostData(notification, package_name, tokens, timeToLive);\n\t\t\trequest.post({\n\t\t\t\turl: apiUrl.replace('[clientid]', this.authInfo[package_name].client_id),\n\t\t\t\tbody: JSON.stringify(postData),\n\t\t\t\t'headers': {\n\t\t\t\t\t'Authorization': 'Bearer '+ this.authInfo[package_name].access_token\n\t\t\t\t},\n\t\t\t\ttimeout: timeout,\n\t\t\t\tmaxAttempts: 2,\n\t\t\t\tretryDelay: 5000,\n\t\t\t\ttime: true,\n\t\t\t\tretryStrategy: request.RetryStrategies.NetworkError\n\t\t\t}, (error, response, body) => {\n\t\t\t\tif (HuaweiPush.debug)\n\t\t\t\t\tconsole.log(\"sendMany result\", error, body);\n\t\t\t\tif (!error && response && response.statusCode == 200) {\n\t\t\t\t\tif (HuaweiPush.debug)\n\t\t\t\t\t\tconsole.log(\"TODO: callback\");\n\t\t\t\t} else {\n\t\t\t\t\terror = error || 'unknown error';\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nHuaweiPush.getPostData = function(notification, package_name, tokens, timeToLive) {\n\tconst postData = {\n\t\t\"validate_only\": false,\n\t\t\"message\": {\n\t\t\t\"android\": {\n\t\t\t\t\"notification\": {\n\t\t\t\t\t\"title\": notification.android.title,\n\t\t\t\t\t\"body\": notification.android.message,\n\t\t\t\t\t\"click_action\": {\n\t\t\t\t\t\t\"type\": 3\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t\"category\": \"WORK\"\n\t\t\t},\n\t\t\t\"token\": tokens,\n\t\t\t\"data\": JSON.stringify(notification.extras)\n\t\t}\n\t  }\n\treturn postData;\n}\n\nHuaweiPush.sendAll = function(notification, timeToLive) {\n\tif (notification.android.title) {\n\t\tfor (const package_name in this.authInfo) {\n\t\t\tconsole.log(\"TODO: sendAll\");\n\t\t}\n\t}\n}\n\nHuaweiPush.checkToken = function(package_name, callback) {\n\tconst authInfo = this.authInfo[package_name];\n\tif (authInfo.access_token && Date.now() < authInfo.access_token_expire) {\n\t\tcallback();\n\t} else {\n\t\tif (HuaweiPush.debug)\n\t\t\tconsole.info(\"request token \", package_name, this.authInfo[package_name]);\n\t\trequest.post({\n\t\t\turl: tokenUrl,\n\t\t\tform: {\n\t\t\t\tgrant_type: \"client_credentials\",\n\t\t\t\tclient_id: authInfo.client_id,\n\t\t\t\tclient_secret: authInfo.client_secret\n\t\t\t},\n\t\t\ttimeout: timeout,\n\t\t\tmaxAttempts: 2,\n\t\t\tretryDelay: 5000,\n\t\t\tretryStrategy: request.RetryStrategies.NetworkError\n\t\t}, (error, response, body) => {\n\t\t\tif (!error) {\n\t\t\t\tconst data = JSON.parse(body);\n\t\t\t\tauthInfo.access_token = data.access_token;\n\t\t\t\tauthInfo.access_token_expire = Date.now() + data.expires_in * 1000 - 60 * 1000;\n\t\t\t\tif (HuaweiPush.debug)\n\t\t\t\t\tconsole.info(\"get access token success\", data);\n\t\t\t\tcallback();\n\t\t\t} else {\n\t\t\t\tconsole.error(\"get access token error\", body);\n\t\t\t\tcallback(error);\n\t\t\t}\n\t\t});\n\t}\n}\n\nHuaweiPush.formatHuaweiDate = function(date) {\n\treturn moment(date).format(\"YYYY-MM-DDTHH:mm\");\n}\n\n/*\n * ç”¨æˆ·è‡ªå®šä¹‰ dict\n * \"extras\":{\"season\":\"Spring\", \"weather\":\"raining\"}]\n */\nHuaweiPush.extras = function(extras) {\n\tif (Array.isArray(extras))\n\t\treturn extras;\n\n\tvar extraArray = [];\n\tif (extras) {\n\t\tvar keys = Object.keys(extras);\n\t\tkeys.forEach(function(key) {\n\t\t\tvar v = {};\n\t\t\tv[key] = extras[key];\n\t\t\textraArray.push(v)\n\t\t})\n\t\textras = extraArray\n\t}\n\treturn extraArray;\n};"]}