{"version":3,"sources":["meteor://💻app/packages/steedos:base/checkNpm.js","meteor://💻app/packages/steedos:base/lib/steedos_util.js","meteor://💻app/packages/steedos_base/lib/core.coffee","meteor://💻app/lib/core.coffee","meteor://💻app/packages/steedos:base/lib/simple_schema_extend.js","meteor://💻app/packages/steedos_base/lib/methods/last_logon.coffee","meteor://💻app/lib/methods/last_logon.coffee","meteor://💻app/packages/steedos_base/lib/methods/user_add_email.coffee","meteor://💻app/lib/methods/user_add_email.coffee","meteor://💻app/packages/steedos_base/lib/methods/user_avatar.coffee","meteor://💻app/lib/methods/user_avatar.coffee","meteor://💻app/packages/steedos:base/lib/methods/email_templates_reset.js","meteor://💻app/packages/steedos:base/lib/methods/upgrade_data.js","meteor://💻app/packages/steedos_base/lib/steedos/push.coffee","meteor://💻app/lib/steedos/push.coffee","meteor://💻app/packages/steedos_base/lib/admin.coffee","meteor://💻app/lib/admin.coffee","meteor://💻app/packages/steedos:base/lib/array_includes.js","meteor://💻app/packages/steedos_base/lib/settings.coffee","meteor://💻app/lib/settings.coffee","meteor://💻app/packages/steedos_base/lib/user_object_view.coffee","meteor://💻app/lib/user_object_view.coffee","meteor://💻app/packages/steedos:base/lib/server_session.js","meteor://💻app/packages/steedos_base/routes/api_get_apps.coffee","meteor://💻app/routes/api_get_apps.coffee","meteor://💻app/packages/steedos_base/routes/collection.coffee","meteor://💻app/routes/collection.coffee","meteor://💻app/packages/steedos_base/routes/sso.coffee","meteor://💻app/routes/sso.coffee","meteor://💻app/packages/steedos_base/routes/avatar.coffee","meteor://💻app/routes/avatar.coffee","meteor://💻app/packages/steedos_base/routes/access_token.coffee","meteor://💻app/routes/access_token.coffee","meteor://💻app/packages/steedos_base/server/publications/apps.coffee","meteor://💻app/server/publications/apps.coffee","meteor://💻app/packages/steedos_base/server/publications/my_spaces.coffee","meteor://💻app/server/publications/my_spaces.coffee","meteor://💻app/packages/steedos_base/server/publications/space_avatar.coffee","meteor://💻app/server/publications/space_avatar.coffee","meteor://💻app/packages/steedos_base/server/publications/modules.coffee","meteor://💻app/server/publications/modules.coffee","meteor://💻app/packages/steedos_base/server/publications/weixin_pay_code_url.coffee","meteor://💻app/server/publications/weixin_pay_code_url.coffee","meteor://💻app/packages/steedos_base/server/methods/my_contacts_limit.coffee","meteor://💻app/server/methods/my_contacts_limit.coffee","meteor://💻app/packages/steedos:base/server/methods/setKeyValue.js","meteor://💻app/packages/steedos_base/server/methods/setUsername.coffee","meteor://💻app/server/methods/setUsername.coffee","meteor://💻app/packages/steedos_base/server/methods/get_space_user_count.coffee","meteor://💻app/packages/steedos_base/server/methods/user_secret.coffee","meteor://💻app/server/methods/user_secret.coffee","meteor://💻app/packages/steedos_base/server/methods/object_workflows.coffee","meteor://💻app/server/methods/object_workflows.coffee","meteor://💻app/packages/steedos_base/server/lib/billing_manager.coffee","meteor://💻app/server/lib/billing_manager.coffee","meteor://💻app/packages/steedos:base/server/schedule/statistics.js","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v1.coffee","meteor://💻app/server/steedos/startup/migrations/v1.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v2.coffee","meteor://💻app/server/steedos/startup/migrations/v2.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v3.coffee","meteor://💻app/server/steedos/startup/migrations/v3.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v4.coffee","meteor://💻app/server/steedos/startup/migrations/v4.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v5.coffee","meteor://💻app/server/steedos/startup/migrations/v5.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v6.coffee","meteor://💻app/server/steedos/startup/migrations/v6.coffee","meteor://💻app/packages/steedos_base/server/startup.coffee","meteor://💻app/server/startup.coffee","meteor://💻app/packages/steedos:base/server/development.js","meteor://💻app/packages/steedos_base/tabular.coffee","meteor://💻app/tabular.coffee"],"names":["checkNpmVersions","module","link","v","Array","prototype","sortByName","locale","Steedos","sort","p1","p2","p1_sort_no","sort_no","p2_sort_no","name","localeCompare","getProperty","k","forEach","t","m","push","remove","from","to","rest","slice","length","apply","filterProperty","h","l","g","d","includes","Object","undefined","findPropertyByPK","r","Cookies","crypto","mixin","ref","ref1","ref2","ref3","ref4","rootUrl","settings","db","subs","isPhoneEnabled","Meteor","phone","numberToString","number","scale","notThousands","reg","toString","Number","toFixed","match","replace","numberToPercentString","newNumber","valiJquerySymbols","str","RegExp","test","authRequest","url","options","authToken","authorization","defOptions","err","headers","result","spaceId","userSession","Creator","USER_CONTEXT","user","absoluteUrl","value","type","dataType","contentType","beforeSend","XHR","header","setRequestHeader","success","data","error","XMLHttpRequest","textStatus","errorThrown","errorInfo","errorMsg","console","responseJSON","reason","message","toastr","$","ajax","assign","error1","isCordova","isClient","defaultOptions","endsWith","substr","window","stores","API","client","setUrl","Settings","setRootUrl","startup","ref5","ref6","ref7","ref8","setHrefPopup","ui","href_popup","getHelpUrl","country","substring","isExpression","func","pattern","reg1","reg2","parseSingleExpression","formData","dataPath","global","funcBody","getParentPath","getValueByPath","globalTag","parent","parentPath","path","pathArr","split","pop","join","_","get","JSON","stringify","Function","log","spaceUpgradedModal","swal","title","TAPi18n","__","text","html","confirmButtonText","getAccountBgBodyValue","accountBgBody","steedos_keyvalues","findOne","userId","key","applyAccountBgBodyValue","accountBgBodyValue","isNeedToLocal","avatar","loggingIn","localStorage","getItem","setItem","removeItem","getAccountSkinValue","accountSkin","getAccountZoomValue","accountZoom","applyAccountZoomValue","accountZoomValue","showHelp","getLocale","open","getUrlWithToken","linker","getSpaceId","Accounts","_storedLoginToken","indexOf","param","getAppUrlWithToken","app_id","openAppWithToken","app","apps","is_new_window","isMobile","location","openWindow","openUrlWithIE","cmd","exec","open_url","isNode","nw","require","stdout","stderr","openApp","e","evalFunString","on_click","redirectToSignIn","FlowRouter","go","is_use_ie","origin","isInternalApp","is_use_iframe","_id","eval","stack","Session","set","checkSpaceBalance","end_date","min_months","space","isSpaceAdmin","spaces","Date","setModalMaxHeight","offset","detectIE","each","footerHeight","headerHeight","height","totalHeight","outerHeight","innerHeight","hasClass","css","getModalMaxHeight","reValue","screen","isiOS","userAgent","language","DEVICE","browser","conExp","device","numExp","android","blackberry","desktop","ipad","iphone","ipod","mobile","navigator","toLowerCase","browserLanguage","getUserOrganizations","isIncludeParents","organizations","parents","space_user","space_users","fields","flatten","find","$in","fetch","union","forbidNodeContextmenu","target","ifr","document","body","addEventListener","ev","preventDefault","load","ifrBody","contents","isServer","admins","isLegalVersion","app_version","check","modules","isOrgAdminByOrgIds","orgIds","allowAccessOrgs","isOrgAdmin","useOrgs","filter","org","uniq","isOrgAdminByAllOrgIds","i","root_url","URL","pathname","getAPILoginUser","req","res","cookies","password","username","query","users","steedos_id","_checkPassword","Error","checkAuthToken","hashedToken","_hashLoginToken","decrypt","iv","c","decipher","decipherMsg","key32","len","createDecipheriv","Buffer","concat","update","final","encrypt","cipher","cipheredMsg","createCipheriv","getUserIdFromAccessToken","access_token","collection","obj","oAuth2Server","collections","accessToken","expires","getUserIdFromAuthToken","APIAuthenticationCheck","JsonRoutes","sendResult","code","functions","args","_wrapped","arguments","call","isHoliday","date","day","getDay","caculateWorkingTime","days","caculateDate","param_date","getTime","caculatePlusHalfWorkingDay","next","caculated_date","first_date","j","max_index","second_date","start_date","time_points","remind","isEmpty","setHours","hour","setMinutes","minute","extend","getSteedosToken","appId","now","secret","steedos_token","parseInt","isI18n","checkUsernameAvailability","$regex","_escapeRegExp","trim","validatePassword","pwd","passworPolicy","passworPolicyError","ref10","ref9","valid","policy","policyError","policyerror","convertSpecialCharacter","removeSpecialCharacter","getDBApps","space_id","dbApps","Collections","is_creator","visible","created","created_by","modified","modified_by","getDBDashboards","dbDashboards","dashboard","getAuthToken","autorun","sessionStorage","getCurrentAppId","formatIndex","array","indexName","isdocumentDB","object","background","datasources","documentDB","SimpleSchema","extendOptions","foreign_key","Match","Optional","Boolean","references","methods","updateUserLastLogon","$set","last_logon","onLogin","users_add_email","email","count","emails","direct","$push","address","verified","sendVerificationEmail","users_remove_email","p","$pull","users_verify_email","users_set_primary_email","primary","multi","showCancelButton","closeOnConfirm","animation","inputValue","updateUserAvatar","emailTemplates","defaultFrom","resetPassword","subject","splits","tokenCode","greeting","profile","token_code","verifyEmail","enrollAccount","add","orgs","fullname","$ne","calculateFullname","ret","msg","Push","Configure","senderID","ANDROID_SENDER_ID","sound","vibrate","ios","badge","clearBadge","alert","appName","Selector","selectorCheckSpaceAdmin","selector","is_cloudadmin","map","n","selectorCheckSpace","u","billing_pay_records","adminConfig","icon","color","tableColumns","extraFields","routerAdmin","paid","showEditColumn","showDelColumn","disableAdd","pageLength","order","space_user_signs","AdminConfig","collections_add","searchElement","O","currentElement","webservices","www","status","getUserObjectsListViews","objects","_getUserObjectListViews","keys","listViews","objectsViews","getCollection","object_name","owner","shared","_user_object_list_views","olistViews","ov","listview","o","list_view","getUserObjectListViews","object_listview","user_id","uuflowManager","getSpace","$or","$exists","errors","errorMessage","steedosAuth","allow_models","model","String","wrapAsync","cb","getSession","then","resolve","reject","express","des_cipher","des_cipheredMsg","des_iv","des_steedos_token","joiner","key8","redirectUrl","returnurl","params","writeHead","end","encodeURI","setHeader","color_index","colors","fontSize","initials","position","reqModifiedHeader","svg","username_array","width","w","fs","getRelativeUrl","avatarUrl","file","write","item","charCodeAt","toUpperCase","toUTCString","readStream","pipe","publish","ready","handle","handle2","observeSpaces","self","sus","userSpaces","user_accepted","su","observe","added","doc","removed","oldDoc","without","stop","changed","newDoc","onStop","enable_register","get_contacts_limit","froms","fromsChildren","fromsChildrenIds","isLimit","len1","limit","limits","myLitmitOrgIds","myOrgId","myOrgIds","myOrgs","outside_organizations","setting","tempIsLimit","toOrgs","tos","space_settings","values","intersection","setKeyValue","insert","setUsername","spaceUser","invite_state","get_space_user_count","user_count_info","total_user_count","accepted_user_count","create_secret","remove_secret","token","curSpaceUser","ows","flow_id","sync_direction","fl","perms","state","forbid_initiate_instance","flow_name","can_add","users_can_add","orgs_can_add","some","billingManager","get_accounting_period","accounting_month","billing","count_days","end_date_time","start_date_time","moment","format","billings","transaction","billing_date","getDate","refresh_balance","refresh_date","app_bill","b_m","b_m_d","bill","credits","debits","last_balance","last_bill","payment_bill","setObj","$lt","billing_month","balance","get_balance","user_count","module_name","listprice","accounting_date","accounting_date_format","days_number","new_bill","$lte","_makeNewID","getSpaceUserCount","recaculateBalance","refresh_dates","r_d","get_modules","m_changelog","modules_changelogs","change_date","operation","get_modules_name","modules_name","caculate_by_accounting_month","a_m","newest_bill","period_result","remaining_months","b","special_pay","module_names","total_fee","operator_id","new_modules","space_update_obj","difference","_d","is_paid","user_limit","mcl","operator","cron","statistics","schedule","rule","go_next","scheduleJob","bindEnvironment","time","dateFormat","datekey","getFullYear","getMonth","yesterDay","dNow","dBefore","dailyStaticsCount","statics","$gt","staticsCount","ownerName","lastLogon","sUsers","sUser","lastModified","objArr","mod","postsAttachments","attSize","sizeSum","posts","post","atts","cfs","att","original","size","dailyPostsAttachments","steedos_statistics","space_name","owner_name","steedos","workflow","flows","forms","flow_roles","flow_positions","instances","instances_last_modified","daily_flows","daily_forms","daily_instances","cms","sites","cms_sites","cms_posts","posts_last_modified","posts_attachments_size","comments","cms_comments","daily_sites","daily_posts","daily_comments","daily_posts_attachments_size","timeEnd","Migrations","version","up","update_cfs_instance","parent_id","instance_id","attach_version","isCurrent","metadata","instance","approve","current","attachments","ins","attachs","current_ver","_rev","historys","his","down","organization","check_count","new_org_ids","removed_org_ids","root_org","updateUsers","s","listprices","months","set_obj","pm","setMonth","rootURL","creator","process","env","CREATOR_NODE_ENV","defineProperty","depth","reduce","flat","toFlatten","isArray","Tabular","Table","columns","orderable","dom","lengthChange","ordering","info","searching","autoWidth","changeSelector","$and"],"mappings":"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","file":"/packages/steedos_base.js","sourcesContent":["import {\n\tcheckNpmVersions\n} from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\t\"node-schedule\": \"^1.3.1\",\n\t\"xml2js\": \"^0.4.19\",\n}, 'steedos:base');\n","Array.prototype.sortByName = function (locale) {\n    if (!this) {\n        return;\n    }\n    if(!locale){\n        locale = Steedos.locale()\n    }\n    this.sort(function (p1, p2) {\n\t\tvar p1_sort_no = p1.sort_no || 0;\n\t\tvar p2_sort_no = p2.sort_no || 0;\n\t\tif(p1_sort_no != p2_sort_no){\n            return p1_sort_no > p2_sort_no ? -1 : 1\n        }else{\n\t\t\treturn p1.name.localeCompare(p2.name, locale);\n\t\t}\n    });\n};\n\n\nArray.prototype.getProperty = function (k) {\n    var v = new Array();\n    this.forEach(function (t) {\n        var m = t ? t[k] : null;\n        v.push(m);\n    });\n    return v;\n}\n\n/*\n * 添加Array的remove函数\n */\nArray.prototype.remove = function (from, to) {\n    if (from < 0) {\n        return;\n    }\n    var rest = this.slice((to || from) + 1 || this.length);\n    this.length = from < 0 ? this.length + from : from;\n    return this.push.apply(this, rest);\n};\n\n/*\n * 添加Array的过滤器\n * return 符合条件的对象Array\n */\nArray.prototype.filterProperty = function (h, l) {\n    var g = [];\n    this.forEach(function (t) {\n        var m = t ? t[h] : null;\n        var d = false;\n        if (m instanceof Array) {\n            d = m.includes(l);\n        } else {\n            if (m instanceof Object) {\n                if (\"id\" in m) {\n                    m = m[\"id\"];\n                } else if (\"_id\" in m) {\n                    m = m[\"_id\"];\n                }\n\n            }\n            if (l instanceof Array) {\n                d = (l === undefined) ? false : l.includes(m);\n            } else {\n                d = (l === undefined) ? false : m == l;\n            }\n        }\n\n        if (d) {\n            g.push(t);\n        }\n    });\n    return g;\n}\n\n/*\n * 添加Array的过滤器\n * return 符合条件的第一个对象\n */\nArray.prototype.findPropertyByPK = function (h, l) {\n    var r = null;\n    this.forEach(function (t) {\n        var m = t ? t[h] : null;\n        var d = false;\n        if (m instanceof Array) {\n            d = m.includes(l);\n        } else {\n            d = (l === undefined) ? false : m == l;\n        }\n\n        if (d) {\n            r = t;\n        }\n    });\n    return r;\n}","Steedos =\n\tsettings: {}\n\tdb: db\n\tsubs: {}\n\tisPhoneEnabled: ->\n\t\treturn !!Meteor.settings?.public?.phone\n\tnumberToString: (number, scale, notThousands)->\n\t\tif typeof number == \"number\"\n\t\t\tnumber = number.toString()\n\n\t\tif !number\n\t\t\treturn '';\n\n\t\tif number != \"NaN\"\n\t\t\tif scale || scale == 0\n\t\t\t\tnumber = Number(number).toFixed(scale)\n\t\t\tunless notThousands\n\t\t\t\tif !(scale || scale == 0)\n\t\t\t\t\t# 没定义scale时，根据小数点位置算出scale值\n\t\t\t\t\tscale = number.match(/\\.(\\d+)/)?[1]?.length\n\t\t\t\t\tunless scale\n\t\t\t\t\t\tscale = 0\n\t\t\t\treg = /(\\d)(?=(\\d{3})+\\.)/g\n\t\t\t\tif scale == 0\n\t\t\t\t\treg = /(\\d)(?=(\\d{3})+\\b)/g\n\t\t\t\tnumber = number.replace(reg, '$1,')\n\t\t\treturn number\n\t\telse\n\t\t\treturn \"\"\n\tnumberToPercentString: (number, scale, notThousands) ->\n\t\tnewNumber = Number (number * 100).toFixed(scale)\n\t\treturn Steedos.numberToString(newNumber, scale, notThousands) + \"%\"\n\tvaliJquerySymbols: (str)->\n\t\t# reg = /^[^!\"#$%&'()*+,./:;<=>?@[\\]^`{|}~]+$/g\n\t\treg = new RegExp(\"^[^!\\\"#$%&'()*\\+,\\.\\/:;<=>?@[\\\\]^`{|}~]+$\")\n\t\treturn reg.test(str)\n\tauthRequest: (url, options) ->\n\t\tuserSession = Creator.USER_CONTEXT\n\t\tspaceId = userSession.spaceId\n\t\tauthToken = if userSession.authToken then userSession.authToken else userSession.user.authToken\n\t\tresult = null\n\t\turl = Steedos.absoluteUrl(url)\n\t\ttry\n\t\t\tauthorization = 'Bearer ' + spaceId + ',' + authToken\n\t\t\theaders = [\n\t\t\t\t{\n\t\t\t\t\tname: 'Content-Type'\n\t\t\t\t\tvalue: 'application/json'\n\t\t\t\t}\n\t\t\t\t{\n\t\t\t\t\tname: 'Authorization'\n\t\t\t\t\tvalue: authorization\n\t\t\t\t}\n\t\t\t]\n\t\t\tdefOptions = \n\t\t\ttype: 'get'\n\t\t\turl: url\n\t\t\tdataType: 'json'\n\t\t\tcontentType: 'application/json'\n\t\t\tbeforeSend: (XHR) ->\n\t\t\t\tif headers and headers.length\n\t\t\t\t\treturn headers.forEach((header) ->\n\t\t\t\t\t\tXHR.setRequestHeader header.name, header.value\n\t\t\t\t\t)\n\t\t\t\treturn\n\t\t\tsuccess: (data) ->\n\t\t\t\tresult = data\n\t\t\t\treturn\n\t\t\terror: (XMLHttpRequest, textStatus, errorThrown) ->\n\t\t\t\tconsole.error XMLHttpRequest.responseJSON\n\t\t\t\tif XMLHttpRequest.responseJSON and XMLHttpRequest.responseJSON.error\n\t\t\t\t\terrorInfo = XMLHttpRequest.responseJSON.error\n\t\t\t\t\tresult = error: errorInfo\n\t\t\t\t\terrorMsg = undefined\n\t\t\t\t\tif errorInfo.reason\n\t\t\t\t\t\terrorMsg = errorInfo.reason\n\t\t\t\t\telse if errorInfo.message\n\t\t\t\t\t\terrorMsg = errorInfo.message\n\t\t\t\t\telse\n\t\t\t\t\t\terrorMsg = errorInfo\n\t\t\t\t\t\ttoastr.error t(errorMsg.replace(/:/g, '：'))\n\t\t\t\telse\n\t\t\t\t\ttoastr.error XMLHttpRequest.responseJSON\n\t\t\t\treturn\n\t\t\t$.ajax Object.assign({}, defOptions, options)\n\t\t\treturn result\n\t\tcatch err\n\t\t\tconsole.error err\n\t\t\ttoastr.error err\n\t\treturn\n\n###\n# Kick off the global namespace for Steedos.\n# @namespace Steedos\n###\n# if Meteor.isCordova\nif Meteor.isCordova || Meteor.isClient\n\trootUrl = Meteor.absoluteUrl.defaultOptions.rootUrl\n\tif rootUrl.endsWith('/')\n\t\trootUrl = rootUrl.substr(0, rootUrl.length - 1)\n\n\twindow.stores?.API?.client?.setUrl(rootUrl)\n\twindow.stores?.Settings?.setRootUrl(rootUrl)\n\twindow['steedos.setting'] = {\n\t\trootUrl: rootUrl\n\t}\n\nif !Meteor.isCordova && Meteor.isClient\n\t# 配置是否新窗口打开的全局变量\n\tMeteor.startup ()->\n\t\twindow.stores?.Settings?.setHrefPopup(Meteor.settings.public?.ui?.href_popup)\n\n# if Meteor.isClient\n\t# Meteor.autorun ()->\n\t# \twindow.stores?.Settings?.setUserId(Steedos.userId())\n\t# \twindow.stores?.Settings?.setTenantId(Steedos.spaceId())\n\nSteedos.getHelpUrl = (locale)->\n\tcountry = locale.substring(3)\n\treturn \"http://www.steedos.com/\" + country + \"/help/\"\n\nSteedos.isExpression = (func) ->\n\tif typeof func != 'string'\n\t\treturn false\n\tpattern = /^{{(.+)}}$/\n\treg1 = /^{{(function.+)}}$/\n\treg2 = /^{{(.+=>.+)}}$/\n\tif typeof func == 'string' and func.match(pattern) and !func.match(reg1) and !func.match(reg2)\n\t\treturn true\n\tfalse\n\nSteedos.parseSingleExpression = (func, formData, dataPath, global) ->\n\tgetParentPath = (path) ->\n\t\tif typeof path == 'string'\n\t\t\tpathArr = path.split('.')\n\t\t\tif pathArr.length == 1\n\t\t\t\treturn '#'\n\t\t\tpathArr.pop()\n\t\t\treturn pathArr.join('.')\n\t\treturn '#'\n\tgetValueByPath = (formData, path) ->\n\t\tif path == '#' or !path\n\t\t\treturn formData or {}\n\t\telse if typeof path == 'string'\n\t\t\treturn _.get(formData, path)\n\t\telse\n\t\t\tconsole.error 'path has to be a string'\n\t\treturn\n\tif formData == undefined\n\t\tformData = {}\n\tparentPath = getParentPath(dataPath)\n\tparent = getValueByPath(formData, parentPath) or {}\n\tif typeof func == 'string'\n\t\tfuncBody = func.substring(2, func.length - 2)\n\t\tglobalTag = '__G_L_O_B_A_L__'\n\t\tstr = '\\n    return ' + funcBody.replace(/\\bformData\\b/g, JSON.stringify(formData).replace(/\\bglobal\\b/g, globalTag)).replace(/\\bglobal\\b/g, JSON.stringify(global)).replace(new RegExp('\\\\b' + globalTag + '\\\\b', 'g'), 'global').replace(/rootValue/g, JSON.stringify(parent))\n\t\ttry\n\t\t\treturn Function(str)()\n\t\tcatch error\n\t\t\tconsole.log error, func, dataPath\n\t\t\treturn func\n\telse\n\t\treturn func\n\treturn\n\nif Meteor.isClient\n\n\tSteedos.spaceUpgradedModal = ()->\n\t\tswal({title: TAPi18n.__(\"space_paid_info_title\"), text: TAPi18n.__(\"space_paid_info_text\"), html: true, type:\"warning\", confirmButtonText: TAPi18n.__(\"OK\")});\n\n\tSteedos.getAccountBgBodyValue = ()->\n\t\taccountBgBody = db.steedos_keyvalues.findOne({user:Steedos.userId(),key:\"bg_body\"})\n\t\tif accountBgBody\n\t\t\treturn accountBgBody.value\n\t\telse\n\t\t\treturn {};\n\n\tSteedos.applyAccountBgBodyValue = (accountBgBodyValue,isNeedToLocal)->\n\t\tif Meteor.loggingIn() or !Steedos.userId()\n\t\t\t# 如果是正在登录中或在登录界面，则取localStorage中设置，而不是直接应用空设置\n\t\t\taccountBgBodyValue = {}\n\t\t\taccountBgBodyValue.url = localStorage.getItem(\"accountBgBodyValue.url\")\n\t\t\taccountBgBodyValue.avatar = localStorage.getItem(\"accountBgBodyValue.avatar\")\n\n\t\turl = accountBgBodyValue.url\n\t\tavatar = accountBgBodyValue.avatar\n\t\t# if accountBgBodyValue.url\n\t\t# \tif url == avatar\n\t\t# \t\tavatarUrl = 'api/files/avatars/' + avatar\n\t\t# \t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(avatarUrl)})\"\n\t\t# \telse\n\t\t# \t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(url)})\"\n\t\t# else\n\t\t# \tbackground = Meteor.settings?.public?.admin?.background\n\t\t# \tif background\n\t\t# \t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(background)})\"\n\t\t# \telse\n\t\t# \t\tbackground = \"/packages/steedos_theme/client/background/sea.jpg\"\n\t\t# \t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(background)})\"\n\n\t\tif isNeedToLocal\n\t\t\tif Meteor.loggingIn()\n\t\t\t\t# 正在登录中，则不做处理，因为此时Steedos.userId()不足于证明已登录状态\n\t\t\t\treturn\n\t\t\t# 这里特意不在localStorage中存储Steedos.userId()，因为需要保证登录界面也应用localStorage中的设置\n\t\t\t# 登录界面不设置localStorage，因为登录界面accountBgBodyValue肯定为空，设置的话，会造成无法保持登录界面也应用localStorage中的设置\n\t\t\tif Steedos.userId()\n\t\t\t\tif url\n\t\t\t\t\tlocalStorage.setItem(\"accountBgBodyValue.url\",url)\n\t\t\t\t\tlocalStorage.setItem(\"accountBgBodyValue.avatar\",avatar)\n\t\t\t\telse\n\t\t\t\t\tlocalStorage.removeItem(\"accountBgBodyValue.url\")\n\t\t\t\t\tlocalStorage.removeItem(\"accountBgBodyValue.avatar\")\n\n\tSteedos.getAccountSkinValue = ()->\n\t\taccountSkin = db.steedos_keyvalues.findOne({user:Steedos.userId(),key:\"skin\"})\n\t\tif accountSkin\n\t\t\treturn accountSkin.value\n\t\telse\n\t\t\treturn {};\n\n\tSteedos.getAccountZoomValue = ()->\n\t\taccountZoom = db.steedos_keyvalues.findOne({user:Steedos.userId(),key:\"zoom\"})\n\t\tif accountZoom\n\t\t\treturn accountZoom.value\n\t\telse\n\t\t\treturn {};\n\n\tSteedos.applyAccountZoomValue = (accountZoomValue,isNeedToLocal)->\n\t\t# if Meteor.loggingIn() or !Steedos.userId()\n\t\t# \t# 如果是正在登录中或在登录界面，则取localStorage中设置，而不是直接应用空设置\n\t\t# \taccountZoomValue = {}\n\t\t# \taccountZoomValue.name = localStorage.getItem(\"accountZoomValue.name\")\n\t\t# \taccountZoomValue.size = localStorage.getItem(\"accountZoomValue.size\")\n\t\t# $(\"body\").removeClass(\"zoom-normal\").removeClass(\"zoom-large\").removeClass(\"zoom-extra-large\");\n\t\t# zoomName = accountZoomValue.name\n\t\t# zoomSize = accountZoomValue.size\n\t\t# unless zoomName\n\t\t# \tzoomName = \"large\"\n\t\t# \tzoomSize = 1.2\n\t\t# if zoomName && !Session.get(\"instancePrint\")\n\t\t# \t$(\"body\").addClass(\"zoom-#{zoomName}\")\n\t\t# \t# if Steedos.isNode()\n\t\t# \t# \tif accountZoomValue.size == \"1\"\n\t\t# \t# \t\t# node-webkit中size为0才表示100%\n\t\t# \t# \t\tzoomSize = 0\n\t\t# \t# \tnw.Window.get().zoomLevel = Number.parseFloat(zoomSize)\n\t\t# \t# else\n\t\t# \t# \t$(\"body\").addClass(\"zoom-#{zoomName}\")\n\t\t# if isNeedToLocal\n\t\t# \tif Meteor.loggingIn()\n\t\t# \t\t# 正在登录中，则不做处理，因为此时Steedos.userId()不足于证明已登录状态\n\t\t# \t\treturn\n\t\t# \t# 这里特意不在localStorage中存储Steedos.userId()，因为需要保证登录界面也应用localStorage中的设置\n\t\t# \t# 登录界面不设置localStorage，因为登录界面accountZoomValue肯定为空，设置的话，会造成无法保持登录界面也应用localStorage中的设置\n\t\t# \tif Steedos.userId()\n\t\t# \t\tif accountZoomValue.name\n\t\t# \t\t\tlocalStorage.setItem(\"accountZoomValue.name\",accountZoomValue.name)\n\t\t# \t\t\tlocalStorage.setItem(\"accountZoomValue.size\",accountZoomValue.size)\n\t\t# \t\telse\n\t\t# \t\t\tlocalStorage.removeItem(\"accountZoomValue.name\")\n\t\t# \t\t\tlocalStorage.removeItem(\"accountZoomValue.size\")\n\n\tSteedos.showHelp = (url)->\n\t\tlocale = Steedos.getLocale()\n\t\tcountry = locale.substring(3)\n\n\t\turl = url || \"http://www.steedos.com/\" + country + \"/help/\"\n\n\t\twindow.open(url, '_help', 'EnableViewPortScale=yes')\n\n\tSteedos.getUrlWithToken = (url)->\n\t\tauthToken = {};\n\t\tauthToken[\"spaceId\"] = Steedos.getSpaceId()\n\t\tauthToken[\"X-User-Id\"] = Meteor.userId();\n\t\tauthToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\n\n\t\tlinker = \"?\"\n\n\t\tif url.indexOf(\"?\") > -1\n\t\t\tlinker = \"&\"\n\n\t\treturn url + linker + $.param(authToken)\n\n\tSteedos.getAppUrlWithToken = (app_id)->\n\t\tauthToken = {};\n\t\tauthToken[\"spaceId\"] = Steedos.getSpaceId()\n\t\tauthToken[\"X-User-Id\"] = Meteor.userId();\n\t\tauthToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\n\t\treturn \"api/setup/sso/\" + app_id + \"?\" + $.param(authToken)\n\n\tSteedos.openAppWithToken = (app_id)->\n\t\turl = Steedos.getAppUrlWithToken app_id\n\t\turl = Steedos.absoluteUrl url\n\n\t\tapp = db.apps.findOne(app_id)\n\n\t\tif !app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()\n\t\t\twindow.location = url\n\t\telse\n\t\t\tSteedos.openWindow(url);\n\n\tSteedos.openUrlWithIE = (url)->\n\t\tif url\n\t\t\tif Steedos.isNode()\n\t\t\t\texec = nw.require('child_process').exec\n\t\t\t\topen_url = url\n\t\t\t\tcmd = \"start iexplore.exe \\\"#{open_url}\\\"\"\n\t\t\t\texec cmd, (error, stdout, stderr) ->\n\t\t\t\t\tif error\n\t\t\t\t\t\ttoastr.error error\n\t\t\t\t\treturn\n\t\t\telse\n\t\t\t\tSteedos.openWindow(url)\n\n\n\tSteedos.openApp = (app_id)->\n\t\tif !Meteor.userId()\n\t\t\tSteedos.redirectToSignIn()\n\t\t\treturn true\n\n\t\tapp = db.apps.findOne(app_id)\n\t\tif !app\n\t\t\tFlowRouter.go(\"/\")\n\t\t\treturn\n\n\t\t# creatorSettings = Meteor.settings.public?.webservices?.creator\n\t\t# if app._id == \"admin\" and creatorSettings?.status == \"active\"\n\t\t# \turl = creatorSettings.url\n\t\t# \treg = /\\/$/\n\t\t# \tunless reg.test url\n\t\t# \t\turl += \"/\"\n\t\t# \turl = \"#{url}app/admin\"\n\t\t# \tSteedos.openWindow(url)\n\t\t# \treturn\n\n\t\ton_click = app.on_click\n\t\tif app.is_use_ie\n\t\t\tif Steedos.isNode()\n\t\t\t\texec = nw.require('child_process').exec\n\t\t\t\tif on_click\n\t\t\t\t\tpath = \"api/app/sso/#{app_id}?authToken=#{Accounts._storedLoginToken()}&userId=#{Meteor.userId()}\"\n\t\t\t\t\topen_url = window.location.origin + \"/\" + path\n\t\t\t\telse\n\t\t\t\t\topen_url = Steedos.getAppUrlWithToken app_id\n\t\t\t\t\topen_url = window.location.origin + \"/\" + open_url\n\t\t\t\tcmd = \"start iexplore.exe \\\"#{open_url}\\\"\"\n\t\t\t\texec cmd, (error, stdout, stderr) ->\n\t\t\t\t\tif error\n\t\t\t\t\t\ttoastr.error error\n\t\t\t\t\treturn\n\t\t\telse\n\t\t\t\tSteedos.openAppWithToken(app_id)\n\n\t\telse if db.apps.isInternalApp(app.url)\n\t\t\tFlowRouter.go(app.url)\n\n\t\telse if app.is_use_iframe\n\t\t\tif app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()\n\t\t\t\tSteedos.openWindow(Steedos.absoluteUrl(\"apps/iframe/\" + app._id))\n\t\t\telse if Steedos.isMobile() || Steedos.isCordova()\n\t\t\t\tSteedos.openAppWithToken(app_id)\n\t\t\telse\n\t\t\t\tFlowRouter.go(\"/apps/iframe/#{app._id}\")\n\n\t\telse if on_click\n\t\t\t# 这里执行的是一个不带参数的闭包函数，用来避免变量污染\n\t\t\tevalFunString = \"(function(){#{on_click}})()\"\n\t\t\ttry\n\t\t\t\teval(evalFunString)\n\t\t\tcatch e\n\t\t\t\t# just console the error when catch error\n\t\t\t\tconsole.error \"catch some error when eval the on_click script for app link:\"\n\t\t\t\tconsole.error \"#{e.message}\\r\\n#{e.stack}\"\n\t\telse\n\t\t\tSteedos.openAppWithToken(app_id)\n\n\t\tif !app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova() && !app.is_use_ie && !on_click\n\t\t\t# 需要选中当前app时，on_click函数里要单独加上Session.set(\"current_app_id\", app_id)\n\t\t\tSession.set(\"current_app_id\", app_id)\n\n\tSteedos.checkSpaceBalance = (spaceId)->\n\t\tunless spaceId\n\t\t\tspaceId = Steedos.spaceId()\n\t\tmin_months = 1\n\t\tif Steedos.isSpaceAdmin()\n\t\t\tmin_months = 3\n\t\tspace = db.spaces.findOne(spaceId)\n\t\tend_date = space?.end_date\n\t\tif space && end_date != undefined and (end_date - new Date) <= (min_months*30*24*3600*1000)\n\t\t\t# 提示用户余额不足\n\t\t\ttoastr.error t(\"space_balance_insufficient\")\n\n\tSteedos.setModalMaxHeight = ()->\n\t\taccountZoomValue = Steedos.getAccountZoomValue()\n\t\tunless accountZoomValue.name\n\t\t\taccountZoomValue.name = 'large'\n\t\tswitch accountZoomValue.name\n\t\t\twhen 'normal'\n\t\t\t\tif Steedos.isMobile()\n\t\t\t\t\toffset = -12\n\t\t\t\telse\n\t\t\t\t\toffset = 75\n\t\t\twhen 'large'\n\t\t\t\tif Steedos.isMobile()\n\t\t\t\t\toffset = -6\n\t\t\t\telse\n\t\t\t\t\t# 区分IE浏览器\n\t\t\t\t\tif Steedos.detectIE()\n\t\t\t\t\t\toffset = 199\n\t\t\t\t\telse\n\t\t\t\t\t\toffset = 9\n\t\t\twhen 'extra-large'\n\t\t\t\tif Steedos.isMobile()\n\t\t\t\t\toffset = -26\n\t\t\t\telse\n\t\t\t\t\t# 区分IE浏览器\n\t\t\t\t\tif Steedos.detectIE()\n\t\t\t\t\t\toffset = 303\n\t\t\t\t\telse\n\t\t\t\t\t\toffset = 53\n\n\t\tif $(\".modal\").length\n\t\t\t$(\".modal\").each ->\n\t\t\t\theaderHeight = 0\n\t\t\t\tfooterHeight = 0\n\t\t\t\ttotalHeight = 0\n\t\t\t\t$(\".modal-header\", $(this)).each ->\n\t\t\t\t\theaderHeight += $(this).outerHeight(false)\n\t\t\t\t$(\".modal-footer\", $(this)).each ->\n\t\t\t\t\tfooterHeight += $(this).outerHeight(false)\n\n\t\t\t\ttotalHeight = headerHeight + footerHeight\n\t\t\t\theight = $(\"body\").innerHeight() - totalHeight - offset\n\t\t\t\tif $(this).hasClass(\"cf_contact_modal\")\n\t\t\t\t\t$(\".modal-body\",$(this)).css({\"max-height\": \"#{height}px\", \"height\": \"#{height}px\"})\n\t\t\t\telse\n\t\t\t\t\t$(\".modal-body\",$(this)).css({\"max-height\": \"#{height}px\", \"height\": \"auto\"})\n\n\tSteedos.getModalMaxHeight = (offset)->\n\t\tif Steedos.isMobile()\n\t\t\treValue = window.screen.height - 126 - 180 - 25\n\t\telse\n\t\t\treValue = $(window).height() - 180 - 25\n\t\tunless Steedos.isiOS() or Steedos.isMobile()\n\t\t\t# ios及手机上不需要为zoom放大功能额外计算\n\t\t\taccountZoomValue = Steedos.getAccountZoomValue()\n\t\t\tswitch accountZoomValue.name\n\t\t\t\twhen 'large'\n\t\t\t\t\t# 测下来这里不需要额外减数\n\t\t\t\t\treValue -= 50\n\t\t\t\twhen 'extra-large'\n\t\t\t\t\treValue -= 145\n\t\tif offset\n\t\t\treValue -= offset\n\t\treturn reValue + \"px\";\n\n\tSteedos.isiOS = (userAgent, language)->\n\t\tDEVICE =\n\t\t\tandroid: 'android'\n\t\t\tblackberry: 'blackberry'\n\t\t\tdesktop: 'desktop'\n\t\t\tipad: 'ipad'\n\t\t\tiphone: 'iphone'\n\t\t\tipod: 'ipod'\n\t\t\tmobile: 'mobile'\n\t\tbrowser = {}\n\t\tconExp = '(?:[\\\\/:\\\\::\\\\s:;])'\n\t\tnumExp = '(\\\\S+[^\\\\s:;:\\\\)]|)'\n\t\tuserAgent = (userAgent or navigator.userAgent).toLowerCase()\n\t\tlanguage = language or navigator.language or navigator.browserLanguage\n\t\tdevice = userAgent.match(new RegExp('(android|ipad|iphone|ipod|blackberry)')) or userAgent.match(new RegExp('(mobile)')) or [\n\t\t\t''\n\t\t\tDEVICE.desktop\n\t\t]\n\t\tbrowser.device = device[1]\n\t\treturn browser.device == DEVICE.ipad or browser.device == DEVICE.iphone or browser.device == DEVICE.ipod\n\n\tSteedos.getUserOrganizations = (isIncludeParents)->\n\t\tuserId = Meteor.userId()\n\t\tspaceId = Steedos.spaceId()\n\t\tspace_user = db.space_users.findOne({user:userId,space:spaceId},fields:{organizations:1})\n\t\torganizations = space_user?.organizations\n\t\tunless organizations\n\t\t\treturn []\n\t\tif isIncludeParents\n\t\t\tparents = _.flatten db.organizations.find(_id:{$in:organizations}).fetch().getProperty(\"parents\")\n\t\t\treturn _.union organizations,parents\n\t\telse\n\t\t\treturn organizations\n\n\tSteedos.forbidNodeContextmenu = (target, ifr)->\n\t\tunless Steedos.isNode()\n\t\t\treturn\n\t\ttarget.document.body.addEventListener 'contextmenu', (ev) ->\n\t\t\tev.preventDefault()\n\t\t\treturn false\n\t\tif ifr\n\t\t\tif typeof ifr == 'string'\n\t\t\t\tifr = target.$(ifr)\n\t\t\tifr.load ->\n\t\t\t\tifrBody = ifr.contents().find('body')\n\t\t\t\tif ifrBody\n\t\t\t\t\tifrBody[0].addEventListener 'contextmenu', (ev) ->\n\t\t\t\t\t\tev.preventDefault()\n\t\t\t\t\t\treturn false\n\nif Meteor.isServer\n\tSteedos.getUserOrganizations = (spaceId,userId,isIncludeParents)->\n\t\tspace_user = db.space_users.findOne({user:userId,space:spaceId},fields:{organizations:1})\n\t\torganizations = space_user?.organizations\n\t\tunless organizations\n\t\t\treturn []\n\t\tif isIncludeParents\n\t\t\tparents = _.flatten db.organizations.find(_id:{$in:organizations}).fetch().getProperty(\"parents\")\n\t\t\treturn _.union organizations,parents\n\t\telse\n\t\t\treturn organizations\n\n#\tSteedos.chargeAPIcheck = (spaceId)->\n\nif Meteor.isServer\n\tCookies = require(\"cookies\")\n\t#TODO 添加服务端是否手机的判断(依据request)\n\tSteedos.isMobile = ()->\n\t\treturn false;\n\n\tSteedos.isSpaceAdmin = (spaceId, userId)->\n\t\tif !spaceId || !userId\n\t\t\treturn false\n\t\tspace = db.spaces.findOne(spaceId)\n\t\tif !space || !space.admins\n\t\t\treturn false;\n\t\treturn space.admins.indexOf(userId)>=0\n\n\tSteedos.isLegalVersion = (spaceId,app_version)->\n\t\tif !spaceId\n\t\t\treturn false\n\t\tcheck = false\n\t\tmodules = db.spaces.findOne(spaceId)?.modules\n\t\tif modules and modules.includes(app_version)\n\t\t\tcheck = true\n\t\treturn check\n\n\t# 判断数组orgIds中的org id集合对于用户userId是否有组织管理员权限，只要数组orgIds中任何一个组织有权限就返回true，反之返回false\n\tSteedos.isOrgAdminByOrgIds = (orgIds, userId)->\n\t\tisOrgAdmin = false\n\t\tuseOrgs = db.organizations.find({_id: {$in:orgIds}},{fields:{parents:1,admins:1}}).fetch()\n\t\tparents = []\n\t\tallowAccessOrgs = useOrgs.filter (org) ->\n\t\t\tif org.parents\n\t\t\t\tparents = _.union parents,org.parents\n\t\t\treturn org.admins?.includes(userId)\n\t\tif allowAccessOrgs.length\n\t\t\tisOrgAdmin = true\n\t\telse\n\t\t\tparents = _.flatten parents\n\t\t\tparents = _.uniq parents\n\t\t\tif parents.length and db.organizations.findOne({_id:{$in:parents}, admins:userId})\n\t\t\t\tisOrgAdmin = true\n\t\treturn isOrgAdmin\n\n\n\t# 判断数组orgIds中的org id集合对于用户userId是否有全部组织管理员权限，只有数组orgIds中每个组织都有权限才返回true，反之返回false\n\tSteedos.isOrgAdminByAllOrgIds = (orgIds, userId)->\n\t\tunless orgIds.length\n\t\t\treturn true\n\t\ti = 0\n\t\twhile i < orgIds.length\n\t\t\tisOrgAdmin = Steedos.isOrgAdminByOrgIds [orgIds[i]], userId\n\t\t\tunless isOrgAdmin\n\t\t\t\tbreak\n\t\t\ti++\n\t\treturn isOrgAdmin\n\n\tSteedos.absoluteUrl = (url)->\n\t\tif url\n\t\t\t# url以\"/\"开头的话，去掉开头的\"/\"\n\t\t\turl = url.replace(/^\\//,\"\")\n\t\tif (Meteor.isCordova)\n\t\t\treturn Meteor.absoluteUrl(url);\n\t\telse\n\t\t\tif Meteor.isClient\n\t\t\t\ttry\n\t\t\t\t\troot_url = new URL(Meteor.absoluteUrl())\n\t\t\t\t\tif url\n\t\t\t\t\t\treturn root_url.pathname + url\n\t\t\t\t\telse\n\t\t\t\t\t\treturn root_url.pathname\n\t\t\t\tcatch e\n\t\t\t\t\treturn Meteor.absoluteUrl(url)\n\t\t\telse\n\t\t\t\tMeteor.absoluteUrl(url)\n\n\t#\t通过request.headers、cookie 获得有效用户\n\tSteedos.getAPILoginUser\t= (req, res) ->\n\n\t\tusername = req.query?.username\n\n\t\tpassword = req.query?.password\n\n\t\tif username && password\n\t\t\tuser = db.users.findOne({steedos_id: username})\n\n\t\t\tif !user\n\t\t\t\treturn false\n\n\t\t\tresult = Accounts._checkPassword user, password\n\n\t\t\tif result.error\n\t\t\t\tthrow new Error(result.error)\n\t\t\telse\n\t\t\t\treturn user\n\n\t\tuserId = req.query?[\"X-User-Id\"]\n\n\t\tauthToken = req.query?[\"X-Auth-Token\"]\n\n\t\tif Steedos.checkAuthToken(userId,authToken)\n\t\t\treturn db.users.findOne({_id: userId})\n\n\t\tcookies = new Cookies(req, res);\n\n\t\tif req.headers\n\t\t\tuserId = req.headers[\"x-user-id\"]\n\t\t\tauthToken = req.headers[\"x-auth-token\"]\n\n\t\t# then check cookie\n\t\tif !userId or !authToken\n\t\t\tuserId = cookies.get(\"X-User-Id\")\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\t\tif !userId or !authToken\n\t\t\treturn false\n\n\t\tif Steedos.checkAuthToken(userId, authToken)\n\t\t\treturn db.users.findOne({_id: userId})\n\n\t\treturn false\n\n\t#\t检查userId、authToken是否有效\n\tSteedos.checkAuthToken = (userId, authToken) ->\n\t\tif userId and authToken\n\t\t\thashedToken = Accounts._hashLoginToken(authToken)\n\t\t\tuser = Meteor.users.findOne\n\t\t\t\t_id: userId,\n\t\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\n\t\t\tif user\n\t\t\t\treturn true\n\t\t\telse\n\t\t\t\treturn false\n\t\treturn false\n\n\nif Meteor.isServer\n\tcrypto = require('crypto');\n\tSteedos.decrypt = (password, key, iv)->\n\t\ttry\n\t\t\tkey32 = \"\"\n\t\t\tlen = key.length\n\t\t\tif len < 32\n\t\t\t\tc = \"\"\n\t\t\t\ti = 0\n\t\t\t\tm = 32 - len\n\t\t\t\twhile i < m\n\t\t\t\t\tc = \" \" + c\n\t\t\t\t\ti++\n\t\t\t\tkey32 = key + c\n\t\t\telse if len >= 32\n\t\t\t\tkey32 = key.slice(0, 32)\n\n\t\t\tdecipher = crypto.createDecipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\n\n\t\t\tdecipherMsg = Buffer.concat([decipher.update(password, 'base64'), decipher.final()])\n\n\t\t\tpassword = decipherMsg.toString();\n\t\t\treturn password;\n\t\tcatch e\n\t\t\treturn password;\n\n\tSteedos.encrypt = (password, key, iv)->\n\t\tkey32 = \"\"\n\t\tlen = key.length\n\t\tif len < 32\n\t\t\tc = \"\"\n\t\t\ti = 0\n\t\t\tm = 32 - len\n\t\t\twhile i < m\n\t\t\t\tc = \" \" + c\n\t\t\t\ti++\n\t\t\tkey32 = key + c\n\t\telse if len >= 32\n\t\t\tkey32 = key.slice(0, 32)\n\n\t\tcipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\n\n\t\tcipheredMsg = Buffer.concat([cipher.update(new Buffer(password, 'utf8')), cipher.final()])\n\n\t\tpassword = cipheredMsg.toString('base64')\n\n\t\treturn password;\n\n\tSteedos.getUserIdFromAccessToken = (access_token)->\n\n\t\tif !access_token\n\t\t\treturn null;\n\n\t\tuserId = access_token.split(\"-\")[0]\n\n\t\thashedToken = Accounts._hashLoginToken(access_token)\n\n\t\tuser = db.users.findOne({_id: userId, \"secrets.hashedToken\": hashedToken})\n\n\t\tif user\n\t\t\treturn userId\n\t\telse\n\t\t\t# 如果user表未查到，则使用oauth2协议生成的token查找用户\n\t\t\tcollection = oAuth2Server.collections.accessToken\n\n\t\t\tobj = collection.findOne({'accessToken': access_token})\n\t\t\tif obj\n\t\t\t\t# 判断token的有效期\n\t\t\t\tif obj?.expires < new Date()\n\t\t\t\t\treturn \"oauth2 access token:\"+access_token+\" is expired.\"\n\t\t\t\telse\n\t\t\t\t\treturn obj?.userId\n\t\t\telse\n\t\t\t\treturn \"oauth2 access token:\"+access_token+\" is not found.\"\n\t\treturn null\n\n\tSteedos.getUserIdFromAuthToken = (req, res)->\n\n\t\tuserId = req.query?[\"X-User-Id\"]\n\n\t\tauthToken = req.query?[\"X-Auth-Token\"]\n\n\t\tif Steedos.checkAuthToken(userId,authToken)\n\t\t\treturn db.users.findOne({_id: userId})?._id\n\n\t\tcookies = new Cookies(req, res);\n\n\t\tif req.headers\n\t\t\tuserId = req.headers[\"x-user-id\"]\n\t\t\tauthToken = req.headers[\"x-auth-token\"]\n\n\t\t# then check cookie\n\t\tif !userId or !authToken\n\t\t\tuserId = cookies.get(\"X-User-Id\")\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\t\tif !userId or !authToken\n\t\t\treturn null\n\n\t\tif Steedos.checkAuthToken(userId, authToken)\n\t\t\treturn db.users.findOne({_id: userId})?._id\n\n\tSteedos.APIAuthenticationCheck = (req, res) ->\n\t\ttry\n\t\t\tuserId = req.userId\n\n\t\t\tuser = db.users.findOne({_id: userId})\n\n\t\t\tif !userId || !user\n\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\tdata:\n\t\t\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id Or access_token\",\n\t\t\t\t\tcode: 401,\n\t\t\t\treturn false;\n\t\t\telse\n\t\t\t\treturn true;\n\t\tcatch e\n\t\t\tif !userId || !user\n\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\tcode: 401,\n\t\t\t\t\tdata:\n\t\t\t\t\t\t\"error\": e.message,\n\t\t\t\t\t\t\"success\": false\n\t\t\t\treturn false;\n\n\n# This will add underscore.string methods to Underscore.js\n# except for include, contains, reverse and join that are\n# dropped because they collide with the functions already\n# defined by Underscore.js.\n\nmixin = (obj) ->\n\t_.each _.functions(obj), (name) ->\n\t\tif not _[name] and not _.prototype[name]?\n\t\t\tfunc = _[name] = obj[name]\n\t\t\t_.prototype[name] = ->\n\t\t\t\targs = [this._wrapped]\n\t\t\t\tpush.apply(args, arguments)\n\t\t\t\treturn result.call(this, func.apply(_, args))\n\n#mixin(_s.exports())\n\nif Meteor.isServer\n# 判断是否是节假日\n\tSteedos.isHoliday = (date)->\n\t\tif !date\n\t\t\tdate = new Date\n\t\tcheck date, Date\n\t\tday = date.getDay()\n\t\t# 周六周日为假期\n\t\tif day is 6 or day is 0\n\t\t\treturn true\n\n\t\treturn false\n\t# 根据传入时间(date)计算几个工作日(days)后的时间,days目前只能是整数\n\tSteedos.caculateWorkingTime = (date, days)->\n\t\tcheck date, Date\n\t\tcheck days, Number\n\t\tparam_date = new Date date\n\t\tcaculateDate = (i, days)->\n\t\t\tif i < days\n\t\t\t\tparam_date = new Date(param_date.getTime() + 24*60*60*1000)\n\t\t\t\tif !Steedos.isHoliday(param_date)\n\t\t\t\t\ti++\n\t\t\t\tcaculateDate(i, days)\n\t\t\treturn\n\t\tcaculateDate(0, days)\n\t\treturn param_date\n\n\t# 计算半个工作日后的时间\n\t# 参数 next如果为true则表示只计算date时间后面紧接着的time_points\n\tSteedos.caculatePlusHalfWorkingDay = (date, next) ->\n\t\tcheck date, Date\n\t\ttime_points = Meteor.settings.remind?.time_points\n\t\tif not time_points or _.isEmpty(time_points)\n\t\t\ttime_points = [{\"hour\": 8, \"minute\": 30 }, {\"hour\": 14, \"minute\": 30 }]\n\n\t\tlen = time_points.length\n\t\tstart_date = new Date date\n\t\tend_date = new Date date\n\t\tstart_date.setHours time_points[0].hour\n\t\tstart_date.setMinutes time_points[0].minute\n\t\tend_date.setHours time_points[len - 1].hour\n\t\tend_date.setMinutes time_points[len - 1].minute\n\n\t\tcaculated_date = new Date date\n\n\t\tj = 0\n\t\tmax_index = len - 1\n\t\tif date < start_date\n\t\t\tif next\n\t\t\t\tj = 0\n\t\t\telse\n\t\t\t\t# 加半个time_points\n\t\t\t\tj = len/2\n\t\telse if date >= start_date and date < end_date\n\t\t\ti = 0\n\t\t\twhile i < max_index\n\t\t\t\tfirst_date = new Date date\n\t\t\t\tsecond_date = new Date date\n\t\t\t\tfirst_date.setHours time_points[i].hour\n\t\t\t\tfirst_date.setMinutes time_points[i].minute\n\t\t\t\tsecond_date.setHours time_points[i + 1].hour\n\t\t\t\tsecond_date.setMinutes time_points[i + 1].minute\n\n\t\t\t\tif date >= first_date and date < second_date\n\t\t\t\t\tbreak\n\n\t\t\t\ti++\n\n\t\t\tif next\n\t\t\t\tj = i + 1\n\t\t\telse\n\t\t\t\tj = i + len/2\n\n\t\telse if date >= end_date\n\t\t\tif next\n\t\t\t\tj = max_index + 1\n\t\t\telse\n\t\t\t\tj = max_index + len/2\n\n\t\tif j > max_index\n\t\t\t# 隔天需判断节假日\n\t\t\tcaculated_date = Steedos.caculateWorkingTime date, 1\n\t\t\tcaculated_date.setHours time_points[j - max_index - 1].hour\n\t\t\tcaculated_date.setMinutes time_points[j - max_index - 1].minute\n\t\telse if j <= max_index\n\t\t\tcaculated_date.setHours time_points[j].hour\n\t\t\tcaculated_date.setMinutes time_points[j].minute\n\n\t\treturn caculated_date\n\nif Meteor.isServer\n\t_.extend Steedos,\n\t\tgetSteedosToken: (appId, userId, authToken)->\n\t\t\tcrypto = require('crypto')\n\t\t\tapp = db.apps.findOne(appId)\n\t\t\tif app\n\t\t\t\tsecret = app.secret\n\n\t\t\tif userId and authToken\n\t\t\t\thashedToken = Accounts._hashLoginToken(authToken)\n\t\t\t\tuser = Meteor.users.findOne\n\t\t\t\t\t_id: userId,\n\t\t\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\n\t\t\t\tif user\n\t\t\t\t\tsteedos_id = user.steedos_id\n\t\t\t\t\tif app.secret\n\t\t\t\t\t\tiv = app.secret\n\t\t\t\t\telse\n\t\t\t\t\t\tiv = \"-8762-fcb369b2e8\"\n\t\t\t\t\tnow = parseInt(new Date().getTime()/1000).toString()\n\t\t\t\t\tkey32 = \"\"\n\t\t\t\t\tlen = steedos_id.length\n\t\t\t\t\tif len < 32\n\t\t\t\t\t\tc = \"\"\n\t\t\t\t\t\ti = 0\n\t\t\t\t\t\tm = 32 - len\n\t\t\t\t\t\twhile i < m\n\t\t\t\t\t\t\tc = \" \" + c\n\t\t\t\t\t\t\ti++\n\t\t\t\t\t\tkey32 = steedos_id + c\n\t\t\t\t\telse if len >= 32\n\t\t\t\t\t\tkey32 = steedos_id.slice(0,32)\n\n\t\t\t\t\tcipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\n\n\t\t\t\t\tcipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()])\n\n\t\t\t\t\tsteedos_token = cipheredMsg.toString('base64')\n\n\t\t\treturn steedos_token\n\n\t\tlocale: (userId, isI18n)->\n\t\t\tuser = db.users.findOne({_id:userId},{fields: {locale: 1}})\n\t\t\tlocale = user?.locale\n\t\t\tif isI18n\n\t\t\t\tif locale == \"en-us\"\n\t\t\t\t\tlocale = \"en\"\n\t\t\t\tif locale == \"zh-cn\"\n\t\t\t\t\tlocale = \"zh-CN\"\n\t\t\treturn locale\n\n\t\tcheckUsernameAvailability: (username) ->\n\t\t\treturn not Meteor.users.findOne({ username: { $regex : new RegExp(\"^\" + Meteor._escapeRegExp(username).trim() + \"$\", \"i\") } })\n\n\n\t\tvalidatePassword: (pwd)->\n\t\t\treason = t \"password_invalid\"\n\t\t\tvalid = true\n\t\t\tunless pwd\n\t\t\t\tvalid = false\n\n\t\t\tpassworPolicy = Meteor.settings.public?.password?.policy\n\t\t\tpassworPolicyError = Meteor.settings.public?.password?.policyError || Meteor.settings.public?.password?.policyerror || \"密码不符合规则\"\n\t\t\tif passworPolicy\n\t\t\t\tif !(new RegExp(passworPolicy)).test(pwd || '')\n\t\t\t\t\treason = passworPolicyError\n\t\t\t\t\tvalid = false\n\t\t\t\telse\n\t\t\t\t\tvalid = true\n#\t\t\telse\n#\t\t\t\tunless /\\d+/.test(pwd)\n#\t\t\t\t\tvalid = false\n#\t\t\t\tunless /[a-zA-Z]+/.test(pwd)\n#\t\t\t\t\tvalid = false\n#\t\t\t\tif pwd.length < 8\n#\t\t\t\t\tvalid = false\n\t\t\tif valid\n\t\t\t\treturn true\n\t\t\telse\n\t\t\t\treturn error:\n\t\t\t\t\treason: reason\n\nSteedos.convertSpecialCharacter = (str)->\n\treturn str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\")\n\nSteedos.removeSpecialCharacter = (str)->\n\treturn str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}\\~\\`\\@\\#\\%\\&\\=\\'\\\"\\:\\;\\<\\>\\,\\/])/g, \"\")\n\nCreator.getDBApps = (space_id)->\n\tdbApps = {}\n\tCreator.Collections[\"apps\"].find({space: space_id,is_creator:true,visible:true}, {\n\t\tfields: {\n\t\t\tcreated: 0,\n\t\t\tcreated_by: 0,\n\t\t\tmodified: 0,\n\t\t\tmodified_by: 0\n\t\t}\n\t}).forEach (app)->\n\t\tdbApps[app._id] = app\n\n\treturn dbApps\n\nCreator.getDBDashboards = (space_id)->\n\tdbDashboards = {}\n\tCreator.Collections[\"dashboard\"].find({space: space_id}, {\n\t\tfields: {\n\t\t\tcreated: 0,\n\t\t\tcreated_by: 0,\n\t\t\tmodified: 0,\n\t\t\tmodified_by: 0\n\t\t}\n\t}).forEach (dashboard)->\n\t\tdbDashboards[dashboard._id] = dashboard\n\n\treturn dbDashboards\n\nif Meteor.isServer\n\tCookies = require(\"cookies\")\n\tSteedos.getAuthToken = (req, res)->\n\t\tcookies = new Cookies(req, res)\n\t\tauthToken = req.headers['x-auth-token'] || cookies.get(\"X-Auth-Token\")\n\t\tif !authToken && req.headers.authorization && req.headers.authorization.split(' ')[0] == 'Bearer'\n\t\t\tauthToken = req.headers.authorization.split(' ')[1]\n\t\treturn authToken\n\nif Meteor.isClient\n\tMeteor.autorun ()->\n\t\tif Session.get('current_app_id')\n\t\t\tsessionStorage.setItem('current_app_id', Session.get('current_app_id'))\n#\t\telse\n#\t\t\tconsole.log('remove current_app_id...');\n#\t\t\tsessionStorage.removeItem('current_app_id')\n\tSteedos.getCurrentAppId = ()->\n\t\tif Session.get('app_id')\n\t\t\treturn Session.get('app_id')\n\t\telse\n\t\t\treturn sessionStorage.getItem('current_app_id');\n\nif Meteor.isServer\n\tSteedos.formatIndex = (array) ->\n\t\tobject = {\n        \tbackground: true\n    \t};\n\t\tisdocumentDB = Meteor.settings?.datasources?.default?.documentDB || false;\n\t\tif isdocumentDB\n\t\t\tif array.length > 0\n\t\t\t\tindexName = array.join(\".\");\n\t\t\t\tobject.name = indexName;\n\t\t\t\t\n\t\t\t\tif (indexName.length > 52)\n\t\t\t\t\tobject.name = indexName.substring(0,52);\n\n\t\treturn object;","var Cookies, crypto, mixin, ref, ref1, ref2, ref3, ref4, rootUrl;         \n\nSteedos = {\n  settings: {},\n  db: db,\n  subs: {},\n  isPhoneEnabled: function() {\n    var ref, ref1;\n    return !!((ref = Meteor.settings) != null ? (ref1 = ref[\"public\"]) != null ? ref1.phone : void 0 : void 0);\n  },\n  numberToString: function(number, scale, notThousands) {\n    var ref, ref1, reg;\n    if (typeof number === \"number\") {\n      number = number.toString();\n    }\n    if (!number) {\n      return '';\n    }\n    if (number !== \"NaN\") {\n      if (scale || scale === 0) {\n        number = Number(number).toFixed(scale);\n      }\n      if (!notThousands) {\n        if (!(scale || scale === 0)) {\n          scale = (ref = number.match(/\\.(\\d+)/)) != null ? (ref1 = ref[1]) != null ? ref1.length : void 0 : void 0;\n          if (!scale) {\n            scale = 0;\n          }\n        }\n        reg = /(\\d)(?=(\\d{3})+\\.)/g;\n        if (scale === 0) {\n          reg = /(\\d)(?=(\\d{3})+\\b)/g;\n        }\n        number = number.replace(reg, '$1,');\n      }\n      return number;\n    } else {\n      return \"\";\n    }\n  },\n  numberToPercentString: function(number, scale, notThousands) {\n    var newNumber;\n    newNumber = Number((number * 100).toFixed(scale));\n    return Steedos.numberToString(newNumber, scale, notThousands) + \"%\";\n  },\n  valiJquerySymbols: function(str) {\n    var reg;\n    reg = new RegExp(\"^[^!\\\"#$%&'()*\\+,\\.\\/:;<=>?@[\\\\]^`{|}~]+$\");\n    return reg.test(str);\n  },\n  authRequest: function(url, options) {\n    var authToken, authorization, defOptions, err, headers, result, spaceId, userSession;\n    userSession = Creator.USER_CONTEXT;\n    spaceId = userSession.spaceId;\n    authToken = userSession.authToken ? userSession.authToken : userSession.user.authToken;\n    result = null;\n    url = Steedos.absoluteUrl(url);\n    try {\n      authorization = 'Bearer ' + spaceId + ',' + authToken;\n      headers = [\n        {\n          name: 'Content-Type',\n          value: 'application/json'\n        }, {\n          name: 'Authorization',\n          value: authorization\n        }\n      ];\n      defOptions = {\n        type: 'get',\n        url: url,\n        dataType: 'json',\n        contentType: 'application/json',\n        beforeSend: function(XHR) {\n          if (headers && headers.length) {\n            return headers.forEach(function(header) {\n              return XHR.setRequestHeader(header.name, header.value);\n            });\n          }\n        },\n        success: function(data) {\n          result = data;\n        },\n        error: function(XMLHttpRequest, textStatus, errorThrown) {\n          var errorInfo, errorMsg;\n          console.error(XMLHttpRequest.responseJSON);\n          if (XMLHttpRequest.responseJSON && XMLHttpRequest.responseJSON.error) {\n            errorInfo = XMLHttpRequest.responseJSON.error;\n            result = {\n              error: errorInfo\n            };\n            errorMsg = void 0;\n            if (errorInfo.reason) {\n              errorMsg = errorInfo.reason;\n            } else if (errorInfo.message) {\n              errorMsg = errorInfo.message;\n            } else {\n              errorMsg = errorInfo;\n              toastr.error(t(errorMsg.replace(/:/g, '：')));\n            }\n          } else {\n            toastr.error(XMLHttpRequest.responseJSON);\n          }\n        }\n      };\n      $.ajax(Object.assign({}, defOptions, options));\n      return result;\n    } catch (error1) {\n      err = error1;\n      console.error(err);\n      toastr.error(err);\n    }\n  }\n};\n\n\n/*\n * Kick off the global namespace for Steedos.\n * @namespace Steedos\n */\n\nif (Meteor.isCordova || Meteor.isClient) {\n  rootUrl = Meteor.absoluteUrl.defaultOptions.rootUrl;\n  if (rootUrl.endsWith('/')) {\n    rootUrl = rootUrl.substr(0, rootUrl.length - 1);\n  }\n  if ((ref = window.stores) != null) {\n    if ((ref1 = ref.API) != null) {\n      if ((ref2 = ref1.client) != null) {\n        ref2.setUrl(rootUrl);\n      }\n    }\n  }\n  if ((ref3 = window.stores) != null) {\n    if ((ref4 = ref3.Settings) != null) {\n      ref4.setRootUrl(rootUrl);\n    }\n  }\n  window['steedos.setting'] = {\n    rootUrl: rootUrl\n  };\n}\n\nif (!Meteor.isCordova && Meteor.isClient) {\n  Meteor.startup(function() {\n    var ref5, ref6, ref7, ref8;\n    return (ref5 = window.stores) != null ? (ref6 = ref5.Settings) != null ? ref6.setHrefPopup((ref7 = Meteor.settings[\"public\"]) != null ? (ref8 = ref7.ui) != null ? ref8.href_popup : void 0 : void 0) : void 0 : void 0;\n  });\n}\n\nSteedos.getHelpUrl = function(locale) {\n  var country;\n  country = locale.substring(3);\n  return \"http://www.steedos.com/\" + country + \"/help/\";\n};\n\nSteedos.isExpression = function(func) {\n  var pattern, reg1, reg2;\n  if (typeof func !== 'string') {\n    return false;\n  }\n  pattern = /^{{(.+)}}$/;\n  reg1 = /^{{(function.+)}}$/;\n  reg2 = /^{{(.+=>.+)}}$/;\n  if (typeof func === 'string' && func.match(pattern) && !func.match(reg1) && !func.match(reg2)) {\n    return true;\n  }\n  return false;\n};\n\nSteedos.parseSingleExpression = function(func, formData, dataPath, global) {\n  var error, funcBody, getParentPath, getValueByPath, globalTag, parent, parentPath, str;\n  getParentPath = function(path) {\n    var pathArr;\n    if (typeof path === 'string') {\n      pathArr = path.split('.');\n      if (pathArr.length === 1) {\n        return '#';\n      }\n      pathArr.pop();\n      return pathArr.join('.');\n    }\n    return '#';\n  };\n  getValueByPath = function(formData, path) {\n    if (path === '#' || !path) {\n      return formData || {};\n    } else if (typeof path === 'string') {\n      return _.get(formData, path);\n    } else {\n      console.error('path has to be a string');\n    }\n  };\n  if (formData === void 0) {\n    formData = {};\n  }\n  parentPath = getParentPath(dataPath);\n  parent = getValueByPath(formData, parentPath) || {};\n  if (typeof func === 'string') {\n    funcBody = func.substring(2, func.length - 2);\n    globalTag = '__G_L_O_B_A_L__';\n    str = '\\n    return ' + funcBody.replace(/\\bformData\\b/g, JSON.stringify(formData).replace(/\\bglobal\\b/g, globalTag)).replace(/\\bglobal\\b/g, JSON.stringify(global)).replace(new RegExp('\\\\b' + globalTag + '\\\\b', 'g'), 'global').replace(/rootValue/g, JSON.stringify(parent));\n    try {\n      return Function(str)();\n    } catch (error1) {\n      error = error1;\n      console.log(error, func, dataPath);\n      return func;\n    }\n  } else {\n    return func;\n  }\n};\n\nif (Meteor.isClient) {\n  Steedos.spaceUpgradedModal = function() {\n    return swal({\n      title: TAPi18n.__(\"space_paid_info_title\"),\n      text: TAPi18n.__(\"space_paid_info_text\"),\n      html: true,\n      type: \"warning\",\n      confirmButtonText: TAPi18n.__(\"OK\")\n    });\n  };\n  Steedos.getAccountBgBodyValue = function() {\n    var accountBgBody;\n    accountBgBody = db.steedos_keyvalues.findOne({\n      user: Steedos.userId(),\n      key: \"bg_body\"\n    });\n    if (accountBgBody) {\n      return accountBgBody.value;\n    } else {\n      return {};\n    }\n  };\n  Steedos.applyAccountBgBodyValue = function(accountBgBodyValue, isNeedToLocal) {\n    var avatar, url;\n    if (Meteor.loggingIn() || !Steedos.userId()) {\n      accountBgBodyValue = {};\n      accountBgBodyValue.url = localStorage.getItem(\"accountBgBodyValue.url\");\n      accountBgBodyValue.avatar = localStorage.getItem(\"accountBgBodyValue.avatar\");\n    }\n    url = accountBgBodyValue.url;\n    avatar = accountBgBodyValue.avatar;\n    if (isNeedToLocal) {\n      if (Meteor.loggingIn()) {\n        return;\n      }\n      if (Steedos.userId()) {\n        if (url) {\n          localStorage.setItem(\"accountBgBodyValue.url\", url);\n          return localStorage.setItem(\"accountBgBodyValue.avatar\", avatar);\n        } else {\n          localStorage.removeItem(\"accountBgBodyValue.url\");\n          return localStorage.removeItem(\"accountBgBodyValue.avatar\");\n        }\n      }\n    }\n  };\n  Steedos.getAccountSkinValue = function() {\n    var accountSkin;\n    accountSkin = db.steedos_keyvalues.findOne({\n      user: Steedos.userId(),\n      key: \"skin\"\n    });\n    if (accountSkin) {\n      return accountSkin.value;\n    } else {\n      return {};\n    }\n  };\n  Steedos.getAccountZoomValue = function() {\n    var accountZoom;\n    accountZoom = db.steedos_keyvalues.findOne({\n      user: Steedos.userId(),\n      key: \"zoom\"\n    });\n    if (accountZoom) {\n      return accountZoom.value;\n    } else {\n      return {};\n    }\n  };\n  Steedos.applyAccountZoomValue = function(accountZoomValue, isNeedToLocal) {};\n  Steedos.showHelp = function(url) {\n    var country, locale;\n    locale = Steedos.getLocale();\n    country = locale.substring(3);\n    url = url || \"http://www.steedos.com/\" + country + \"/help/\";\n    return window.open(url, '_help', 'EnableViewPortScale=yes');\n  };\n  Steedos.getUrlWithToken = function(url) {\n    var authToken, linker;\n    authToken = {};\n    authToken[\"spaceId\"] = Steedos.getSpaceId();\n    authToken[\"X-User-Id\"] = Meteor.userId();\n    authToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\n    linker = \"?\";\n    if (url.indexOf(\"?\") > -1) {\n      linker = \"&\";\n    }\n    return url + linker + $.param(authToken);\n  };\n  Steedos.getAppUrlWithToken = function(app_id) {\n    var authToken;\n    authToken = {};\n    authToken[\"spaceId\"] = Steedos.getSpaceId();\n    authToken[\"X-User-Id\"] = Meteor.userId();\n    authToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\n    return \"api/setup/sso/\" + app_id + \"?\" + $.param(authToken);\n  };\n  Steedos.openAppWithToken = function(app_id) {\n    var app, url;\n    url = Steedos.getAppUrlWithToken(app_id);\n    url = Steedos.absoluteUrl(url);\n    app = db.apps.findOne(app_id);\n    if (!app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()) {\n      return window.location = url;\n    } else {\n      return Steedos.openWindow(url);\n    }\n  };\n  Steedos.openUrlWithIE = function(url) {\n    var cmd, exec, open_url;\n    if (url) {\n      if (Steedos.isNode()) {\n        exec = nw.require('child_process').exec;\n        open_url = url;\n        cmd = \"start iexplore.exe \\\"\" + open_url + \"\\\"\";\n        return exec(cmd, function(error, stdout, stderr) {\n          if (error) {\n            toastr.error(error);\n          }\n        });\n      } else {\n        return Steedos.openWindow(url);\n      }\n    }\n  };\n  Steedos.openApp = function(app_id) {\n    var app, cmd, e, evalFunString, exec, on_click, open_url, path;\n    if (!Meteor.userId()) {\n      Steedos.redirectToSignIn();\n      return true;\n    }\n    app = db.apps.findOne(app_id);\n    if (!app) {\n      FlowRouter.go(\"/\");\n      return;\n    }\n    on_click = app.on_click;\n    if (app.is_use_ie) {\n      if (Steedos.isNode()) {\n        exec = nw.require('child_process').exec;\n        if (on_click) {\n          path = \"api/app/sso/\" + app_id + \"?authToken=\" + (Accounts._storedLoginToken()) + \"&userId=\" + (Meteor.userId());\n          open_url = window.location.origin + \"/\" + path;\n        } else {\n          open_url = Steedos.getAppUrlWithToken(app_id);\n          open_url = window.location.origin + \"/\" + open_url;\n        }\n        cmd = \"start iexplore.exe \\\"\" + open_url + \"\\\"\";\n        exec(cmd, function(error, stdout, stderr) {\n          if (error) {\n            toastr.error(error);\n          }\n        });\n      } else {\n        Steedos.openAppWithToken(app_id);\n      }\n    } else if (db.apps.isInternalApp(app.url)) {\n      FlowRouter.go(app.url);\n    } else if (app.is_use_iframe) {\n      if (app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()) {\n        Steedos.openWindow(Steedos.absoluteUrl(\"apps/iframe/\" + app._id));\n      } else if (Steedos.isMobile() || Steedos.isCordova()) {\n        Steedos.openAppWithToken(app_id);\n      } else {\n        FlowRouter.go(\"/apps/iframe/\" + app._id);\n      }\n    } else if (on_click) {\n      evalFunString = \"(function(){\" + on_click + \"})()\";\n      try {\n        eval(evalFunString);\n      } catch (error1) {\n        e = error1;\n        console.error(\"catch some error when eval the on_click script for app link:\");\n        console.error(e.message + \"\\r\\n\" + e.stack);\n      }\n    } else {\n      Steedos.openAppWithToken(app_id);\n    }\n    if (!app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova() && !app.is_use_ie && !on_click) {\n      return Session.set(\"current_app_id\", app_id);\n    }\n  };\n  Steedos.checkSpaceBalance = function(spaceId) {\n    var end_date, min_months, space;\n    if (!spaceId) {\n      spaceId = Steedos.spaceId();\n    }\n    min_months = 1;\n    if (Steedos.isSpaceAdmin()) {\n      min_months = 3;\n    }\n    space = db.spaces.findOne(spaceId);\n    end_date = space != null ? space.end_date : void 0;\n    if (space && end_date !== void 0 && (end_date - new Date) <= (min_months * 30 * 24 * 3600 * 1000)) {\n      return toastr.error(t(\"space_balance_insufficient\"));\n    }\n  };\n  Steedos.setModalMaxHeight = function() {\n    var accountZoomValue, offset;\n    accountZoomValue = Steedos.getAccountZoomValue();\n    if (!accountZoomValue.name) {\n      accountZoomValue.name = 'large';\n    }\n    switch (accountZoomValue.name) {\n      case 'normal':\n        if (Steedos.isMobile()) {\n          offset = -12;\n        } else {\n          offset = 75;\n        }\n        break;\n      case 'large':\n        if (Steedos.isMobile()) {\n          offset = -6;\n        } else {\n          if (Steedos.detectIE()) {\n            offset = 199;\n          } else {\n            offset = 9;\n          }\n        }\n        break;\n      case 'extra-large':\n        if (Steedos.isMobile()) {\n          offset = -26;\n        } else {\n          if (Steedos.detectIE()) {\n            offset = 303;\n          } else {\n            offset = 53;\n          }\n        }\n    }\n    if ($(\".modal\").length) {\n      return $(\".modal\").each(function() {\n        var footerHeight, headerHeight, height, totalHeight;\n        headerHeight = 0;\n        footerHeight = 0;\n        totalHeight = 0;\n        $(\".modal-header\", $(this)).each(function() {\n          return headerHeight += $(this).outerHeight(false);\n        });\n        $(\".modal-footer\", $(this)).each(function() {\n          return footerHeight += $(this).outerHeight(false);\n        });\n        totalHeight = headerHeight + footerHeight;\n        height = $(\"body\").innerHeight() - totalHeight - offset;\n        if ($(this).hasClass(\"cf_contact_modal\")) {\n          return $(\".modal-body\", $(this)).css({\n            \"max-height\": height + \"px\",\n            \"height\": height + \"px\"\n          });\n        } else {\n          return $(\".modal-body\", $(this)).css({\n            \"max-height\": height + \"px\",\n            \"height\": \"auto\"\n          });\n        }\n      });\n    }\n  };\n  Steedos.getModalMaxHeight = function(offset) {\n    var accountZoomValue, reValue;\n    if (Steedos.isMobile()) {\n      reValue = window.screen.height - 126 - 180 - 25;\n    } else {\n      reValue = $(window).height() - 180 - 25;\n    }\n    if (!(Steedos.isiOS() || Steedos.isMobile())) {\n      accountZoomValue = Steedos.getAccountZoomValue();\n      switch (accountZoomValue.name) {\n        case 'large':\n          reValue -= 50;\n          break;\n        case 'extra-large':\n          reValue -= 145;\n      }\n    }\n    if (offset) {\n      reValue -= offset;\n    }\n    return reValue + \"px\";\n  };\n  Steedos.isiOS = function(userAgent, language) {\n    var DEVICE, browser, conExp, device, numExp;\n    DEVICE = {\n      android: 'android',\n      blackberry: 'blackberry',\n      desktop: 'desktop',\n      ipad: 'ipad',\n      iphone: 'iphone',\n      ipod: 'ipod',\n      mobile: 'mobile'\n    };\n    browser = {};\n    conExp = '(?:[\\\\/:\\\\::\\\\s:;])';\n    numExp = '(\\\\S+[^\\\\s:;:\\\\)]|)';\n    userAgent = (userAgent || navigator.userAgent).toLowerCase();\n    language = language || navigator.language || navigator.browserLanguage;\n    device = userAgent.match(new RegExp('(android|ipad|iphone|ipod|blackberry)')) || userAgent.match(new RegExp('(mobile)')) || ['', DEVICE.desktop];\n    browser.device = device[1];\n    return browser.device === DEVICE.ipad || browser.device === DEVICE.iphone || browser.device === DEVICE.ipod;\n  };\n  Steedos.getUserOrganizations = function(isIncludeParents) {\n    var organizations, parents, spaceId, space_user, userId;\n    userId = Meteor.userId();\n    spaceId = Steedos.spaceId();\n    space_user = db.space_users.findOne({\n      user: userId,\n      space: spaceId\n    }, {\n      fields: {\n        organizations: 1\n      }\n    });\n    organizations = space_user != null ? space_user.organizations : void 0;\n    if (!organizations) {\n      return [];\n    }\n    if (isIncludeParents) {\n      parents = _.flatten(db.organizations.find({\n        _id: {\n          $in: organizations\n        }\n      }).fetch().getProperty(\"parents\"));\n      return _.union(organizations, parents);\n    } else {\n      return organizations;\n    }\n  };\n  Steedos.forbidNodeContextmenu = function(target, ifr) {\n    if (!Steedos.isNode()) {\n      return;\n    }\n    target.document.body.addEventListener('contextmenu', function(ev) {\n      ev.preventDefault();\n      return false;\n    });\n    if (ifr) {\n      if (typeof ifr === 'string') {\n        ifr = target.$(ifr);\n      }\n      return ifr.load(function() {\n        var ifrBody;\n        ifrBody = ifr.contents().find('body');\n        if (ifrBody) {\n          return ifrBody[0].addEventListener('contextmenu', function(ev) {\n            ev.preventDefault();\n            return false;\n          });\n        }\n      });\n    }\n  };\n}\n\nif (Meteor.isServer) {\n  Steedos.getUserOrganizations = function(spaceId, userId, isIncludeParents) {\n    var organizations, parents, space_user;\n    space_user = db.space_users.findOne({\n      user: userId,\n      space: spaceId\n    }, {\n      fields: {\n        organizations: 1\n      }\n    });\n    organizations = space_user != null ? space_user.organizations : void 0;\n    if (!organizations) {\n      return [];\n    }\n    if (isIncludeParents) {\n      parents = _.flatten(db.organizations.find({\n        _id: {\n          $in: organizations\n        }\n      }).fetch().getProperty(\"parents\"));\n      return _.union(organizations, parents);\n    } else {\n      return organizations;\n    }\n  };\n}\n\nif (Meteor.isServer) {\n  Cookies = require(\"cookies\");\n  Steedos.isMobile = function() {\n    return false;\n  };\n  Steedos.isSpaceAdmin = function(spaceId, userId) {\n    var space;\n    if (!spaceId || !userId) {\n      return false;\n    }\n    space = db.spaces.findOne(spaceId);\n    if (!space || !space.admins) {\n      return false;\n    }\n    return space.admins.indexOf(userId) >= 0;\n  };\n  Steedos.isLegalVersion = function(spaceId, app_version) {\n    var check, modules, ref5;\n    if (!spaceId) {\n      return false;\n    }\n    check = false;\n    modules = (ref5 = db.spaces.findOne(spaceId)) != null ? ref5.modules : void 0;\n    if (modules && modules.includes(app_version)) {\n      check = true;\n    }\n    return check;\n  };\n  Steedos.isOrgAdminByOrgIds = function(orgIds, userId) {\n    var allowAccessOrgs, isOrgAdmin, parents, useOrgs;\n    isOrgAdmin = false;\n    useOrgs = db.organizations.find({\n      _id: {\n        $in: orgIds\n      }\n    }, {\n      fields: {\n        parents: 1,\n        admins: 1\n      }\n    }).fetch();\n    parents = [];\n    allowAccessOrgs = useOrgs.filter(function(org) {\n      var ref5;\n      if (org.parents) {\n        parents = _.union(parents, org.parents);\n      }\n      return (ref5 = org.admins) != null ? ref5.includes(userId) : void 0;\n    });\n    if (allowAccessOrgs.length) {\n      isOrgAdmin = true;\n    } else {\n      parents = _.flatten(parents);\n      parents = _.uniq(parents);\n      if (parents.length && db.organizations.findOne({\n        _id: {\n          $in: parents\n        },\n        admins: userId\n      })) {\n        isOrgAdmin = true;\n      }\n    }\n    return isOrgAdmin;\n  };\n  Steedos.isOrgAdminByAllOrgIds = function(orgIds, userId) {\n    var i, isOrgAdmin;\n    if (!orgIds.length) {\n      return true;\n    }\n    i = 0;\n    while (i < orgIds.length) {\n      isOrgAdmin = Steedos.isOrgAdminByOrgIds([orgIds[i]], userId);\n      if (!isOrgAdmin) {\n        break;\n      }\n      i++;\n    }\n    return isOrgAdmin;\n  };\n  Steedos.absoluteUrl = function(url) {\n    var e, root_url;\n    if (url) {\n      url = url.replace(/^\\//, \"\");\n    }\n    if (Meteor.isCordova) {\n      return Meteor.absoluteUrl(url);\n    } else {\n      if (Meteor.isClient) {\n        try {\n          root_url = new URL(Meteor.absoluteUrl());\n          if (url) {\n            return root_url.pathname + url;\n          } else {\n            return root_url.pathname;\n          }\n        } catch (error1) {\n          e = error1;\n          return Meteor.absoluteUrl(url);\n        }\n      } else {\n        return Meteor.absoluteUrl(url);\n      }\n    }\n  };\n  Steedos.getAPILoginUser = function(req, res) {\n    var authToken, cookies, password, ref5, ref6, ref7, ref8, result, user, userId, username;\n    username = (ref5 = req.query) != null ? ref5.username : void 0;\n    password = (ref6 = req.query) != null ? ref6.password : void 0;\n    if (username && password) {\n      user = db.users.findOne({\n        steedos_id: username\n      });\n      if (!user) {\n        return false;\n      }\n      result = Accounts._checkPassword(user, password);\n      if (result.error) {\n        throw new Error(result.error);\n      } else {\n        return user;\n      }\n    }\n    userId = (ref7 = req.query) != null ? ref7[\"X-User-Id\"] : void 0;\n    authToken = (ref8 = req.query) != null ? ref8[\"X-Auth-Token\"] : void 0;\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return db.users.findOne({\n        _id: userId\n      });\n    }\n    cookies = new Cookies(req, res);\n    if (req.headers) {\n      userId = req.headers[\"x-user-id\"];\n      authToken = req.headers[\"x-auth-token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!userId || !authToken) {\n      return false;\n    }\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return db.users.findOne({\n        _id: userId\n      });\n    }\n    return false;\n  };\n  Steedos.checkAuthToken = function(userId, authToken) {\n    var hashedToken, user;\n    if (userId && authToken) {\n      hashedToken = Accounts._hashLoginToken(authToken);\n      user = Meteor.users.findOne({\n        _id: userId,\n        \"services.resume.loginTokens.hashedToken\": hashedToken\n      });\n      if (user) {\n        return true;\n      } else {\n        return false;\n      }\n    }\n    return false;\n  };\n}\n\nif (Meteor.isServer) {\n  crypto = require('crypto');\n  Steedos.decrypt = function(password, key, iv) {\n    var c, decipher, decipherMsg, e, i, key32, len, m;\n    try {\n      key32 = \"\";\n      len = key.length;\n      if (len < 32) {\n        c = \"\";\n        i = 0;\n        m = 32 - len;\n        while (i < m) {\n          c = \" \" + c;\n          i++;\n        }\n        key32 = key + c;\n      } else if (len >= 32) {\n        key32 = key.slice(0, 32);\n      }\n      decipher = crypto.createDecipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n      decipherMsg = Buffer.concat([decipher.update(password, 'base64'), decipher.final()]);\n      password = decipherMsg.toString();\n      return password;\n    } catch (error1) {\n      e = error1;\n      return password;\n    }\n  };\n  Steedos.encrypt = function(password, key, iv) {\n    var c, cipher, cipheredMsg, i, key32, len, m;\n    key32 = \"\";\n    len = key.length;\n    if (len < 32) {\n      c = \"\";\n      i = 0;\n      m = 32 - len;\n      while (i < m) {\n        c = \" \" + c;\n        i++;\n      }\n      key32 = key + c;\n    } else if (len >= 32) {\n      key32 = key.slice(0, 32);\n    }\n    cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n    cipheredMsg = Buffer.concat([cipher.update(new Buffer(password, 'utf8')), cipher.final()]);\n    password = cipheredMsg.toString('base64');\n    return password;\n  };\n  Steedos.getUserIdFromAccessToken = function(access_token) {\n    var collection, hashedToken, obj, user, userId;\n    if (!access_token) {\n      return null;\n    }\n    userId = access_token.split(\"-\")[0];\n    hashedToken = Accounts._hashLoginToken(access_token);\n    user = db.users.findOne({\n      _id: userId,\n      \"secrets.hashedToken\": hashedToken\n    });\n    if (user) {\n      return userId;\n    } else {\n      collection = oAuth2Server.collections.accessToken;\n      obj = collection.findOne({\n        'accessToken': access_token\n      });\n      if (obj) {\n        if ((obj != null ? obj.expires : void 0) < new Date()) {\n          return \"oauth2 access token:\" + access_token + \" is expired.\";\n        } else {\n          return obj != null ? obj.userId : void 0;\n        }\n      } else {\n        return \"oauth2 access token:\" + access_token + \" is not found.\";\n      }\n    }\n    return null;\n  };\n  Steedos.getUserIdFromAuthToken = function(req, res) {\n    var authToken, cookies, ref5, ref6, ref7, ref8, userId;\n    userId = (ref5 = req.query) != null ? ref5[\"X-User-Id\"] : void 0;\n    authToken = (ref6 = req.query) != null ? ref6[\"X-Auth-Token\"] : void 0;\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return (ref7 = db.users.findOne({\n        _id: userId\n      })) != null ? ref7._id : void 0;\n    }\n    cookies = new Cookies(req, res);\n    if (req.headers) {\n      userId = req.headers[\"x-user-id\"];\n      authToken = req.headers[\"x-auth-token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!userId || !authToken) {\n      return null;\n    }\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return (ref8 = db.users.findOne({\n        _id: userId\n      })) != null ? ref8._id : void 0;\n    }\n  };\n  Steedos.APIAuthenticationCheck = function(req, res) {\n    var e, user, userId;\n    try {\n      userId = req.userId;\n      user = db.users.findOne({\n        _id: userId\n      });\n      if (!userId || !user) {\n        JsonRoutes.sendResult(res, {\n          data: {\n            \"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id Or access_token\"\n          },\n          code: 401\n        });\n        return false;\n      } else {\n        return true;\n      }\n    } catch (error1) {\n      e = error1;\n      if (!userId || !user) {\n        JsonRoutes.sendResult(res, {\n          code: 401,\n          data: {\n            \"error\": e.message,\n            \"success\": false\n          }\n        });\n        return false;\n      }\n    }\n  };\n}\n\nmixin = function(obj) {\n  return _.each(_.functions(obj), function(name) {\n    var func;\n    if (!_[name] && (_.prototype[name] == null)) {\n      func = _[name] = obj[name];\n      return _.prototype[name] = function() {\n        var args;\n        args = [this._wrapped];\n        push.apply(args, arguments);\n        return result.call(this, func.apply(_, args));\n      };\n    }\n  });\n};\n\nif (Meteor.isServer) {\n  Steedos.isHoliday = function(date) {\n    var day;\n    if (!date) {\n      date = new Date;\n    }\n    check(date, Date);\n    day = date.getDay();\n    if (day === 6 || day === 0) {\n      return true;\n    }\n    return false;\n  };\n  Steedos.caculateWorkingTime = function(date, days) {\n    var caculateDate, param_date;\n    check(date, Date);\n    check(days, Number);\n    param_date = new Date(date);\n    caculateDate = function(i, days) {\n      if (i < days) {\n        param_date = new Date(param_date.getTime() + 24 * 60 * 60 * 1000);\n        if (!Steedos.isHoliday(param_date)) {\n          i++;\n        }\n        caculateDate(i, days);\n      }\n    };\n    caculateDate(0, days);\n    return param_date;\n  };\n  Steedos.caculatePlusHalfWorkingDay = function(date, next) {\n    var caculated_date, end_date, first_date, i, j, len, max_index, ref5, second_date, start_date, time_points;\n    check(date, Date);\n    time_points = (ref5 = Meteor.settings.remind) != null ? ref5.time_points : void 0;\n    if (!time_points || _.isEmpty(time_points)) {\n      time_points = [\n        {\n          \"hour\": 8,\n          \"minute\": 30\n        }, {\n          \"hour\": 14,\n          \"minute\": 30\n        }\n      ];\n    }\n    len = time_points.length;\n    start_date = new Date(date);\n    end_date = new Date(date);\n    start_date.setHours(time_points[0].hour);\n    start_date.setMinutes(time_points[0].minute);\n    end_date.setHours(time_points[len - 1].hour);\n    end_date.setMinutes(time_points[len - 1].minute);\n    caculated_date = new Date(date);\n    j = 0;\n    max_index = len - 1;\n    if (date < start_date) {\n      if (next) {\n        j = 0;\n      } else {\n        j = len / 2;\n      }\n    } else if (date >= start_date && date < end_date) {\n      i = 0;\n      while (i < max_index) {\n        first_date = new Date(date);\n        second_date = new Date(date);\n        first_date.setHours(time_points[i].hour);\n        first_date.setMinutes(time_points[i].minute);\n        second_date.setHours(time_points[i + 1].hour);\n        second_date.setMinutes(time_points[i + 1].minute);\n        if (date >= first_date && date < second_date) {\n          break;\n        }\n        i++;\n      }\n      if (next) {\n        j = i + 1;\n      } else {\n        j = i + len / 2;\n      }\n    } else if (date >= end_date) {\n      if (next) {\n        j = max_index + 1;\n      } else {\n        j = max_index + len / 2;\n      }\n    }\n    if (j > max_index) {\n      caculated_date = Steedos.caculateWorkingTime(date, 1);\n      caculated_date.setHours(time_points[j - max_index - 1].hour);\n      caculated_date.setMinutes(time_points[j - max_index - 1].minute);\n    } else if (j <= max_index) {\n      caculated_date.setHours(time_points[j].hour);\n      caculated_date.setMinutes(time_points[j].minute);\n    }\n    return caculated_date;\n  };\n}\n\nif (Meteor.isServer) {\n  _.extend(Steedos, {\n    getSteedosToken: function(appId, userId, authToken) {\n      var app, c, cipher, cipheredMsg, hashedToken, i, iv, key32, len, m, now, secret, steedos_id, steedos_token, user;\n      crypto = require('crypto');\n      app = db.apps.findOne(appId);\n      if (app) {\n        secret = app.secret;\n      }\n      if (userId && authToken) {\n        hashedToken = Accounts._hashLoginToken(authToken);\n        user = Meteor.users.findOne({\n          _id: userId,\n          \"services.resume.loginTokens.hashedToken\": hashedToken\n        });\n        if (user) {\n          steedos_id = user.steedos_id;\n          if (app.secret) {\n            iv = app.secret;\n          } else {\n            iv = \"-8762-fcb369b2e8\";\n          }\n          now = parseInt(new Date().getTime() / 1000).toString();\n          key32 = \"\";\n          len = steedos_id.length;\n          if (len < 32) {\n            c = \"\";\n            i = 0;\n            m = 32 - len;\n            while (i < m) {\n              c = \" \" + c;\n              i++;\n            }\n            key32 = steedos_id + c;\n          } else if (len >= 32) {\n            key32 = steedos_id.slice(0, 32);\n          }\n          cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n          cipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()]);\n          steedos_token = cipheredMsg.toString('base64');\n        }\n      }\n      return steedos_token;\n    },\n    locale: function(userId, isI18n) {\n      var locale, user;\n      user = db.users.findOne({\n        _id: userId\n      }, {\n        fields: {\n          locale: 1\n        }\n      });\n      locale = user != null ? user.locale : void 0;\n      if (isI18n) {\n        if (locale === \"en-us\") {\n          locale = \"en\";\n        }\n        if (locale === \"zh-cn\") {\n          locale = \"zh-CN\";\n        }\n      }\n      return locale;\n    },\n    checkUsernameAvailability: function(username) {\n      return !Meteor.users.findOne({\n        username: {\n          $regex: new RegExp(\"^\" + Meteor._escapeRegExp(username).trim() + \"$\", \"i\")\n        }\n      });\n    },\n    validatePassword: function(pwd) {\n      var passworPolicy, passworPolicyError, reason, ref10, ref5, ref6, ref7, ref8, ref9, valid;\n      reason = t(\"password_invalid\");\n      valid = true;\n      if (!pwd) {\n        valid = false;\n      }\n      passworPolicy = (ref5 = Meteor.settings[\"public\"]) != null ? (ref6 = ref5.password) != null ? ref6.policy : void 0 : void 0;\n      passworPolicyError = ((ref7 = Meteor.settings[\"public\"]) != null ? (ref8 = ref7.password) != null ? ref8.policyError : void 0 : void 0) || ((ref9 = Meteor.settings[\"public\"]) != null ? (ref10 = ref9.password) != null ? ref10.policyerror : void 0 : void 0) || \"密码不符合规则\";\n      if (passworPolicy) {\n        if (!(new RegExp(passworPolicy)).test(pwd || '')) {\n          reason = passworPolicyError;\n          valid = false;\n        } else {\n          valid = true;\n        }\n      }\n      if (valid) {\n        return true;\n      } else {\n        return {\n          error: {\n            reason: reason\n          }\n        };\n      }\n    }\n  });\n}\n\nSteedos.convertSpecialCharacter = function(str) {\n  return str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\");\n};\n\nSteedos.removeSpecialCharacter = function(str) {\n  return str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}\\~\\`\\@\\#\\%\\&\\=\\'\\\"\\:\\;\\<\\>\\,\\/])/g, \"\");\n};\n\nCreator.getDBApps = function(space_id) {\n  var dbApps;\n  dbApps = {};\n  Creator.Collections[\"apps\"].find({\n    space: space_id,\n    is_creator: true,\n    visible: true\n  }, {\n    fields: {\n      created: 0,\n      created_by: 0,\n      modified: 0,\n      modified_by: 0\n    }\n  }).forEach(function(app) {\n    return dbApps[app._id] = app;\n  });\n  return dbApps;\n};\n\nCreator.getDBDashboards = function(space_id) {\n  var dbDashboards;\n  dbDashboards = {};\n  Creator.Collections[\"dashboard\"].find({\n    space: space_id\n  }, {\n    fields: {\n      created: 0,\n      created_by: 0,\n      modified: 0,\n      modified_by: 0\n    }\n  }).forEach(function(dashboard) {\n    return dbDashboards[dashboard._id] = dashboard;\n  });\n  return dbDashboards;\n};\n\nif (Meteor.isServer) {\n  Cookies = require(\"cookies\");\n  Steedos.getAuthToken = function(req, res) {\n    var authToken, cookies;\n    cookies = new Cookies(req, res);\n    authToken = req.headers['x-auth-token'] || cookies.get(\"X-Auth-Token\");\n    if (!authToken && req.headers.authorization && req.headers.authorization.split(' ')[0] === 'Bearer') {\n      authToken = req.headers.authorization.split(' ')[1];\n    }\n    return authToken;\n  };\n}\n\nif (Meteor.isClient) {\n  Meteor.autorun(function() {\n    if (Session.get('current_app_id')) {\n      return sessionStorage.setItem('current_app_id', Session.get('current_app_id'));\n    }\n  });\n  Steedos.getCurrentAppId = function() {\n    if (Session.get('app_id')) {\n      return Session.get('app_id');\n    } else {\n      return sessionStorage.getItem('current_app_id');\n    }\n  };\n}\n\nif (Meteor.isServer) {\n  Steedos.formatIndex = function(array) {\n    var indexName, isdocumentDB, object, ref5, ref6, ref7;\n    object = {\n      background: true\n    };\n    isdocumentDB = ((ref5 = Meteor.settings) != null ? (ref6 = ref5.datasources) != null ? (ref7 = ref6[\"default\"]) != null ? ref7.documentDB : void 0 : void 0 : void 0) || false;\n    if (isdocumentDB) {\n      if (array.length > 0) {\n        indexName = array.join(\".\");\n        object.name = indexName;\n        if (indexName.length > 52) {\n          object.name = indexName.substring(0, 52);\n        }\n      }\n    }\n    return object;\n  };\n}\n","Meteor.startup(function () {\n\tSimpleSchema.extendOptions({foreign_key: Match.Optional(Boolean), references: Match.Optional(Object)});\n})","if Meteor.isServer\n        Meteor.methods\n                updateUserLastLogon: () ->\n                        if not @userId?\n                                return\n\n                        db.users.update({_id: @userId}, {$set: {last_logon: new Date()}})  \n\n\nif Meteor.isClient\n        Accounts.onLogin ()->\n            Meteor.call 'updateUserLastLogon'","if (Meteor.isServer) {\n  Meteor.methods({\n    updateUserLastLogon: function() {\n      if (this.userId == null) {\n        return;\n      }\n      return db.users.update({\n        _id: this.userId\n      }, {\n        $set: {\n          last_logon: new Date()\n        }\n      });\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  Accounts.onLogin(function() {\n    return Meteor.call('updateUserLastLogon');\n  });\n}\n","if Meteor.isServer\n  Meteor.methods\n    users_add_email: (email) ->\n      if not @userId?\n        return {error: true, message: \"email_login_required\"}\n      if not email\n        return {error: true, message: \"email_required\"}\n      if not /^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)\n        return {error: true, message: \"email_format_error\"}\n      if db.users.find({\"emails.address\": email}).count()>0\n        return {error: true, message: \"email_exists\"}\n\n      user = db.users.findOne(_id: this.userId)\n      if user.emails? and user.emails.length > 0 \n        db.users.direct.update {_id: this.userId}, \n          $push: \n            emails: \n              address: email\n              verified: false\n      else\n        db.users.direct.update {_id: this.userId}, \n          $set: \n            steedos_id: email\n            emails: [\n              address: email\n              verified: false\n            ]\n\n      Accounts.sendVerificationEmail(this.userId, email);\n\n      return {}\n\n    users_remove_email: (email) ->\n      if not @userId?\n        return {error: true, message: \"email_login_required\"}\n      if not email\n        return {error: true, message: \"email_required\"}\n\n      user = db.users.findOne(_id: this.userId)\n      if user.emails? and user.emails.length >= 2\n        p = null\n        user.emails.forEach (e)->\n          if e.address == email\n            p = e\n            return\n        \n        db.users.direct.update {_id: this.userId}, \n          $pull: \n            emails: \n              p\n      else\n        return {error: true, message: \"email_at_least_one\"}\n\n      return {}\n\n    users_verify_email: (email) ->\n      if not @userId?\n        return {error: true, message: \"email_login_required\"}\n      if not email\n        return {error: true, message: \"email_required\"}\n      if not /^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)\n        return {error: true, message: \"email_format_error\"}\n      \n\n      Accounts.sendVerificationEmail(this.userId, email);\n\n      return {}\n\n    users_set_primary_email: (email) ->\n      if not @userId?\n        return {error: true, message: \"email_login_required\"}\n      if not email\n        return {error: true, message: \"email_required\"}\n\n      user = db.users.findOne(_id: this.userId)\n      emails = user.emails\n      emails.forEach (e)->\n        if e.address == email\n          e.primary = true\n        else\n          e.primary = false\n\n      db.users.direct.update {_id: this.userId},\n        $set:\n          emails: emails\n          email: email\n\n      db.space_users.direct.update({user: this.userId},{$set: {email: email}}, {multi: true})\n      return {}\n\n\n\nif Meteor.isClient\n    Steedos.users_add_email = ()->\n        swal\n            title: t(\"primary_email_needed\"),\n            text: t(\"primary_email_needed_description\"),\n            type: 'input',\n            showCancelButton: false,\n            closeOnConfirm: false,\n            animation: \"slide-from-top\"\n        , (inputValue) ->\n            Meteor.call \"users_add_email\", inputValue, (error, result)->\n                if result?.error\n                    toastr.error result.message\n                else\n                    swal t(\"primary_email_updated\"), \"\", \"success\"\n###\n    Tracker.autorun (c) ->\n\n        if Meteor.user()\n          if Meteor.loggingIn()\n            # 正在登录中，则不做处理，因为此时Meteor.userId()不足于证明已登录状态\n            return\n          primaryEmail = Meteor.user().emails?[0]?.address\n          if !primaryEmail\n              Steedos.users_add_email();\n###","if (Meteor.isServer) {\n  Meteor.methods({\n    users_add_email: function(email) {\n      var user;\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      if (!/^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)) {\n        return {\n          error: true,\n          message: \"email_format_error\"\n        };\n      }\n      if (db.users.find({\n        \"emails.address\": email\n      }).count() > 0) {\n        return {\n          error: true,\n          message: \"email_exists\"\n        };\n      }\n      user = db.users.findOne({\n        _id: this.userId\n      });\n      if ((user.emails != null) && user.emails.length > 0) {\n        db.users.direct.update({\n          _id: this.userId\n        }, {\n          $push: {\n            emails: {\n              address: email,\n              verified: false\n            }\n          }\n        });\n      } else {\n        db.users.direct.update({\n          _id: this.userId\n        }, {\n          $set: {\n            steedos_id: email,\n            emails: [\n              {\n                address: email,\n                verified: false\n              }\n            ]\n          }\n        });\n      }\n      Accounts.sendVerificationEmail(this.userId, email);\n      return {};\n    },\n    users_remove_email: function(email) {\n      var p, user;\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      user = db.users.findOne({\n        _id: this.userId\n      });\n      if ((user.emails != null) && user.emails.length >= 2) {\n        p = null;\n        user.emails.forEach(function(e) {\n          if (e.address === email) {\n            p = e;\n          }\n        });\n        db.users.direct.update({\n          _id: this.userId\n        }, {\n          $pull: {\n            emails: p\n          }\n        });\n      } else {\n        return {\n          error: true,\n          message: \"email_at_least_one\"\n        };\n      }\n      return {};\n    },\n    users_verify_email: function(email) {\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      if (!/^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)) {\n        return {\n          error: true,\n          message: \"email_format_error\"\n        };\n      }\n      Accounts.sendVerificationEmail(this.userId, email);\n      return {};\n    },\n    users_set_primary_email: function(email) {\n      var emails, user;\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      user = db.users.findOne({\n        _id: this.userId\n      });\n      emails = user.emails;\n      emails.forEach(function(e) {\n        if (e.address === email) {\n          return e.primary = true;\n        } else {\n          return e.primary = false;\n        }\n      });\n      db.users.direct.update({\n        _id: this.userId\n      }, {\n        $set: {\n          emails: emails,\n          email: email\n        }\n      });\n      db.space_users.direct.update({\n        user: this.userId\n      }, {\n        $set: {\n          email: email\n        }\n      }, {\n        multi: true\n      });\n      return {};\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  Steedos.users_add_email = function() {\n    return swal({\n      title: t(\"primary_email_needed\"),\n      text: t(\"primary_email_needed_description\"),\n      type: 'input',\n      showCancelButton: false,\n      closeOnConfirm: false,\n      animation: \"slide-from-top\"\n    }, function(inputValue) {\n      return Meteor.call(\"users_add_email\", inputValue, function(error, result) {\n        if (result != null ? result.error : void 0) {\n          return toastr.error(result.message);\n        } else {\n          return swal(t(\"primary_email_updated\"), \"\", \"success\");\n        }\n      });\n    });\n  };\n}\n\n\n/*\n    Tracker.autorun (c) ->\n\n        if Meteor.user()\n          if Meteor.loggingIn()\n             * 正在登录中，则不做处理，因为此时Meteor.userId()不足于证明已登录状态\n            return\n          primaryEmail = Meteor.user().emails?[0]?.address\n          if !primaryEmail\n              Steedos.users_add_email();\n */\n","if Meteor.isServer\n    Meteor.methods\n        updateUserAvatar: (avatar) ->\n                if not @userId?\n                        return\n\n                db.users.update({_id: @userId}, {$set: {avatar: avatar}})  ","if (Meteor.isServer) {\n  Meteor.methods({\n    updateUserAvatar: function(avatar) {\n      if (this.userId == null) {\n        return;\n      }\n      return db.users.update({\n        _id: this.userId\n      }, {\n        $set: {\n          avatar: avatar\n        }\n      });\n    }\n  });\n}\n","Accounts.emailTemplates = {\n\tfrom: (function(){\n\t\tvar defaultFrom = \"Steedos <noreply@message.steedos.com>\";\n\t\tif(!Meteor.settings)\n\t\t\treturn defaultFrom;\n\t\t\n\t\tif(!Meteor.settings.email)\n\t\t\treturn defaultFrom;\n\n\t\tif(!Meteor.settings.email.from)\n\t\t\treturn defaultFrom;\n\t\t\n\t\treturn Meteor.settings.email.from;\n\t})(),\n\tresetPassword: {\n\t\tsubject: function (user) {\n\t\t\treturn TAPi18n.__(\"users_email_reset_password\",{},user.locale);\n\t\t},\n\t\ttext: function (user, url) {\n\t\t\tvar splits = url.split(\"/\");\n\t\t\tvar tokenCode = splits[splits.length-1];\n\t\t\tvar greeting = user.profile && user.profile.name ? TAPi18n.__(\"users_email_hello\",{},user.locale) + user.profile.name + \",\" : TAPi18n.__(\"users_email_hello\",{},user.locale) + \",\";\n\t\t\treturn greeting + \"\\n\\n\" + TAPi18n.__(\"users_email_reset_password_body\",{token_code:tokenCode},user.locale) + \"\\n\\n\" + url + \"\\n\\n\" + TAPi18n.__(\"users_email_thanks\",{},user.locale) + \"\\n\";\n\t\t}\n\t},\n\tverifyEmail: {\n\t\tsubject: function (user) {\n\t\t\treturn TAPi18n.__(\"users_email_verify_email\",{},user.locale);\n\t\t},\n\t\ttext: function (user, url) {\n\t\t\tvar greeting = user.profile && user.profile.name ? TAPi18n.__(\"users_email_hello\",{},user.locale) + user.profile.name + \",\" : TAPi18n.__(\"users_email_hello\",{},user.locale) + \",\";\n\t\t\treturn greeting + \"\\n\\n\" + TAPi18n.__(\"users_email_verify_account\",{},user.locale) + \"\\n\\n\" + url + \"\\n\\n\" + TAPi18n.__(\"users_email_thanks\",{},user.locale) + \"\\n\";\n\t\t}\n\t},\n\tenrollAccount: {\n\t\tsubject: function (user) {\n\t\t\treturn TAPi18n.__(\"users_email_create_account\",{},user.locale);\n\t\t},\n\t\ttext: function (user, url) {\n\t\t\tvar greeting = user.profile && user.profile.name ? TAPi18n.__(\"users_email_hello\",{},user.locale) + user.profile.name + \",\" : TAPi18n.__(\"users_email_hello\",{},user.locale) + \",\";\n\t\t\treturn greeting + \"\\n\\n\" + TAPi18n.__(\"users_email_start_service\",{},user.locale) + \"\\n\\n\" + url + \"\\n\\n\" + TAPi18n.__(\"users_email_thanks\",{},user.locale) + \"\\n\";\n\t\t}\n\t}\n};","// 修改fullname值有问题的organizations\nJsonRoutes.add(\"get\", \"/api/organizations/upgrade/\", function (req, res, next) {\n  \n\tvar orgs = db.organizations.find({fullname:/新部门/,name:{$ne:\"新部门\"}});\n\tif (orgs.count()>0)\n\t{\n\t\torgs.forEach (function (org)\n\t\t{\n\t\t\t// 自己和子部门的fullname修改\n\t\t\tdb.organizations.direct.update(org._id, {$set: {fullname: org.calculateFullname()}});\n\t\t\t\n\t\t});\n\t}\t\n\n  \tJsonRoutes.sendResult(res, {\n    \tdata: {\n\t      \tret: 0,\n\t      \tmsg: \"Successfully\"\n    \t}\n  \t});\n});\n\n","if Meteor.isCordova\n        Meteor.startup ->\n                Push.Configure\n                        android:\n                                senderID: window.ANDROID_SENDER_ID\n                                sound: true\n                                vibrate: true\n                        ios:\n                                badge: true\n                                clearBadge: true\n                                sound: true\n                                alert: true\n                        appName: \"workflow\"\n","if (Meteor.isCordova) {\n  Meteor.startup(function() {\n    return Push.Configure({\n      android: {\n        senderID: window.ANDROID_SENDER_ID,\n        sound: true,\n        vibrate: true\n      },\n      ios: {\n        badge: true,\n        clearBadge: true,\n        sound: true,\n        alert: true\n      },\n      appName: \"workflow\"\n    });\n  });\n}\n","Selector = {}\n\n# Filter data on server by space field\nSelector.selectorCheckSpaceAdmin = (userId) ->\n\tif Meteor.isClient\n\t\tuserId = Meteor.userId()\n\t\tunless userId\n\t\t\treturn {_id: -1}\n\t\tif Steedos.isSpaceAdmin()\n\t\t\treturn {space: Session.get(\"spaceId\")}\n\t\telse\n\t\t\treturn {_id: -1}\n\n\tif Meteor.isServer\n\t\tunless userId\n\t\t\treturn {_id: -1}\n\t\tuser = db.users.findOne(userId, {fields: {is_cloudadmin: 1}})\n\t\tif !user\n\t\t\treturn {_id: -1}\n\t\tselector = {}\n\t\tif !user.is_cloudadmin\n\t\t\tspaces = db.spaces.find({admins:{$in:[userId]}}, {fields: {_id: 1}}).fetch()\n\t\t\tspaces = spaces.map (n) -> return n._id\n\t\t\tselector.space = {$in: spaces}\n\t\treturn selector\n\n# Filter data on server by space field\nSelector.selectorCheckSpace = (userId) ->\n\tif Meteor.isClient\n\t\tuserId = Meteor.userId()\n\t\tunless userId\n\t\t\treturn {_id: -1}\n\t\tspaceId = Session.get(\"spaceId\");\n\t\tif spaceId\n\t\t\tif db.space_users.findOne({user: userId,space: spaceId}, {fields: {_id: 1}})\n\t\t\t\treturn {space: spaceId}\n\t\t\telse\n\t\t\t\treturn {_id: -1}\n\t\telse\n\t\t\treturn {_id: -1}\n\n\tif Meteor.isServer\n\t\tunless userId\n\t\t\treturn {_id: -1}\n\t\tuser = db.users.findOne(userId, {fields: {_id: 1}})\n\t\tif !user\n\t\t\treturn {_id: -1}\n\t\tselector = {}\n\t\tspace_users = db.space_users.find({user: userId}, {fields: {space: 1}}).fetch()\n\t\tspaces = []\n\t\t_.each space_users, (u)->\n\t\t\tspaces.push(u.space)\n\t\tselector.space = {$in: spaces}\n\t\treturn selector\n\ndb.billing_pay_records.adminConfig =\n\ticon: \"globe\"\n\tcolor: \"blue\"\n\ttableColumns: [\n\t\t{name: \"order_created()\"},\n\t\t{name: \"modules\"},\n\t\t{name: \"user_count\"},\n\t\t{name: \"end_date\"},\n\t\t{name: \"order_total_fee()\"},\n\t\t{name: \"order_paid()\"}\n\t]\n\textraFields: [\"space\", \"created\", \"paid\", \"total_fee\"]\n\trouterAdmin: \"/admin\"\n\tselector: (userId) ->\n\t\tif Meteor.isClient\n\t\t\tif Steedos.isSpaceAdmin()\n\t\t\t\treturn {space: Session.get(\"spaceId\"), paid: true}\n\t\t\telse\n\t\t\t\treturn {_id: -1}\n\n\t\tif Meteor.isServer\n\t\t\treturn {}\n\tshowEditColumn: false\n\tshowDelColumn: false\n\tdisableAdd: true\n\tpageLength: 100\n\torder: [[0, \"desc\"]]\n\nMeteor.startup ->\n\t@space_user_signs = db.space_user_signs\n\t@billing_pay_records = db.billing_pay_records\n\tAdminConfig?.collections_add\n\t\tspace_user_signs: db.space_user_signs.adminConfig\n\t\tbilling_pay_records: db.billing_pay_records.adminConfig","             \n\nSelector = {};\n\nSelector.selectorCheckSpaceAdmin = function(userId) {\n  var selector, spaces, user;\n  if (Meteor.isClient) {\n    userId = Meteor.userId();\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    if (Steedos.isSpaceAdmin()) {\n      return {\n        space: Session.get(\"spaceId\")\n      };\n    } else {\n      return {\n        _id: -1\n      };\n    }\n  }\n  if (Meteor.isServer) {\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    user = db.users.findOne(userId, {\n      fields: {\n        is_cloudadmin: 1\n      }\n    });\n    if (!user) {\n      return {\n        _id: -1\n      };\n    }\n    selector = {};\n    if (!user.is_cloudadmin) {\n      spaces = db.spaces.find({\n        admins: {\n          $in: [userId]\n        }\n      }, {\n        fields: {\n          _id: 1\n        }\n      }).fetch();\n      spaces = spaces.map(function(n) {\n        return n._id;\n      });\n      selector.space = {\n        $in: spaces\n      };\n    }\n    return selector;\n  }\n};\n\nSelector.selectorCheckSpace = function(userId) {\n  var selector, spaceId, space_users, spaces, user;\n  if (Meteor.isClient) {\n    userId = Meteor.userId();\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    spaceId = Session.get(\"spaceId\");\n    if (spaceId) {\n      if (db.space_users.findOne({\n        user: userId,\n        space: spaceId\n      }, {\n        fields: {\n          _id: 1\n        }\n      })) {\n        return {\n          space: spaceId\n        };\n      } else {\n        return {\n          _id: -1\n        };\n      }\n    } else {\n      return {\n        _id: -1\n      };\n    }\n  }\n  if (Meteor.isServer) {\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    user = db.users.findOne(userId, {\n      fields: {\n        _id: 1\n      }\n    });\n    if (!user) {\n      return {\n        _id: -1\n      };\n    }\n    selector = {};\n    space_users = db.space_users.find({\n      user: userId\n    }, {\n      fields: {\n        space: 1\n      }\n    }).fetch();\n    spaces = [];\n    _.each(space_users, function(u) {\n      return spaces.push(u.space);\n    });\n    selector.space = {\n      $in: spaces\n    };\n    return selector;\n  }\n};\n\ndb.billing_pay_records.adminConfig = {\n  icon: \"globe\",\n  color: \"blue\",\n  tableColumns: [\n    {\n      name: \"order_created()\"\n    }, {\n      name: \"modules\"\n    }, {\n      name: \"user_count\"\n    }, {\n      name: \"end_date\"\n    }, {\n      name: \"order_total_fee()\"\n    }, {\n      name: \"order_paid()\"\n    }\n  ],\n  extraFields: [\"space\", \"created\", \"paid\", \"total_fee\"],\n  routerAdmin: \"/admin\",\n  selector: function(userId) {\n    if (Meteor.isClient) {\n      if (Steedos.isSpaceAdmin()) {\n        return {\n          space: Session.get(\"spaceId\"),\n          paid: true\n        };\n      } else {\n        return {\n          _id: -1\n        };\n      }\n    }\n    if (Meteor.isServer) {\n      return {};\n    }\n  },\n  showEditColumn: false,\n  showDelColumn: false,\n  disableAdd: true,\n  pageLength: 100,\n  order: [[0, \"desc\"]]\n};\n\nMeteor.startup(function() {\n  this.space_user_signs = db.space_user_signs;\n  this.billing_pay_records = db.billing_pay_records;\n  return typeof AdminConfig !== \"undefined\" && AdminConfig !== null ? AdminConfig.collections_add({\n    space_user_signs: db.space_user_signs.adminConfig,\n    billing_pay_records: db.billing_pay_records.adminConfig\n  }) : void 0;\n});\n","if (![].includes) {\n  Array.prototype.includes = function(searchElement /*, fromIndex*/ ) {\n    'use strict';\n    var O = Object(this);\n    var len = parseInt(O.length) || 0;\n    if (len === 0) {\n      return false;\n    }\n    var n = parseInt(arguments[1]) || 0;\n    var k;\n    if (n >= 0) {\n      k = n;\n    } else {\n      k = len + n;\n      if (k < 0) {k = 0;}\n    }\n    var currentElement;\n    while (k < len) {\n      currentElement = O[k];\n      if (searchElement === currentElement ||\n         (searchElement !== searchElement && currentElement !== currentElement)) {\n        return true;\n      }\n      k++;\n    }\n    return false;\n  };\n}","Meteor.startup ->\n  Steedos.settings.webservices = Meteor.settings.public.webservices\n\n  if !Steedos.settings.webservices\n    Steedos.settings.webservices =\n      www: \n        status: \"active\",\n        url: \"/\"","Meteor.startup(function() {\n  Steedos.settings.webservices = Meteor.settings[\"public\"].webservices;\n  if (!Steedos.settings.webservices) {\n    return Steedos.settings.webservices = {\n      www: {\n        status: \"active\",\n        url: \"/\"\n      }\n    };\n  }\n});\n","Creator.getUserObjectsListViews = (userId, spaceId, objects)->\n\tlistViews = {}\n\n\tkeys = _.keys(objects)\n\n\tobjectsViews = Creator.getCollection(\"object_listviews\").find({\n\t\tobject_name: {$in: keys},\n\t\tspace: spaceId,\n\t\t\"$or\": [{owner: userId}, {shared: true}]\n\t}, {\n\t\tfields: {\n\t\t\tcreated: 0,\n\t\t\tmodified: 0,\n\t\t\tcreated_by: 0,\n\t\t\tmodified_by: 0\n\t\t}\n\t}).fetch()\n\n\t_getUserObjectListViews = (object_name)->\n\t\t_user_object_list_views = {}\n\t\tolistViews = _.filter objectsViews, (ov)->\n\t\t\treturn ov.object_name == object_name\n\n\t\t_.each olistViews, (listview)->\n\t\t\t_user_object_list_views[listview._id] = listview\n\n\t\treturn _user_object_list_views\n\n\t_.forEach objects, (o, key)->\n\t\tlist_view = _getUserObjectListViews(key)\n\t\tif !_.isEmpty(list_view)\n\t\t\tlistViews[key] = list_view\n\treturn listViews\n\n\nCreator.getUserObjectListViews = (userId, spaceId, object_name)->\n\t_user_object_list_views = {}\n\n\tobject_listview = Creator.getCollection(\"object_listviews\").find({\n\t\tobject_name: object_name,\n\t\tspace: spaceId,\n\t\t\"$or\": [{owner: userId}, {shared: true}]\n\t}, {\n\t\tfields: {\n\t\t\tcreated: 0,\n\t\t\tmodified: 0,\n\t\t\tcreated_by: 0,\n\t\t\tmodified_by: 0\n\t\t}\n\t})\n\n\tobject_listview.forEach (listview)->\n\t\t_user_object_list_views[listview._id] = listview\n\n\treturn _user_object_list_views\n\n\n\n\n","Creator.getUserObjectsListViews = function(userId, spaceId, objects) {\n  var _getUserObjectListViews, keys, listViews, objectsViews;\n  listViews = {};\n  keys = _.keys(objects);\n  objectsViews = Creator.getCollection(\"object_listviews\").find({\n    object_name: {\n      $in: keys\n    },\n    space: spaceId,\n    \"$or\": [\n      {\n        owner: userId\n      }, {\n        shared: true\n      }\n    ]\n  }, {\n    fields: {\n      created: 0,\n      modified: 0,\n      created_by: 0,\n      modified_by: 0\n    }\n  }).fetch();\n  _getUserObjectListViews = function(object_name) {\n    var _user_object_list_views, olistViews;\n    _user_object_list_views = {};\n    olistViews = _.filter(objectsViews, function(ov) {\n      return ov.object_name === object_name;\n    });\n    _.each(olistViews, function(listview) {\n      return _user_object_list_views[listview._id] = listview;\n    });\n    return _user_object_list_views;\n  };\n  _.forEach(objects, function(o, key) {\n    var list_view;\n    list_view = _getUserObjectListViews(key);\n    if (!_.isEmpty(list_view)) {\n      return listViews[key] = list_view;\n    }\n  });\n  return listViews;\n};\n\nCreator.getUserObjectListViews = function(userId, spaceId, object_name) {\n  var _user_object_list_views, object_listview;\n  _user_object_list_views = {};\n  object_listview = Creator.getCollection(\"object_listviews\").find({\n    object_name: object_name,\n    space: spaceId,\n    \"$or\": [\n      {\n        owner: userId\n      }, {\n        shared: true\n      }\n    ]\n  }, {\n    fields: {\n      created: 0,\n      modified: 0,\n      created_by: 0,\n      modified_by: 0\n    }\n  });\n  object_listview.forEach(function(listview) {\n    return _user_object_list_views[listview._id] = listview;\n  });\n  return _user_object_list_views;\n};\n","// ServerSession = (function () {\n//   'use strict';\n\n//   var Collection = new Mongo.Collection('server_sessions');\n\n//   var checkForKey = function (key) {\n//     if (typeof key === 'undefined') {\n//       throw new Error('Please provide a key!');\n//     }\n//   };\n//   var getSessionValue = function (obj, key) {\n//     return obj && obj.values && obj.values[key];\n//   };\n//   var condition = function () {\n//     return true;\n//   };\n\n//   Collection.deny({\n//     'insert': function () {\n//       return true;\n//     },\n//     'update' : function () {\n//       return true;\n//     },\n//     'remove': function () {\n//       return true;\n//     }\n//   });\n\n//   // public client and server api\n//   var api = {\n//     'get': function (key) {\n//       console.log(Collection.findOne());\n//       var sessionObj = Collection.findOne();\n//       if(Meteor.isServer){\n//         Meteor.call('server-session/get');\n//       }\n//       // var sessionObj = Meteor.isServer ? \n//       //   Meteor.call('server-session/get') : Collection.findOne();\n//       return getSessionValue(sessionObj, key);\n//     },\n//     'equals': function (key, expected, identical) {\n//       var sessionObj = Meteor.isServer ? \n//         Meteor.call('server-session/get') : Collection.findOne();\n\n//       var value = getSessionValue(sessionObj, key);\n\n//       if (_.isObject(value) && _.isObject(expected)) {\n//         return _(value).isEqual(expected);\n//       }\n\n//       if (identical == false) {\n//         return expected == value;\n//       }\n\n//       return expected === value;\n//     }\n//   };\n\n//   Meteor.startup(function(){\n//     if (Meteor.isClient) {\n//       Tracker.autorun(function(){\n//         if(Meteor.userId()){\n//           Meteor.subscribe('server-session');\n//         }\n//       })\n//     }\n//   })\n\n//   if (Meteor.isServer) {\n//     // Meteor.startup(function () {\n//     //   if (Collection.findOne()) {\n//     //     Collection.remove({}); // clear out all stale sessions\n//     //   }\n//     // });\n\n//     Meteor.onConnection(function (connection) {\n//       var clientID = connection.id;\n\n//       if (!Collection.findOne({ 'clientID': clientID })) {\n//         Collection.insert({ 'clientID': clientID, 'values': {}, \"created\": new Date() });\n//       }\n\n//       connection.onClose(function () {\n//         Collection.remove({ 'clientID': clientID });\n//       });\n//     });\n\n//     Meteor.publish('server-session', function () {\n//       return Collection.find({ 'clientID': this.connection.id });\n//     });\n\n//     Meteor.methods({\n//       'server-session/get': function () {\n//         return Collection.findOne({ 'clientID': this.connection.id });\n//       },\n//       'server-session/set': function (key, value) {\n//         if (!this.randomSeed) return;\n\n//         checkForKey(key);\n\n//         if (!condition(key, value))\n//           throw new Meteor.Error('Failed condition validation.');\n\n//         var updateObj = {};\n//         updateObj['values.' + key] = value;\n\n//         Collection.update({ 'clientID': this.connection.id }, { $set: updateObj });\n//       }\n//     });  \n\n//     // server-only api\n//     _.extend(api, {\n//       'set': function (key, value) {\n//         Meteor.call('server-session/set', key, value);          \n//       },\n//       'setCondition': function (newCondition) {\n//         condition = newCondition;\n//       }\n//     });\n//   }\n\n//   return api;\n// })();","JsonRoutes.add 'get', '/api/get/apps', (req, res, next) ->\n\ttry\n\t\tuser_id = req.headers['x-user-id'] || req.query?.userId\n\n\t\tspace_id = req.headers['x-space-id'] || req.query?.spaceId\n\n\t\tuser = Steedos.getAPILoginUser(req, res)\n\t\t\n\t\tif !user\n\t\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 401,\n\t\t\t\tdata:\n\t\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\n\t\t\t\t\t\"success\": false\n\t\t\treturn;\n\n\t\tuser_id = user._id\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\n\t\tlocale = db.users.findOne({_id:user_id}).locale\n\t\tif locale == \"en-us\"\n\t\t\tlocale = \"en\"\n\t\tif locale == \"zh-cn\"\n\t\t\tlocale = \"zh-CN\"\n\n\t\tspaces = db.space_users.find({user: user_id}).fetch().getProperty(\"space\")\n\t\tapps = db.apps.find({$or: [{space: {$exists: false}}, {space: {$in:spaces}}]},{sort:{sort:1}}).fetch()\n\n\t\tapps.forEach (app) ->\n\t\t\tapp.name = TAPi18n.__(app.name,{},locale)\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: apps}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n\t\n\t\t","JsonRoutes.add('get', '/api/get/apps', function(req, res, next) {\n  var apps, e, locale, ref, ref1, space_id, spaces, user, user_id;\n  try {\n    user_id = req.headers['x-user-id'] || ((ref = req.query) != null ? ref.userId : void 0);\n    space_id = req.headers['x-space-id'] || ((ref1 = req.query) != null ? ref1.spaceId : void 0);\n    user = Steedos.getAPILoginUser(req, res);\n    if (!user) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    user_id = user._id;\n    uuflowManager.getSpace(space_id);\n    locale = db.users.findOne({\n      _id: user_id\n    }).locale;\n    if (locale === \"en-us\") {\n      locale = \"en\";\n    }\n    if (locale === \"zh-cn\") {\n      locale = \"zh-CN\";\n    }\n    spaces = db.space_users.find({\n      user: user_id\n    }).fetch().getProperty(\"space\");\n    apps = db.apps.find({\n      $or: [\n        {\n          space: {\n            $exists: false\n          }\n        }, {\n          space: {\n            $in: spaces\n          }\n        }\n      ]\n    }, {\n      sort: {\n        sort: 1\n      }\n    }).fetch();\n    apps.forEach(function(app) {\n      return app.name = TAPi18n.__(app.name, {}, locale);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: apps\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","Cookies = require(\"cookies\")\nsteedosAuth = require(\"@steedos/auth\")\n\nJsonRoutes.add \"post\", \"/api/collection/find\", (req, res, next) ->\n    try\n        cookies = new Cookies( req, res )\n        authToken = req.body[\"X-Auth-Token\"] || cookies.get(\"X-Auth-Token\")\n\n        if !authToken\n            JsonRoutes.sendResult res,\n            code: 401,\n            data:\n                \"error\": \"Validate Request -- Missing X-Auth-Token\",\n                \"instance\": \"1329598861\",\n                \"success\": false\n            return\n\n        model = req.body.model\n        selector = req.body.selector\n        options = req.body.options\n        space = req.body.space\n        data = []\n        allow_models = ['space_users', 'organizations', 'flow_roles', 'roles']\n\n        if !space\n            JsonRoutes.sendResult res,\n            code: 403,\n            data:\n                \"error\": \"invalid space \" + space,\n                \"success\": false\n            return\n\n        # 用户登录验证\n        check(space, String)\n        check(authToken, String)\n        userSession = Meteor.wrapAsync((authToken, spaceId, cb) ->\n            steedosAuth.getSession(authToken, spaceId).then (resolve, reject) ->\n                cb(reject, resolve)\n            )(authToken, space)\n        unless userSession\n            JsonRoutes.sendResult res,\n                code: 500,\n                data:\n                    \"error\": \"auth failed\",\n                    \"success\": false\n            return\n        userId = userSession.userId\n\n        if !allow_models.includes(model)\n            JsonRoutes.sendResult res,\n            code: 403,\n            data:\n                \"error\": \"invalid model \" + model,\n                \"success\": false\n            return\n\n        if !db[model]\n            JsonRoutes.sendResult res,\n            code: 403,\n            data:\n                \"error\": \"invalid model \" + model,\n                \"success\": false\n            return\n\n        if !selector\n            selector = {}\n\n        if !options\n            options = {}\n\n        selector.space = space\n\n        data = db[model].find(selector, options).fetch()\n\n        JsonRoutes.sendResult res,\n            code: 200,\n            data: data\n    catch e\n        console.error e.stack\n        JsonRoutes.sendResult res,\n            code: 200,\n            data: []\n\n\nJsonRoutes.add \"post\", \"/api/collection/findone\", (req, res, next) ->\n    try\n        cookies = new Cookies( req, res )\n        authToken = req.body[\"X-Auth-Token\"] || cookies.get(\"X-Auth-Token\")\n\n        if !authToken\n            JsonRoutes.sendResult res,\n            code: 401,\n            data:\n                \"error\": \"Validate Request -- Missing X-Auth-Token\",\n                \"instance\": \"1329598861\",\n                \"success\": false\n            return\n\n        model = req.body.model\n        selector = req.body.selector\n        options = req.body.options\n        space = req.body.space\n        data = []\n        allow_models = ['space_users', 'organizations', 'flow_roles', 'mail_accounts', 'roles']\n\n        if !space\n            JsonRoutes.sendResult res,\n            code: 403,\n            data:\n                \"error\": \"invalid space \" + space,\n                \"success\": false\n            return\n\n        # 用户登录验证\n        check(space, String)\n        check(authToken, String)\n        userSession = Meteor.wrapAsync((authToken, spaceId, cb) ->\n            steedosAuth.getSession(authToken, spaceId).then (resolve, reject) ->\n                cb(reject, resolve)\n            )(authToken, space)\n        unless userSession\n            JsonRoutes.sendResult res,\n                code: 500,\n                data:\n                    \"error\": \"auth failed\",\n                    \"success\": false\n            return\n        userId = userSession.userId\n\n        if !allow_models.includes(model)\n            JsonRoutes.sendResult res,\n            code: 403,\n            data:\n                \"error\": \"invalid model \" + model,\n                \"success\": false\n            return\n\n        if !db[model]\n            JsonRoutes.sendResult res,\n            code: 403,\n            data:\n                \"error\": \"invalid model \" + model,\n                \"success\": false\n            return\n\n        if !selector\n            selector = {}\n\n        if !options\n            options = {}\n\n        if model == 'mail_accounts'\n            selector = {}\n            selector.owner = userId\n            data = db[model].findOne(selector)\n        else\n            selector.space = space\n\n            data = db[model].findOne(selector, options)\n\n        JsonRoutes.sendResult res,\n            code: 200,\n            data: data\n    catch e\n        console.error e.stack\n        JsonRoutes.sendResult res,\n            code: 200,\n            data: {}\n","var Cookies, steedosAuth;\n\nCookies = require(\"cookies\");\n\nsteedosAuth = require(\"@steedos/auth\");\n\nJsonRoutes.add(\"post\", \"/api/collection/find\", function(req, res, next) {\n  var allow_models, authToken, cookies, data, e, model, options, selector, space, userId, userSession;\n  try {\n    cookies = new Cookies(req, res);\n    authToken = req.body[\"X-Auth-Token\"] || cookies.get(\"X-Auth-Token\");\n    if (!authToken) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing X-Auth-Token\",\n          \"instance\": \"1329598861\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    model = req.body.model;\n    selector = req.body.selector;\n    options = req.body.options;\n    space = req.body.space;\n    data = [];\n    allow_models = ['space_users', 'organizations', 'flow_roles', 'roles'];\n    if (!space) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid space \" + space,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    check(space, String);\n    check(authToken, String);\n    userSession = Meteor.wrapAsync(function(authToken, spaceId, cb) {\n      return steedosAuth.getSession(authToken, spaceId).then(function(resolve, reject) {\n        return cb(reject, resolve);\n      });\n    })(authToken, space);\n    if (!userSession) {\n      JsonRoutes.sendResult(res, {\n        code: 500,\n        data: {\n          \"error\": \"auth failed\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    userId = userSession.userId;\n    if (!allow_models.includes(model)) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!db[model]) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!selector) {\n      selector = {};\n    }\n    if (!options) {\n      options = {};\n    }\n    selector.space = space;\n    data = db[model].find(selector, options).fetch();\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: data\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: []\n    });\n  }\n});\n\nJsonRoutes.add(\"post\", \"/api/collection/findone\", function(req, res, next) {\n  var allow_models, authToken, cookies, data, e, model, options, selector, space, userId, userSession;\n  try {\n    cookies = new Cookies(req, res);\n    authToken = req.body[\"X-Auth-Token\"] || cookies.get(\"X-Auth-Token\");\n    if (!authToken) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing X-Auth-Token\",\n          \"instance\": \"1329598861\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    model = req.body.model;\n    selector = req.body.selector;\n    options = req.body.options;\n    space = req.body.space;\n    data = [];\n    allow_models = ['space_users', 'organizations', 'flow_roles', 'mail_accounts', 'roles'];\n    if (!space) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid space \" + space,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    check(space, String);\n    check(authToken, String);\n    userSession = Meteor.wrapAsync(function(authToken, spaceId, cb) {\n      return steedosAuth.getSession(authToken, spaceId).then(function(resolve, reject) {\n        return cb(reject, resolve);\n      });\n    })(authToken, space);\n    if (!userSession) {\n      JsonRoutes.sendResult(res, {\n        code: 500,\n        data: {\n          \"error\": \"auth failed\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    userId = userSession.userId;\n    if (!allow_models.includes(model)) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!db[model]) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!selector) {\n      selector = {};\n    }\n    if (!options) {\n      options = {};\n    }\n    if (model === 'mail_accounts') {\n      selector = {};\n      selector.owner = userId;\n      data = db[model].findOne(selector);\n    } else {\n      selector.space = space;\n      data = db[model].findOne(selector, options);\n    }\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: data\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  }\n});\n","crypto = require('crypto')\nCookies = require(\"cookies\")\nexpress = require(\"express\")\n\nJsonRoutes.add \"get\", \"/api/setup/sso/:app_id\", (req, res, next) ->\n\n\tapp = db.apps.findOne(req.params.app_id)\n\tif app\n\t\tsecret = app.secret\n\t\tredirectUrl = app.url\n\telse\n\t\tsecret = \"-8762-fcb369b2e8\"\n\t\tredirectUrl = req.params.redirectUrl\n\n\tif !redirectUrl\n\t\tres.writeHead 401\n\t\tres.end()\n\t\treturn\n\n\tcookies = new Cookies( req, res );\n\n\t# first check request body\n\t# if req.body\n\t# \tuserId = req.body[\"X-User-Id\"]\n\t# \tauthToken = req.body[\"X-Auth-Token\"]\n\n\t# # then check cookie\n\t# if !userId or !authToken\n\t# \tuserId = cookies.get(\"X-User-Id\")\n\t# \tauthToken = cookies.get(\"X-Auth-Token\")\n\n\tif !userId and !authToken\n\t\tuserId = req.query[\"X-User-Id\"]\n\t\tauthToken = req.query[\"X-Auth-Token\"]\n\n\tif userId and authToken\n\t\thashedToken = Accounts._hashLoginToken(authToken)\n\t\tuser = Meteor.users.findOne\n\t\t\t_id: userId,\n\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\n\t\tif user\n\t\t\tsteedos_id = user.steedos_id\n\t\t\tif app.secret\n\t\t\t\tiv = app.secret\n\t\t\telse\n\t\t\t\tiv = \"-8762-fcb369b2e8\"\n\t\t\tnow = parseInt(new Date().getTime()/1000).toString()\n\t\t\tkey32 = \"\"\n\t\t\tlen = steedos_id.length\n\t\t\tif len < 32\n\t\t\t\tc = \"\"\n\t\t\t\ti = 0\n\t\t\t\tm = 32 - len\n\t\t\t\twhile i < m\n\t\t\t\t\tc = \" \" + c\n\t\t\t\t\ti++\n\t\t\t\tkey32 = steedos_id + c\n\t\t\telse if len >= 32\n\t\t\t\tkey32 = steedos_id.slice(0,32)\n\n\t\t\tcipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\n\n\t\t\tcipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()])\n\n\t\t\tsteedos_token = cipheredMsg.toString('base64')\n\n\t\t\t# des-cbc\n\t\t\tdes_iv = \"-8762-fc\"\n\t\t\tkey8 = \"\"\n\t\t\tlen = steedos_id.length\n\t\t\tif len < 8\n\t\t\t\tc = \"\"\n\t\t\t\ti = 0\n\t\t\t\tm = 8 - len\n\t\t\t\twhile i < m\n\t\t\t\t\tc = \" \" + c\n\t\t\t\t\ti++\n\t\t\t\tkey8 = steedos_id + c\n\t\t\telse if len >= 8\n\t\t\t\tkey8 = steedos_id.slice(0,8)\n\t\t\tdes_cipher = crypto.createCipheriv('des-cbc', new Buffer(key8, 'utf8'), new Buffer(des_iv, 'utf8'))\n\t\t\tdes_cipheredMsg = Buffer.concat([des_cipher.update(new Buffer(now, 'utf8')), des_cipher.final()])\n\t\t\tdes_steedos_token = des_cipheredMsg.toString('base64')\n\n\t\t\tjoiner = \"?\"\n\n\t\t\tif redirectUrl.indexOf(\"?\") > -1\n\t\t\t\tjoiner = \"&\"\n\n\t\t\treturnurl = redirectUrl + joiner + \"X-User-Id=\" + userId + \"&X-Auth-Token=\" + authToken + \"&X-STEEDOS-WEB-ID=\" + steedos_id + \"&X-STEEDOS-AUTHTOKEN=\" + steedos_token + \"&STEEDOS-AUTHTOKEN=\" + des_steedos_token\n\n\t\t\tif user.username\n\t\t\t\treturnurl += \"&X-STEEDOS-USERNAME=#{encodeURI(user.username)}\"\n\t\t\tres.setHeader \"Location\", returnurl\n\t\t\tres.writeHead 302\n\t\t\tres.end()\n\t\t\treturn\n\n\tres.writeHead 401\n\tres.end()\n\treturn\n","var Cookies, crypto, express;\n\ncrypto = require('crypto');\n\nCookies = require(\"cookies\");\n\nexpress = require(\"express\");\n\nJsonRoutes.add(\"get\", \"/api/setup/sso/:app_id\", function(req, res, next) {\n  var app, authToken, c, cipher, cipheredMsg, cookies, des_cipher, des_cipheredMsg, des_iv, des_steedos_token, hashedToken, i, iv, joiner, key32, key8, len, m, now, redirectUrl, returnurl, secret, steedos_id, steedos_token, user, userId;\n  app = db.apps.findOne(req.params.app_id);\n  if (app) {\n    secret = app.secret;\n    redirectUrl = app.url;\n  } else {\n    secret = \"-8762-fcb369b2e8\";\n    redirectUrl = req.params.redirectUrl;\n  }\n  if (!redirectUrl) {\n    res.writeHead(401);\n    res.end();\n    return;\n  }\n  cookies = new Cookies(req, res);\n  if (!userId && !authToken) {\n    userId = req.query[\"X-User-Id\"];\n    authToken = req.query[\"X-Auth-Token\"];\n  }\n  if (userId && authToken) {\n    hashedToken = Accounts._hashLoginToken(authToken);\n    user = Meteor.users.findOne({\n      _id: userId,\n      \"services.resume.loginTokens.hashedToken\": hashedToken\n    });\n    if (user) {\n      steedos_id = user.steedos_id;\n      if (app.secret) {\n        iv = app.secret;\n      } else {\n        iv = \"-8762-fcb369b2e8\";\n      }\n      now = parseInt(new Date().getTime() / 1000).toString();\n      key32 = \"\";\n      len = steedos_id.length;\n      if (len < 32) {\n        c = \"\";\n        i = 0;\n        m = 32 - len;\n        while (i < m) {\n          c = \" \" + c;\n          i++;\n        }\n        key32 = steedos_id + c;\n      } else if (len >= 32) {\n        key32 = steedos_id.slice(0, 32);\n      }\n      cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n      cipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()]);\n      steedos_token = cipheredMsg.toString('base64');\n      des_iv = \"-8762-fc\";\n      key8 = \"\";\n      len = steedos_id.length;\n      if (len < 8) {\n        c = \"\";\n        i = 0;\n        m = 8 - len;\n        while (i < m) {\n          c = \" \" + c;\n          i++;\n        }\n        key8 = steedos_id + c;\n      } else if (len >= 8) {\n        key8 = steedos_id.slice(0, 8);\n      }\n      des_cipher = crypto.createCipheriv('des-cbc', new Buffer(key8, 'utf8'), new Buffer(des_iv, 'utf8'));\n      des_cipheredMsg = Buffer.concat([des_cipher.update(new Buffer(now, 'utf8')), des_cipher.final()]);\n      des_steedos_token = des_cipheredMsg.toString('base64');\n      joiner = \"?\";\n      if (redirectUrl.indexOf(\"?\") > -1) {\n        joiner = \"&\";\n      }\n      returnurl = redirectUrl + joiner + \"X-User-Id=\" + userId + \"&X-Auth-Token=\" + authToken + \"&X-STEEDOS-WEB-ID=\" + steedos_id + \"&X-STEEDOS-AUTHTOKEN=\" + steedos_token + \"&STEEDOS-AUTHTOKEN=\" + des_steedos_token;\n      if (user.username) {\n        returnurl += \"&X-STEEDOS-USERNAME=\" + (encodeURI(user.username));\n      }\n      res.setHeader(\"Location\", returnurl);\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n  }\n  res.writeHead(401);\n  res.end();\n});\n","Meteor.startup ->\n\t\n\tJsonRoutes.add 'get', '/avatar/:userId', (req, res, next) ->\n\t\t# this.params =\n\t\t# \tuserId: decodeURI(req.url).replace(/^\\//, '').replace(/\\?.*$/, '')\n\t\twidth = 50 ;\n\t\theight = 50 ;\n\t\tfontSize = 28 ;\n\t\tif req.query.w\n\t\t    width = req.query.w ;\n\t\tif req.query.h\n\t\t    height = req.query.h ;\n\t\tif req.query.fs\n            fontSize = req.query.fs ;\n\n\t\tuser = db.users.findOne(req.params.userId);\n\t\tif !user\n\t\t\tres.writeHead 401\n\t\t\tres.end()\n\t\t\treturn\n\n\t\tif user.avatar\n\t\t\tres.setHeader \"Location\", Creator.getRelativeUrl(\"api/files/avatars/\" + user.avatar)\n\t\t\tres.writeHead 302\n\t\t\tres.end()\n\t\t\treturn\n\n\t\tif user.profile?.avatar\n\t\t\tres.setHeader \"Location\", user.profile.avatar\n\t\t\tres.writeHead 302\n\t\t\tres.end()\n\t\t\treturn\n\n\t\tif user.avatarUrl\n\t\t\tres.setHeader \"Location\", user.avatarUrl\n\t\t\tres.writeHead 302\n\t\t\tres.end()\n\t\t\treturn\n\n\t\tif not file?\n\t\t\tres.setHeader 'Content-Disposition', 'inline'\n\t\t\tres.setHeader 'content-type', 'image/svg+xml'\n\t\t\tres.setHeader 'cache-control', 'public, max-age=31536000'\n\t\t\tsvg = \"\"\"\n\t\t\t\t<svg version=\"1.1\" id=\"Layer_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\"\n\t\t\t\t\t viewBox=\"0 0 72 72\" style=\"enable-background:new 0 0 72 72;\" xml:space=\"preserve\">\n\t\t\t\t<style type=\"text/css\">\n\t\t\t\t\t.st0{fill:#FFFFFF;}\n\t\t\t\t\t.st1{fill:#D0D0D0;}\n\t\t\t\t</style>\n\t\t\t\t<g>\n\t\t\t\t\t<path class=\"st0\" d=\"M36,71.1c-19.3,0-35-15.7-35-35s15.7-35,35-35s35,15.7,35,35S55.3,71.1,36,71.1z\"/>\n\t\t\t\t\t<path class=\"st1\" d=\"M36,2.1c18.7,0,34,15.3,34,34s-15.3,34-34,34S2,54.8,2,36.1S17.3,2.1,36,2.1 M36,0.1c-19.9,0-36,16.1-36,36\n\t\t\t\t\t\ts16.1,36,36,36s36-16.1,36-36S55.9,0.1,36,0.1L36,0.1z\"/>\n\t\t\t\t</g>\n\t\t\t\t<g>\n\t\t\t\t\t<g>\n\t\t\t\t\t\t<path class=\"st1\" d=\"M35.8,42.6c8.3,0,15.1-6.8,15.1-15.1c0-8.3-6.8-15.1-15.1-15.1c-8.3,0-15.1,6.8-15.1,15.1\n\t\t\t\t\t\t\tC20.7,35.8,27.5,42.6,35.8,42.6z\"/>\n\t\t\t\t\t\t<path class=\"st1\" d=\"M36.2,70.7c8.7,0,16.7-3.1,22.9-8.2c-3.6-9.6-12.7-15.5-23.3-15.5c-10.4,0-19.4,5.7-23.1,15\n\t\t\t\t\t\t\tC19,67.4,27.2,70.7,36.2,70.7z\"/>\n\t\t\t\t\t</g>\n\t\t\t\t</g>\n\t\t\t\t</svg>\n\t\t\t\"\"\"\n\t\t\tres.write svg\n#\t\t\tres.setHeader \"Location\", Steedos.absoluteUrl(\"/images/default-avatar.png\")\n#\t\t\tres.writeHead 302\n\t\t\tres.end()\n\t\t\treturn\n\n\t\tusername = user.name;\n\t\tif !username\n\t\t\tusername = \"\"\n\n\t\tres.setHeader 'Content-Disposition', 'inline'\n\n\t\tif not file?\n\t\t\tres.setHeader 'content-type', 'image/svg+xml'\n\t\t\tres.setHeader 'cache-control', 'public, max-age=31536000'\n\n\t\t\tcolors = ['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#03A9F4','#00BCD4','#009688','#4CAF50','#8BC34A','#CDDC39','#FFC107','#FF9800','#FF5722','#795548','#9E9E9E','#607D8B']\n\n\t\t\tusername_array = Array.from(username)\n\t\t\tcolor_index = 0\n\t\t\t_.each username_array, (item) ->\n\t\t\t\tcolor_index += item.charCodeAt(0);\n\n\t\t\tposition = color_index % colors.length\n\t\t\tcolor = colors[position]\n\t\t\t#color = \"#D6DADC\"\n\n\t\t\tinitials = ''\n\t\t\tif username.charCodeAt(0)>255\n\t\t\t\tinitials = username.substr(0, 1)\n\t\t\telse\n\t\t\t\tinitials = username.substr(0, 2)\n\n\t\t\tinitials = initials.toUpperCase()\n\n\t\t\tsvg = \"\"\"\n\t\t\t<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n\t\t\t<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"#{width}\" height=\"#{height}\" style=\"width: #{width}px; height: #{height}px; background-color: #{color};\">\n\t\t\t\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#FFFFFF\" font-family=\"-apple-system, BlinkMacSystemFont, Helvetica, Arial, Microsoft Yahei, SimHei\" style=\"font-weight: 400; font-size: #{fontSize}px;\">\n\t\t\t\t\t#{initials}\n\t\t\t\t</text>\n\t\t\t</svg>\n\t\t\t\"\"\"\n\n\t\t\tres.write svg\n\t\t\tres.end()\n\t\t\treturn\n\n\t\treqModifiedHeader = req.headers[\"if-modified-since\"];\n\t\tif reqModifiedHeader?\n\t\t\tif reqModifiedHeader == user.modified?.toUTCString()\n\t\t\t\tres.setHeader 'Last-Modified', reqModifiedHeader\n\t\t\t\tres.writeHead 304\n\t\t\t\tres.end()\n\t\t\t\treturn\n\n\t\tres.setHeader 'Last-Modified', user.modified?.toUTCString() or new Date().toUTCString()\n\t\tres.setHeader 'content-type', 'image/jpeg'\n\t\tres.setHeader 'Content-Length', file.length\n\n\t\tfile.readStream.pipe res\n\t\treturn","Meteor.startup(function() {\n  return JsonRoutes.add('get', '/avatar/:userId', function(req, res, next) {\n    var color, color_index, colors, fontSize, height, initials, position, ref, ref1, ref2, reqModifiedHeader, svg, user, username, username_array, width;\n    width = 50;\n    height = 50;\n    fontSize = 28;\n    if (req.query.w) {\n      width = req.query.w;\n    }\n    if (req.query.h) {\n      height = req.query.h;\n    }\n    if (req.query.fs) {\n      fontSize = req.query.fs;\n    }\n    user = db.users.findOne(req.params.userId);\n    if (!user) {\n      res.writeHead(401);\n      res.end();\n      return;\n    }\n    if (user.avatar) {\n      res.setHeader(\"Location\", Creator.getRelativeUrl(\"api/files/avatars/\" + user.avatar));\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    if ((ref = user.profile) != null ? ref.avatar : void 0) {\n      res.setHeader(\"Location\", user.profile.avatar);\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    if (user.avatarUrl) {\n      res.setHeader(\"Location\", user.avatarUrl);\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    if (typeof file === \"undefined\" || file === null) {\n      res.setHeader('Content-Disposition', 'inline');\n      res.setHeader('content-type', 'image/svg+xml');\n      res.setHeader('cache-control', 'public, max-age=31536000');\n      svg = \"<svg version=\\\"1.1\\\" id=\\\"Layer_1\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" xmlns:xlink=\\\"http://www.w3.org/1999/xlink\\\" x=\\\"0px\\\" y=\\\"0px\\\"\\n\t viewBox=\\\"0 0 72 72\\\" style=\\\"enable-background:new 0 0 72 72;\\\" xml:space=\\\"preserve\\\">\\n<style type=\\\"text/css\\\">\\n\t.st0{fill:#FFFFFF;}\\n\t.st1{fill:#D0D0D0;}\\n</style>\\n<g>\\n\t<path class=\\\"st0\\\" d=\\\"M36,71.1c-19.3,0-35-15.7-35-35s15.7-35,35-35s35,15.7,35,35S55.3,71.1,36,71.1z\\\"/>\\n\t<path class=\\\"st1\\\" d=\\\"M36,2.1c18.7,0,34,15.3,34,34s-15.3,34-34,34S2,54.8,2,36.1S17.3,2.1,36,2.1 M36,0.1c-19.9,0-36,16.1-36,36\\n\t\ts16.1,36,36,36s36-16.1,36-36S55.9,0.1,36,0.1L36,0.1z\\\"/>\\n</g>\\n<g>\\n\t<g>\\n\t\t<path class=\\\"st1\\\" d=\\\"M35.8,42.6c8.3,0,15.1-6.8,15.1-15.1c0-8.3-6.8-15.1-15.1-15.1c-8.3,0-15.1,6.8-15.1,15.1\\n\t\t\tC20.7,35.8,27.5,42.6,35.8,42.6z\\\"/>\\n\t\t<path class=\\\"st1\\\" d=\\\"M36.2,70.7c8.7,0,16.7-3.1,22.9-8.2c-3.6-9.6-12.7-15.5-23.3-15.5c-10.4,0-19.4,5.7-23.1,15\\n\t\t\tC19,67.4,27.2,70.7,36.2,70.7z\\\"/>\\n\t</g>\\n</g>\\n</svg>\";\n      res.write(svg);\n      res.end();\n      return;\n    }\n    username = user.name;\n    if (!username) {\n      username = \"\";\n    }\n    res.setHeader('Content-Disposition', 'inline');\n    if (typeof file === \"undefined\" || file === null) {\n      res.setHeader('content-type', 'image/svg+xml');\n      res.setHeader('cache-control', 'public, max-age=31536000');\n      colors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B'];\n      username_array = Array.from(username);\n      color_index = 0;\n      _.each(username_array, function(item) {\n        return color_index += item.charCodeAt(0);\n      });\n      position = color_index % colors.length;\n      color = colors[position];\n      initials = '';\n      if (username.charCodeAt(0) > 255) {\n        initials = username.substr(0, 1);\n      } else {\n        initials = username.substr(0, 2);\n      }\n      initials = initials.toUpperCase();\n      svg = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"no\\\"?>\\n<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" pointer-events=\\\"none\\\" width=\\\"\" + width + \"\\\" height=\\\"\" + height + \"\\\" style=\\\"width: \" + width + \"px; height: \" + height + \"px; background-color: \" + color + \";\\\">\\n\t<text text-anchor=\\\"middle\\\" y=\\\"50%\\\" x=\\\"50%\\\" dy=\\\"0.36em\\\" pointer-events=\\\"auto\\\" fill=\\\"#FFFFFF\\\" font-family=\\\"-apple-system, BlinkMacSystemFont, Helvetica, Arial, Microsoft Yahei, SimHei\\\" style=\\\"font-weight: 400; font-size: \" + fontSize + \"px;\\\">\\n\t\t\" + initials + \"\\n\t</text>\\n</svg>\";\n      res.write(svg);\n      res.end();\n      return;\n    }\n    reqModifiedHeader = req.headers[\"if-modified-since\"];\n    if (reqModifiedHeader != null) {\n      if (reqModifiedHeader === ((ref1 = user.modified) != null ? ref1.toUTCString() : void 0)) {\n        res.setHeader('Last-Modified', reqModifiedHeader);\n        res.writeHead(304);\n        res.end();\n        return;\n      }\n    }\n    res.setHeader('Last-Modified', ((ref2 = user.modified) != null ? ref2.toUTCString() : void 0) || new Date().toUTCString());\n    res.setHeader('content-type', 'image/jpeg');\n    res.setHeader('Content-Length', file.length);\n    file.readStream.pipe(res);\n  });\n});\n","Meteor.startup ->\n\tJsonRoutes.add 'get', '/api/access/check', (req, res, next) ->\n\n\t\taccess_token = req.query?.access_token\n\n\t\tif Steedos.getUserIdFromAccessToken(access_token)\n\t\t\tres.writeHead 200\n\t\t\tres.end()\n\t\t\treturn\n\t\telse\n\t\t\tres.writeHead 401\n\t\t\tres.end()\n\t\t\treturn\n\n\n\n\n","Meteor.startup(function() {\n  return JsonRoutes.add('get', '/api/access/check', function(req, res, next) {\n    var access_token, ref;\n    access_token = (ref = req.query) != null ? ref.access_token : void 0;\n    if (Steedos.getUserIdFromAccessToken(access_token)) {\n      res.writeHead(200);\n      res.end();\n    } else {\n      res.writeHead(401);\n      res.end();\n    }\n  });\n});\n","if Meteor.isServer\n    Meteor.publish 'apps', (spaceId)->\n        unless this.userId\n            return this.ready()\n        \n\n        selector = {space: {$exists: false}}\n        if spaceId\n            selector = {$or: [{space: {$exists: false}}, {space: spaceId}]}\n        \n        return db.apps.find(selector, {sort: {sort: 1}});\n","if (Meteor.isServer) {\n  Meteor.publish('apps', function(spaceId) {\n    var selector;\n    if (!this.userId) {\n      return this.ready();\n    }\n    selector = {\n      space: {\n        $exists: false\n      }\n    };\n    if (spaceId) {\n      selector = {\n        $or: [\n          {\n            space: {\n              $exists: false\n            }\n          }, {\n            space: spaceId\n          }\n        ]\n      };\n    }\n    return db.apps.find(selector, {\n      sort: {\n        sort: 1\n      }\n    });\n  });\n}\n","\n\n\t# publish users spaces\n\t# we only publish spaces current user joined.\n\tMeteor.publish 'my_spaces', ->\n\t\tunless this.userId\n\t\t\treturn this.ready()\n\n\n\t\tself = this;\n\t\tuserSpaces = []\n\t\tsus = db.space_users.find({user: this.userId, user_accepted: true}, {fields: {space:1}})\n\t\tsus.forEach (su) ->\n\t\t\tuserSpaces.push(su.space)\n\n\t\thandle2 = null\n\n\t\t# only return user joined spaces, and observes when user join or leave a space\n\t\thandle = db.space_users.find({user: this.userId, user_accepted: true}).observe\n\t\t\tadded: (doc) ->\n\t\t\t\tif doc.space\n\t\t\t\t\tif userSpaces.indexOf(doc.space) < 0\n\t\t\t\t\t\tuserSpaces.push(doc.space)\n\t\t\t\t\t\tobserveSpaces()\n\t\t\tremoved: (oldDoc) ->\n\t\t\t\tif oldDoc.space\n\t\t\t\t\tself.removed \"spaces\", oldDoc.space\n\t\t\t\t\tuserSpaces = _.without(userSpaces, oldDoc.space)\n\n\t\tobserveSpaces = ->\n\t\t\tif handle2\n\t\t\t\thandle2.stop();\n\t\t\thandle2 = db.spaces.find({_id: {$in: userSpaces}}).observe\n\t\t\t\tadded: (doc) ->\n\t\t\t\t\tself.added \"spaces\", doc._id, doc;\n\t\t\t\t\tuserSpaces.push(doc._id)\n\t\t\t\tchanged: (newDoc, oldDoc) ->\n\t\t\t\t\tself.changed \"spaces\", newDoc._id, newDoc;\n\t\t\t\tremoved: (oldDoc) ->\n\t\t\t\t\tself.removed \"spaces\", oldDoc._id\n\t\t\t\t\tuserSpaces = _.without(userSpaces, oldDoc._id)\n\n\t\tobserveSpaces();\n\n\t\tself.ready();\n\n\t\tself.onStop ->\n\t\t\thandle.stop();\n\t\t\tif handle2\n\t\t\t\thandle2.stop();\n","Meteor.publish('my_spaces', function() {\n  var handle, handle2, observeSpaces, self, sus, userSpaces;\n  if (!this.userId) {\n    return this.ready();\n  }\n  self = this;\n  userSpaces = [];\n  sus = db.space_users.find({\n    user: this.userId,\n    user_accepted: true\n  }, {\n    fields: {\n      space: 1\n    }\n  });\n  sus.forEach(function(su) {\n    return userSpaces.push(su.space);\n  });\n  handle2 = null;\n  handle = db.space_users.find({\n    user: this.userId,\n    user_accepted: true\n  }).observe({\n    added: function(doc) {\n      if (doc.space) {\n        if (userSpaces.indexOf(doc.space) < 0) {\n          userSpaces.push(doc.space);\n          return observeSpaces();\n        }\n      }\n    },\n    removed: function(oldDoc) {\n      if (oldDoc.space) {\n        self.removed(\"spaces\", oldDoc.space);\n        return userSpaces = _.without(userSpaces, oldDoc.space);\n      }\n    }\n  });\n  observeSpaces = function() {\n    if (handle2) {\n      handle2.stop();\n    }\n    return handle2 = db.spaces.find({\n      _id: {\n        $in: userSpaces\n      }\n    }).observe({\n      added: function(doc) {\n        self.added(\"spaces\", doc._id, doc);\n        return userSpaces.push(doc._id);\n      },\n      changed: function(newDoc, oldDoc) {\n        return self.changed(\"spaces\", newDoc._id, newDoc);\n      },\n      removed: function(oldDoc) {\n        self.removed(\"spaces\", oldDoc._id);\n        return userSpaces = _.without(userSpaces, oldDoc._id);\n      }\n    });\n  };\n  observeSpaces();\n  self.ready();\n  return self.onStop(function() {\n    handle.stop();\n    if (handle2) {\n      return handle2.stop();\n    }\n  });\n});\n","# publish some one space's avatar\nMeteor.publish 'space_avatar', (spaceId)->\n\tunless spaceId\n\t\treturn this.ready()\n\n\treturn db.spaces.find({_id: spaceId}, {fields: {avatar: 1,name: 1,enable_register:1}});\n","Meteor.publish('space_avatar', function(spaceId) {\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.spaces.find({\n    _id: spaceId\n  }, {\n    fields: {\n      avatar: 1,\n      name: 1,\n      enable_register: 1\n    }\n  });\n});\n","Meteor.publish 'modules', ()->\n\tunless this.userId\n\t\treturn this.ready()\n\n\treturn db.modules.find();","Meteor.publish('modules', function() {\n  if (!this.userId) {\n    return this.ready();\n  }\n  return db.modules.find();\n});\n","Meteor.publish 'billing_weixin_pay_code_url', (_id)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless _id\n\t\treturn this.ready()\n\n\treturn db.billing_pay_records.find({_id: _id});","Meteor.publish('billing_weixin_pay_code_url', function(_id) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!_id) {\n    return this.ready();\n  }\n  return db.billing_pay_records.find({\n    _id: _id\n  });\n});\n","Meteor.methods\n\tget_contacts_limit: (space)->\n\t\t# 根据当前用户所属组织，查询出当前用户限定的组织查看范围\n\t\t# 返回的isLimit为true表示限定在当前用户所在组织范围，organizations值记录额外的组织范围\n\t\t# 返回的isLimit为false表示不限定组织范围，即表示能看整个工作区的组织\n\t\t# 默认返回限定在当前用户所属组织\n\t\tcheck space, String\n\t\treValue =\n\t\t\tisLimit: true\n\t\t\toutside_organizations: []\n\t\tunless this.userId\n\t\t\treturn reValue\n\t\tisLimit = false\n\t\toutside_organizations = []\n\t\tsetting = db.space_settings.findOne({space: space, key: \"contacts_view_limits\"})\n\t\tlimits = setting?.values || [];\n\n\t\tif limits.length\n\t\t\tmyOrgs = db.organizations.find({space: space, users: this.userId}, {fields:{_id: 1}})\n\t\t\tmyOrgIds = myOrgs.map (n) ->\n\t\t\t\treturn n._id\n\t\t\tunless myOrgIds.length\n\t\t\t\treturn reValue\n\t\t\t\n\t\t\tmyLitmitOrgIds = []\n\t\t\tfor limit in limits\n\t\t\t\tfroms = limit.froms\n\t\t\t\ttos = limit.tos\n\t\t\t\tfromsChildren = db.organizations.find({space: space, parents: {$in: froms}}, {fields:{_id: 1}})\n\t\t\t\tfromsChildrenIds = fromsChildren?.map (n) ->\n\t\t\t\t\treturn n._id\n\t\t\t\tfor myOrgId in myOrgIds\n\t\t\t\t\ttempIsLimit = false\n\t\t\t\t\tif froms.indexOf(myOrgId) > -1\n\t\t\t\t\t\ttempIsLimit = true\n\t\t\t\t\telse\n\t\t\t\t\t\tif fromsChildrenIds.indexOf(myOrgId) > -1\n\t\t\t\t\t\t\ttempIsLimit = true\n\t\t\t\t\tif tempIsLimit\n\t\t\t\t\t\tisLimit = true\n\t\t\t\t\t\toutside_organizations.push tos\n\t\t\t\t\t\tmyLitmitOrgIds.push myOrgId\n\n\t\t\tmyLitmitOrgIds = _.uniq myLitmitOrgIds\n\t\t\tif myLitmitOrgIds.length < myOrgIds.length\n\t\t\t\t# 如果受限的组织个数小于用户所属组织的个数，则说明当前用户至少有一个组织是不受限的\n\t\t\t\tisLimit = false\n\t\t\t\toutside_organizations = []\n\t\t\telse\n\t\t\t\toutside_organizations = _.uniq _.flatten outside_organizations\n\n\t\tif isLimit\n\t\t\ttoOrgs = db.organizations.find({space: space, _id: {$in: outside_organizations}}, {fields:{_id: 1, parents: 1}}).fetch()\n\t\t\t# 把outside_organizations中有父子节点关系的节点筛选出来并取出最外层节点\n\t\t\t# 把outside_organizations中有属于用户所属组织的子孙节点的节点删除\n\t\t\torgs = _.filter toOrgs, (org) ->\n\t\t\t\tparents = org.parents or []\n\t\t\t\treturn _.intersection(parents, outside_organizations).length < 1 and _.intersection(parents, myOrgIds).length < 1\n\t\t\toutside_organizations = orgs.map (n) ->\n\t\t\t\treturn n._id\n\n\t\treValue.isLimit = isLimit\n\t\treValue.outside_organizations = outside_organizations\n\t\treturn reValue\n","Meteor.methods({\n  get_contacts_limit: function(space) {\n    var froms, fromsChildren, fromsChildrenIds, i, isLimit, j, len, len1, limit, limits, myLitmitOrgIds, myOrgId, myOrgIds, myOrgs, orgs, outside_organizations, reValue, setting, tempIsLimit, toOrgs, tos;\n    check(space, String);\n    reValue = {\n      isLimit: true,\n      outside_organizations: []\n    };\n    if (!this.userId) {\n      return reValue;\n    }\n    isLimit = false;\n    outside_organizations = [];\n    setting = db.space_settings.findOne({\n      space: space,\n      key: \"contacts_view_limits\"\n    });\n    limits = (setting != null ? setting.values : void 0) || [];\n    if (limits.length) {\n      myOrgs = db.organizations.find({\n        space: space,\n        users: this.userId\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      myOrgIds = myOrgs.map(function(n) {\n        return n._id;\n      });\n      if (!myOrgIds.length) {\n        return reValue;\n      }\n      myLitmitOrgIds = [];\n      for (i = 0, len = limits.length; i < len; i++) {\n        limit = limits[i];\n        froms = limit.froms;\n        tos = limit.tos;\n        fromsChildren = db.organizations.find({\n          space: space,\n          parents: {\n            $in: froms\n          }\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        fromsChildrenIds = fromsChildren != null ? fromsChildren.map(function(n) {\n          return n._id;\n        }) : void 0;\n        for (j = 0, len1 = myOrgIds.length; j < len1; j++) {\n          myOrgId = myOrgIds[j];\n          tempIsLimit = false;\n          if (froms.indexOf(myOrgId) > -1) {\n            tempIsLimit = true;\n          } else {\n            if (fromsChildrenIds.indexOf(myOrgId) > -1) {\n              tempIsLimit = true;\n            }\n          }\n          if (tempIsLimit) {\n            isLimit = true;\n            outside_organizations.push(tos);\n            myLitmitOrgIds.push(myOrgId);\n          }\n        }\n      }\n      myLitmitOrgIds = _.uniq(myLitmitOrgIds);\n      if (myLitmitOrgIds.length < myOrgIds.length) {\n        isLimit = false;\n        outside_organizations = [];\n      } else {\n        outside_organizations = _.uniq(_.flatten(outside_organizations));\n      }\n    }\n    if (isLimit) {\n      toOrgs = db.organizations.find({\n        space: space,\n        _id: {\n          $in: outside_organizations\n        }\n      }, {\n        fields: {\n          _id: 1,\n          parents: 1\n        }\n      }).fetch();\n      orgs = _.filter(toOrgs, function(org) {\n        var parents;\n        parents = org.parents || [];\n        return _.intersection(parents, outside_organizations).length < 1 && _.intersection(parents, myOrgIds).length < 1;\n      });\n      outside_organizations = orgs.map(function(n) {\n        return n._id;\n      });\n    }\n    reValue.isLimit = isLimit;\n    reValue.outside_organizations = outside_organizations;\n    return reValue;\n  }\n});\n","Meteor.methods({\n    setKeyValue: function(key, value) {\n        check(key, String);\n        check(value, Object);\n\n        obj = {};\n        obj.user = this.userId;\n        obj.key = key;\n        obj.value = value;\n\n        var c = db.steedos_keyvalues.find({\n            user: this.userId,\n            key: key\n        }).count();\n        if (c > 0) {\n            db.steedos_keyvalues.update({\n                user: this.userId,\n                key: key\n            }, {\n                $set: {\n                    value: value\n                }\n            });\n        } else {\n            db.steedos_keyvalues.insert(obj);\n        }\n\n        return true;\n    }\n})","Meteor.methods\n\tsetUsername: (space_id, username, user_id) ->\n\t\tcheck(space_id, String);\n\t\tcheck(username, String);\n\n\t\tif !Steedos.isSpaceAdmin(space_id, Meteor.userId()) and user_id\n\t\t\tthrow new Meteor.Error(400, 'contact_space_user_needed')\n\n\t\tif not Meteor.userId()\n\t\t\tthrow new Meteor.Error(400,'error-invalid-user')\n\n\t\tunless user_id\n\t\t\tuser_id = Meteor.user()._id\n\n\t\tspaceUser = db.space_users.findOne({user: user_id, space: space_id})\n\n\t\tif spaceUser.invite_state == \"pending\" or spaceUser.invite_state == \"refused\"\n\t\t\tthrow new Meteor.Error(400, \"该用户尚未同意加入该工作区，无法修改用户名\")\n\n\t\tdb.users.update({_id: user_id}, {$set: {username: username}})\n\n\t\treturn username\n","Meteor.methods({\n  setUsername: function(space_id, username, user_id) {\n    var spaceUser;\n    check(space_id, String);\n    check(username, String);\n    if (!Steedos.isSpaceAdmin(space_id, Meteor.userId()) && user_id) {\n      throw new Meteor.Error(400, 'contact_space_user_needed');\n    }\n    if (!Meteor.userId()) {\n      throw new Meteor.Error(400, 'error-invalid-user');\n    }\n    if (!user_id) {\n      user_id = Meteor.user()._id;\n    }\n    spaceUser = db.space_users.findOne({\n      user: user_id,\n      space: space_id\n    });\n    if (spaceUser.invite_state === \"pending\" || spaceUser.invite_state === \"refused\") {\n      throw new Meteor.Error(400, \"该用户尚未同意加入该工作区，无法修改用户名\");\n    }\n    db.users.update({\n      _id: user_id\n    }, {\n      $set: {\n        username: username\n      }\n    });\n    return username;\n  }\n});\n","Meteor.methods\n\tget_space_user_count: (space_id)->\n\t\tcheck space_id, String\n\t\tuser_count_info = new Object\n\t\tuser_count_info.total_user_count = db.space_users.find({space: space_id}).count()\n\t\tuser_count_info.accepted_user_count = db.space_users.find({space: space_id, user_accepted: true}).count()\n\t\treturn user_count_info","Meteor.methods\n\tcreate_secret: (name)->\n\t\tif !this.userId\n\t\t\treturn false;\n\n\t\tdb.users.create_secret this.userId, name\n\n\tremove_secret: (token)->\n\t\tif !this.userId || !token\n\t\t\treturn false;\n\n\t\thashedToken = Accounts._hashLoginToken(token)\n\n\t\tconsole.log(\"token\", token)\n\n\t\tdb.users.update({_id: this.userId}, {$pull: {\"secrets\": {hashedToken: hashedToken}}})\n","Meteor.methods({\n  create_secret: function(name) {\n    if (!this.userId) {\n      return false;\n    }\n    return db.users.create_secret(this.userId, name);\n  },\n  remove_secret: function(token) {\n    var hashedToken;\n    if (!this.userId || !token) {\n      return false;\n    }\n    hashedToken = Accounts._hashLoginToken(token);\n    console.log(\"token\", token);\n    return db.users.update({\n      _id: this.userId\n    }, {\n      $pull: {\n        \"secrets\": {\n          hashedToken: hashedToken\n        }\n      }\n    });\n  }\n});\n","Meteor.methods\n    'object_workflows.get': (spaceId, userId) ->\n        check spaceId, String\n        check userId, String\n\n        curSpaceUser = Creator.Collections[\"space_users\"].findOne({space: spaceId, user: userId}, {fields: {organizations: 1}})\n        if !curSpaceUser\n            throw new Meteor.Error 'not-authorized'\n\n        organizations = Creator.getCollection('organizations').find({\n            _id: {\n                $in: curSpaceUser.organizations\n            }\n        }, {fields: {parents: 1}}).fetch()\n\n        ows = Creator.getCollection('object_workflows').find({ space: spaceId }, { fields: { object_name: 1, flow_id: 1, space: 1, sync_direction: 1 } }).fetch()\n        _.each ows,(o) ->\n            fl = Creator.getCollection('flows').findOne({_id: o.flow_id, state: 'enabled'}, { fields: { name: 1, perms: 1, forbid_initiate_instance: 1 } })\n            if fl\n                o.flow_name = fl.name\n                o.can_add = false\n                o.forbid_initiate_instance = fl.forbid_initiate_instance\n\n                perms = fl.perms\n                if perms\n                    if perms.users_can_add && perms.users_can_add.includes(userId)\n                        o.can_add = true\n                    else if perms.orgs_can_add && perms.orgs_can_add.length > 0\n                        if curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_add).length > 0\n                            o.can_add = true\n                        else\n                            if organizations\n                                o.can_add = _.some organizations, (org)->\n                                    return org.parents && _.intersection(org.parents, perms.orgs_can_add).length > 0\n\n        ows = ows.filter (n)->\n            return n.flow_name\n\n        return ows","Meteor.methods({\n  'object_workflows.get': function(spaceId, userId) {\n    var curSpaceUser, organizations, ows;\n    check(spaceId, String);\n    check(userId, String);\n    curSpaceUser = Creator.Collections[\"space_users\"].findOne({\n      space: spaceId,\n      user: userId\n    }, {\n      fields: {\n        organizations: 1\n      }\n    });\n    if (!curSpaceUser) {\n      throw new Meteor.Error('not-authorized');\n    }\n    organizations = Creator.getCollection('organizations').find({\n      _id: {\n        $in: curSpaceUser.organizations\n      }\n    }, {\n      fields: {\n        parents: 1\n      }\n    }).fetch();\n    ows = Creator.getCollection('object_workflows').find({\n      space: spaceId\n    }, {\n      fields: {\n        object_name: 1,\n        flow_id: 1,\n        space: 1,\n        sync_direction: 1\n      }\n    }).fetch();\n    _.each(ows, function(o) {\n      var fl, perms;\n      fl = Creator.getCollection('flows').findOne({\n        _id: o.flow_id,\n        state: 'enabled'\n      }, {\n        fields: {\n          name: 1,\n          perms: 1,\n          forbid_initiate_instance: 1\n        }\n      });\n      if (fl) {\n        o.flow_name = fl.name;\n        o.can_add = false;\n        o.forbid_initiate_instance = fl.forbid_initiate_instance;\n        perms = fl.perms;\n        if (perms) {\n          if (perms.users_can_add && perms.users_can_add.includes(userId)) {\n            return o.can_add = true;\n          } else if (perms.orgs_can_add && perms.orgs_can_add.length > 0) {\n            if (curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_add).length > 0) {\n              return o.can_add = true;\n            } else {\n              if (organizations) {\n                return o.can_add = _.some(organizations, function(org) {\n                  return org.parents && _.intersection(org.parents, perms.orgs_can_add).length > 0;\n                });\n              }\n            }\n          }\n        }\n      }\n    });\n    ows = ows.filter(function(n) {\n      return n.flow_name;\n    });\n    return ows;\n  }\n});\n","billingManager = {}\n\n# 获得结算周期内的可结算日数\n# space_id 结算对象工作区\n# accounting_month 结算月，格式：YYYYMM\nbillingManager.get_accounting_period = (space_id, accounting_month)->\n\tcount_days = 0\n\n\tend_date_time = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\n\tend_date = moment(end_date_time.getTime()).format('YYYYMMDD')\n\n\tbilling = db.billings.findOne({space: space_id, transaction: \"Starting balance\"})\n\tfirst_date = billing.billing_date\n\n\tstart_date = accounting_month + \"01\"\n\tstart_date_time = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 1-end_date_time.getDate())\n\n\tif first_date >= end_date # 这个月不在本次结算范围之内，count_days=0\n\t\t# do nothing\n\telse if start_date <= first_date and first_date < end_date\n\t\tcount_days = (end_date_time - start_date_time)/(24*60*60*1000) + 1\n\telse if first_date < start_date\n\t\tcount_days = (end_date_time - start_date_time)/(24*60*60*1000) + 1\n\n\treturn {\"count_days\": count_days}\n\n# 重算这一日的余额\nbillingManager.refresh_balance = (space_id, refresh_date)->\n\tlast_bill = null\n\tbill = db.billings.findOne({space: space_id, created: refresh_date})\n\n\t# 获取正常付款的小于refresh_date的最近的一条记录\n\tpayment_bill = db.billings.findOne(\n\t\t{\n\t\t\tspace: space_id,\n\t\t\tcreated: {\n\t\t\t\t$lt: refresh_date\n\t\t\t},\n\t\t\tbilling_month: bill.billing_month\n\t\t},\n\t\t{\n\t\t\tsort: {\n\t\t\t\tmodified: -1\n\t\t\t}\n\t\t}\n\t)\n\tif payment_bill\n\t\tlast_bill = payment_bill\n\telse\n\t\t# 获取最新的结算的一条记录\n\t\tb_m_d = new Date(parseInt(bill.billing_month.slice(0,4)), parseInt(bill.billing_month.slice(4,6)), 0)\n\t\tb_m = moment(b_m_d.getTime()-(b_m_d.getDate()*24*60*60*1000)).format(\"YYYYMM\")\n\n\t\tapp_bill = db.billings.findOne(\n\t\t\t{\n\t\t\t\tspace: space_id,\n\t\t\t\tbilling_month: b_m\n\t\t\t},\n\t\t\t{\n\t\t\t\tsort: {\n\t\t\t\t\tmodified: -1\n\t\t\t\t}\n\t\t\t}\n\t\t)\n\t\tif app_bill\n\t\t\tlast_bill = app_bill\n\n\tlast_balance = if last_bill and last_bill.balance then last_bill.balance else 0.0\n\n\tdebits = if bill.debits then bill.debits else 0.0\n\tcredits = if bill.credits then bill.credits else 0.0\n\tsetObj = new Object\n\tsetObj.balance = Number((last_balance + credits - debits).toFixed(2))\n\tsetObj.modified = new Date\n\tdb.billings.direct.update({_id: bill._id}, {$set: setObj})\n\n# 结算当月的支出与余额\nbillingManager.get_balance = (space_id, accounting_month, user_count, count_days, module_name, listprice)->\n\taccounting_date = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\n\tdays_number = accounting_date.getDate()\n\taccounting_date_format = moment(accounting_date).format(\"YYYYMMDD\")\n\n\tdebits = Number(((count_days/days_number) * user_count * listprice).toFixed(2))\n\tlast_bill = db.billings.findOne(\n\t\t{\n\t\t\tspace: space_id,\n\t\t\tbilling_date: {\n\t\t\t\t$lte: accounting_date_format\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tsort: {\n\t\t\t\tmodified: -1\n\t\t\t}\n\t\t}\n\t)\n\tlast_balance = if last_bill and last_bill.balance then last_bill.balance else 0.0\n\n\tnow = new Date\n\tnew_bill = new Object\n\tnew_bill._id = db.billings._makeNewID()\n\tnew_bill.billing_month = accounting_month\n\tnew_bill.billing_date = accounting_date_format\n\tnew_bill.space = space_id\n\tnew_bill.transaction = module_name\n\tnew_bill.listprice = listprice\n\tnew_bill.user_count = user_count\n\tnew_bill.debits = debits\n\tnew_bill.balance = Number((last_balance - debits).toFixed(2))\n\tnew_bill.created = now\n\tnew_bill.modified = now\n\tdb.billings.direct.insert(new_bill)\n\nbillingManager.getSpaceUserCount = (space_id)->\n\tdb.space_users.find({space: space_id, user_accepted: true}).count()\n\nbillingManager.recaculateBalance = (accounting_month, space_id)->\n\trefresh_dates = new Array\n\tdb.billings.find(\n\t\t{\n\t\t\tbilling_month: accounting_month,\n\t\t\tspace: space_id,\n\t\t\ttransaction: {$in: [\"Payment\", \"Service adjustment\"]}\n\t\t},\n\t\t{\n\t\t\tsort: {created: 1}\n\t\t}\n\t).forEach (bill)->\n\t\trefresh_dates.push(bill.created)\n\n\tif refresh_dates.length > 0\n\t\t_.each refresh_dates, (r_d)->\n\t\t\tbillingManager.refresh_balance(space_id, r_d)\n\nbillingManager.get_modules = (space_id, accounting_month)->\n\tmodules = new Array\n\tstart_date = accounting_month + \"01\"\n\tend_date_time = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\n\tend_date = moment(end_date_time.getTime()).format('YYYYMMDD')\n\n\tdb.modules.find().forEach (m)->\n\t\tm_changelog = db.modules_changelogs.findOne(\n\t\t\t{\n\t\t\t\tspace: space_id,\n\t\t\t\tmodule: m.name,\n\t\t\t\tchange_date: {\n\t\t\t\t\t$lte: end_date\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tcreated: -1\n\t\t\t}\n\t\t)\n\t\t# 若未获得可匹配的记录，说明该module未安装，当月不计算费用\n\t\tif not m_changelog\n\t\t\t#  do nothing\n\n\t\t# 若该记录的change_date<startdate & operation=“install”，说明当月前已安装，因此需计算费用，将module_name与modules.listprice加入modules数组中\n\t\telse if m_changelog.change_date < start_date and m_changelog.operation == \"install\"\n\t\t\tmodules.push(m)\n\t\t# 若该记录的change_date<startdate & operation=“uninstall”，说明当月前已卸载，因此不计算费用\n\t\telse if m_changelog.change_date < start_date and m_changelog.operation == \"uninstall\"\n\t\t\t#  do nothing\n\t\t# 若该记录的change_date≥startdate，说明当月内发生过安装或卸载的操作，需计算费用，将module_name与modules.listprice加入modules数组中\n\t\telse if m_changelog.change_date >= start_date\n\t\t\tmodules.push(m)\n\n\treturn modules\n\nbillingManager.get_modules_name = ()->\n\tmodules_name = new Array\n\tdb.modules.find().forEach((m)->\n\t\tmodules_name.push(m.name)\n\t)\n\treturn modules_name\n\n\nbillingManager.caculate_by_accounting_month = (accounting_month, space_id)->\n\tif accounting_month > (moment().format('YYYYMM'))\n\t\treturn\n\tif accounting_month == (moment().format('YYYYMM'))\n\t\t# 重算当月的充值后余额\n\t\tbillingManager.recaculateBalance(accounting_month, space_id)\n\n\t\tdebits = 0\n\t\tmodules_name = billingManager.get_modules_name()\n\t\tb_m_d = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\n\t\tb_m = moment(b_m_d.getTime()-(b_m_d.getDate()*24*60*60*1000)).format(\"YYYYMMDD\")\n\t\tdb.billings.find(\n\t\t\t{\n\t\t\t\tbilling_date: b_m,\n\t\t\t\tspace: space_id,\n\t\t\t\ttransaction: {\n\t\t\t\t\t$in: modules_name\n\t\t\t\t}\n\t\t\t}\n\t\t).forEach((b)->\n\t\t\tdebits += b.debits\n\t\t)\n\t\tnewest_bill = db.billings.findOne({space: space_id}, {sort: {modified: -1}})\n\t\tbalance = newest_bill.balance\n\t\tremaining_months = 0\n\t\tif balance > 0\n\t\t\tif debits > 0\n\t\t\t\tremaining_months = parseInt(balance/debits) + 1\n\t\t\telse\n\t\t\t\t# 当月刚升级，并没有扣款\n\t\t\t\tremaining_months = 1\n\n\t\tdb.spaces.direct.update(\n\t\t\t{\n\t\t\t\t_id: space_id\n\t\t\t},\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tbalance: balance,\n\t\t\t\t\t\"billing.remaining_months\": remaining_months\n\t\t\t\t}\n\t\t\t}\n\t\t)\n\telse\n\t\t# 获得其结算对象日期paymentdates数组和count_days可结算日数\n\t\tperiod_result = billingManager.get_accounting_period(space_id, accounting_month)\n\t\tif period_result[\"count_days\"] == 0\n\t\t\t# 也需对当月的充值记录执行更新\n\t\t\tbillingManager.recaculateBalance(accounting_month, space_id)\n\n\t\telse\n\t\t\tuser_count = billingManager.getSpaceUserCount(space_id)\n\n\t\t\t# 清除当月的已结算记录\n\t\t\tmodules_name = billingManager.get_modules_name()\n\t\t\taccounting_date = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\n\t\t\taccounting_date_format = moment(accounting_date).format(\"YYYYMMDD\")\n\t\t\tdb.billings.remove(\n\t\t\t\t{\n\t\t\t\t\tbilling_date: accounting_date_format,\n\t\t\t\t\tspace: space_id,\n\t\t\t\t\ttransaction: {\n\t\t\t\t\t\t$in: modules_name\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t)\n\t\t\t# 重算当月的充值后余额\n\t\t\tbillingManager.recaculateBalance(accounting_month, space_id)\n\n\t\t\t# 结算当月的APP使用后余额\n\t\t\tmodules = billingManager.get_modules(space_id, accounting_month)\n\t\t\tif modules and  modules.length>0\n\t\t\t\t_.each modules, (m)->\n\t\t\t\t\tbillingManager.get_balance(space_id, accounting_month, user_count, period_result[\"count_days\"], m.name, m.listprice)\n\n\t\ta_m = moment(new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 1).getTime()).format(\"YYYYMM\")\n\t\tbillingManager.caculate_by_accounting_month(a_m, space_id)\n\nbillingManager.special_pay = (space_id, module_names, total_fee, operator_id, end_date, user_count)->\n\tspace = db.spaces.findOne(space_id)\n\n\tmodules = space.modules || new Array\n\n\tnew_modules = _.difference(module_names, modules)\n\n\tm = moment()\n\tnow = m._d\n\n\tspace_update_obj = new Object\n\n\t# 更新space是否专业版的标记\n\tif space.is_paid isnt true\n\t\tspace_update_obj.is_paid = true\n\t\tspace_update_obj.start_date = new Date\n\n\t# 更新modules\n\tspace_update_obj.modules = module_names\n\tspace_update_obj.modified = now\n\tspace_update_obj.modified_by = operator_id\n\tspace_update_obj.end_date = new Date(end_date)\n\tspace_update_obj.user_limit = user_count\n\n\tr = db.spaces.direct.update({_id: space_id}, {$set: space_update_obj})\n\tif r\n\t\t_.each new_modules, (module)->\n\t\t\tmcl = new Object\n\t\t\tmcl._id = db.modules_changelogs._makeNewID()\n\t\t\tmcl.change_date = m.format(\"YYYYMMDD\")\n\t\t\tmcl.operator = operator_id\n\t\t\tmcl.space = space_id\n\t\t\tmcl.operation = \"install\"\n\t\t\tmcl.module = module\n\t\t\tmcl.created = now\n\t\t\tdb.modules_changelogs.insert(mcl)\n\n\treturn","                   \n\nbillingManager = {};\n\nbillingManager.get_accounting_period = function(space_id, accounting_month) {\n  var billing, count_days, end_date, end_date_time, first_date, start_date, start_date_time;\n  count_days = 0;\n  end_date_time = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n  end_date = moment(end_date_time.getTime()).format('YYYYMMDD');\n  billing = db.billings.findOne({\n    space: space_id,\n    transaction: \"Starting balance\"\n  });\n  first_date = billing.billing_date;\n  start_date = accounting_month + \"01\";\n  start_date_time = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 1 - end_date_time.getDate());\n  if (first_date >= end_date) {\n\n  } else if (start_date <= first_date && first_date < end_date) {\n    count_days = (end_date_time - start_date_time) / (24 * 60 * 60 * 1000) + 1;\n  } else if (first_date < start_date) {\n    count_days = (end_date_time - start_date_time) / (24 * 60 * 60 * 1000) + 1;\n  }\n  return {\n    \"count_days\": count_days\n  };\n};\n\nbillingManager.refresh_balance = function(space_id, refresh_date) {\n  var app_bill, b_m, b_m_d, bill, credits, debits, last_balance, last_bill, payment_bill, setObj;\n  last_bill = null;\n  bill = db.billings.findOne({\n    space: space_id,\n    created: refresh_date\n  });\n  payment_bill = db.billings.findOne({\n    space: space_id,\n    created: {\n      $lt: refresh_date\n    },\n    billing_month: bill.billing_month\n  }, {\n    sort: {\n      modified: -1\n    }\n  });\n  if (payment_bill) {\n    last_bill = payment_bill;\n  } else {\n    b_m_d = new Date(parseInt(bill.billing_month.slice(0, 4)), parseInt(bill.billing_month.slice(4, 6)), 0);\n    b_m = moment(b_m_d.getTime() - (b_m_d.getDate() * 24 * 60 * 60 * 1000)).format(\"YYYYMM\");\n    app_bill = db.billings.findOne({\n      space: space_id,\n      billing_month: b_m\n    }, {\n      sort: {\n        modified: -1\n      }\n    });\n    if (app_bill) {\n      last_bill = app_bill;\n    }\n  }\n  last_balance = last_bill && last_bill.balance ? last_bill.balance : 0.0;\n  debits = bill.debits ? bill.debits : 0.0;\n  credits = bill.credits ? bill.credits : 0.0;\n  setObj = new Object;\n  setObj.balance = Number((last_balance + credits - debits).toFixed(2));\n  setObj.modified = new Date;\n  return db.billings.direct.update({\n    _id: bill._id\n  }, {\n    $set: setObj\n  });\n};\n\nbillingManager.get_balance = function(space_id, accounting_month, user_count, count_days, module_name, listprice) {\n  var accounting_date, accounting_date_format, days_number, debits, last_balance, last_bill, new_bill, now;\n  accounting_date = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n  days_number = accounting_date.getDate();\n  accounting_date_format = moment(accounting_date).format(\"YYYYMMDD\");\n  debits = Number(((count_days / days_number) * user_count * listprice).toFixed(2));\n  last_bill = db.billings.findOne({\n    space: space_id,\n    billing_date: {\n      $lte: accounting_date_format\n    }\n  }, {\n    sort: {\n      modified: -1\n    }\n  });\n  last_balance = last_bill && last_bill.balance ? last_bill.balance : 0.0;\n  now = new Date;\n  new_bill = new Object;\n  new_bill._id = db.billings._makeNewID();\n  new_bill.billing_month = accounting_month;\n  new_bill.billing_date = accounting_date_format;\n  new_bill.space = space_id;\n  new_bill.transaction = module_name;\n  new_bill.listprice = listprice;\n  new_bill.user_count = user_count;\n  new_bill.debits = debits;\n  new_bill.balance = Number((last_balance - debits).toFixed(2));\n  new_bill.created = now;\n  new_bill.modified = now;\n  return db.billings.direct.insert(new_bill);\n};\n\nbillingManager.getSpaceUserCount = function(space_id) {\n  return db.space_users.find({\n    space: space_id,\n    user_accepted: true\n  }).count();\n};\n\nbillingManager.recaculateBalance = function(accounting_month, space_id) {\n  var refresh_dates;\n  refresh_dates = new Array;\n  db.billings.find({\n    billing_month: accounting_month,\n    space: space_id,\n    transaction: {\n      $in: [\"Payment\", \"Service adjustment\"]\n    }\n  }, {\n    sort: {\n      created: 1\n    }\n  }).forEach(function(bill) {\n    return refresh_dates.push(bill.created);\n  });\n  if (refresh_dates.length > 0) {\n    return _.each(refresh_dates, function(r_d) {\n      return billingManager.refresh_balance(space_id, r_d);\n    });\n  }\n};\n\nbillingManager.get_modules = function(space_id, accounting_month) {\n  var end_date, end_date_time, modules, start_date;\n  modules = new Array;\n  start_date = accounting_month + \"01\";\n  end_date_time = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n  end_date = moment(end_date_time.getTime()).format('YYYYMMDD');\n  db.modules.find().forEach(function(m) {\n    var m_changelog;\n    m_changelog = db.modules_changelogs.findOne({\n      space: space_id,\n      module: m.name,\n      change_date: {\n        $lte: end_date\n      }\n    }, {\n      created: -1\n    });\n    if (!m_changelog) {\n\n    } else if (m_changelog.change_date < start_date && m_changelog.operation === \"install\") {\n      return modules.push(m);\n    } else if (m_changelog.change_date < start_date && m_changelog.operation === \"uninstall\") {\n\n    } else if (m_changelog.change_date >= start_date) {\n      return modules.push(m);\n    }\n  });\n  return modules;\n};\n\nbillingManager.get_modules_name = function() {\n  var modules_name;\n  modules_name = new Array;\n  db.modules.find().forEach(function(m) {\n    return modules_name.push(m.name);\n  });\n  return modules_name;\n};\n\nbillingManager.caculate_by_accounting_month = function(accounting_month, space_id) {\n  var a_m, accounting_date, accounting_date_format, b_m, b_m_d, balance, debits, modules, modules_name, newest_bill, period_result, remaining_months, user_count;\n  if (accounting_month > (moment().format('YYYYMM'))) {\n    return;\n  }\n  if (accounting_month === (moment().format('YYYYMM'))) {\n    billingManager.recaculateBalance(accounting_month, space_id);\n    debits = 0;\n    modules_name = billingManager.get_modules_name();\n    b_m_d = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n    b_m = moment(b_m_d.getTime() - (b_m_d.getDate() * 24 * 60 * 60 * 1000)).format(\"YYYYMMDD\");\n    db.billings.find({\n      billing_date: b_m,\n      space: space_id,\n      transaction: {\n        $in: modules_name\n      }\n    }).forEach(function(b) {\n      return debits += b.debits;\n    });\n    newest_bill = db.billings.findOne({\n      space: space_id\n    }, {\n      sort: {\n        modified: -1\n      }\n    });\n    balance = newest_bill.balance;\n    remaining_months = 0;\n    if (balance > 0) {\n      if (debits > 0) {\n        remaining_months = parseInt(balance / debits) + 1;\n      } else {\n        remaining_months = 1;\n      }\n    }\n    return db.spaces.direct.update({\n      _id: space_id\n    }, {\n      $set: {\n        balance: balance,\n        \"billing.remaining_months\": remaining_months\n      }\n    });\n  } else {\n    period_result = billingManager.get_accounting_period(space_id, accounting_month);\n    if (period_result[\"count_days\"] === 0) {\n      billingManager.recaculateBalance(accounting_month, space_id);\n    } else {\n      user_count = billingManager.getSpaceUserCount(space_id);\n      modules_name = billingManager.get_modules_name();\n      accounting_date = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n      accounting_date_format = moment(accounting_date).format(\"YYYYMMDD\");\n      db.billings.remove({\n        billing_date: accounting_date_format,\n        space: space_id,\n        transaction: {\n          $in: modules_name\n        }\n      });\n      billingManager.recaculateBalance(accounting_month, space_id);\n      modules = billingManager.get_modules(space_id, accounting_month);\n      if (modules && modules.length > 0) {\n        _.each(modules, function(m) {\n          return billingManager.get_balance(space_id, accounting_month, user_count, period_result[\"count_days\"], m.name, m.listprice);\n        });\n      }\n    }\n    a_m = moment(new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 1).getTime()).format(\"YYYYMM\");\n    return billingManager.caculate_by_accounting_month(a_m, space_id);\n  }\n};\n\nbillingManager.special_pay = function(space_id, module_names, total_fee, operator_id, end_date, user_count) {\n  var m, modules, new_modules, now, r, space, space_update_obj;\n  space = db.spaces.findOne(space_id);\n  modules = space.modules || new Array;\n  new_modules = _.difference(module_names, modules);\n  m = moment();\n  now = m._d;\n  space_update_obj = new Object;\n  if (space.is_paid !== true) {\n    space_update_obj.is_paid = true;\n    space_update_obj.start_date = new Date;\n  }\n  space_update_obj.modules = module_names;\n  space_update_obj.modified = now;\n  space_update_obj.modified_by = operator_id;\n  space_update_obj.end_date = new Date(end_date);\n  space_update_obj.user_limit = user_count;\n  r = db.spaces.direct.update({\n    _id: space_id\n  }, {\n    $set: space_update_obj\n  });\n  if (r) {\n    _.each(new_modules, function(module) {\n      var mcl;\n      mcl = new Object;\n      mcl._id = db.modules_changelogs._makeNewID();\n      mcl.change_date = m.format(\"YYYYMMDD\");\n      mcl.operator = operator_id;\n      mcl.space = space_id;\n      mcl.operation = \"install\";\n      mcl.module = module;\n      mcl.created = now;\n      return db.modules_changelogs.insert(mcl);\n    });\n  }\n};\n","Meteor.startup(function () {\n\n  if (Meteor.settings.cron && Meteor.settings.cron.statistics) {\n\n    var schedule = require('node-schedule');\n    // 定时执行统计\n    var rule = Meteor.settings.cron.statistics;\n\n    var go_next = true;\n\n    schedule.scheduleJob(rule, Meteor.bindEnvironment(function () {\n      if (!go_next)\n        return;\n      go_next = false;\n\n      console.time('statistics');\n      // 日期格式化 \n      var dateFormat = function (date) {\n        var datekey = \"\"+date.getFullYear()+\"-\"+(date.getMonth()+1)+\"-\"+(date.getDate());\n        return datekey;\n      };\n      // 计算前一天时间\n      var yesterDay = function () {\n        var dNow = new Date();   //当前时间\n        var dBefore = new Date(dNow.getTime() - 24*3600*1000);   //得到前一天的时间\n        return dBefore;\n      };\n      // 统计当日数据\n      var dailyStaticsCount = function (collection, space) {\n        var statics = collection.find({\"space\":space[\"_id\"],\"created\":{$gt: yesterDay()}});\n        return statics.count();\n      };\n      // 查询总数\n      var staticsCount = function (collection, space) {\n        var statics = collection.find({\"space\": space[\"_id\"]});\n        return statics.count();\n      };\n      // 查询拥有者名字\n      var ownerName = function (collection, space) {\n        var owner = collection.findOne({\"_id\": space[\"owner\"]});\n        var name = owner.name;\n        return name;\n      };\n      // 最近登录日期\n      var lastLogon = function (collection, space) {\n        var lastLogon = 0;\n        var sUsers = db.space_users.find({\"space\": space[\"_id\"]}, {fields: {user: 1}}); \n        sUsers.forEach(function (sUser) {\n          var user = collection.findOne({\"_id\":sUser[\"user\"]});\n          if(user && (lastLogon < user.last_logon)){\n            lastLogon = user.last_logon;\n          }\n        })\n        return lastLogon;\n      };\n      // 最近修改日期\n      var lastModified = function (collection, space) {\n        var obj = collection.find({\"space\": space[\"_id\"]}, {sort: {modified: -1}, limit: 1});\n        var objArr = obj.fetch();\n        if(objArr.length > 0)\n          var mod = objArr[0].modified;\n          return mod;\n      };\n      // 文章附件大小\n      var postsAttachments = function (collection, space) {\n        var attSize = 0;\n        var sizeSum = 0;\n        var posts = collection.find({\"space\": space[\"_id\"]});\n        posts.forEach(function (post) {\n          var atts = cfs.posts.find({\"post\":post[\"_id\"]});\n          atts.forEach(function (att) {\n            attSize = att.original.size;\n            sizeSum += attSize;\n          })  \n        })\n        return sizeSum;\n      };\n      // 当日新增附件大小\n      var dailyPostsAttachments = function (collection, space) {\n        var attSize = 0;\n        var sizeSum = 0;\n        var posts = collection.find({\"space\": space[\"_id\"]});\n        posts.forEach(function (post) {\n          var atts = cfs.posts.find({\"post\": post[\"_id\"], \"uploadedAt\": {$gt: yesterDay()}});\n          atts.forEach(function (att) {\n            attSize = att.original.size;\n            sizeSum += attSize;\n          })\n        })\n        return sizeSum;\n      };\n      // 插入数据\n      db.spaces.find({\"is_paid\":true}).forEach(function (space) {\n        db.steedos_statistics.insert({\n          space: space[\"_id\"],\n          space_name: space[\"name\"],\n          balance: space[\"balance\"],\n          owner_name: ownerName(db.users, space),\n          created: new Date(),\n          steedos:{\n            users: staticsCount(db.space_users, space),\n            organizations: staticsCount(db.organizations, space),\n            last_logon: lastLogon(db.users, space)\n          },\n          workflow:{\n            flows: staticsCount(db.flows, space),\n            forms: staticsCount(db.forms, space),\n            flow_roles: staticsCount(db.flow_roles, space),\n            flow_positions: staticsCount(db.flow_positions, space),\n            instances: staticsCount(db.instances, space),\n            instances_last_modified: lastModified(db.instances, space),\n            daily_flows: dailyStaticsCount(db.flows, space),\n            daily_forms: dailyStaticsCount(db.forms, space),\n            daily_instances: dailyStaticsCount(db.instances, space)\n          },\n          cms: {\n            sites: staticsCount(db.cms_sites, space),\n            posts: staticsCount(db.cms_posts, space),\n            posts_last_modified: lastModified(db.cms_posts, space),\n            posts_attachments_size: postsAttachments(db.cms_posts, space),\n            comments: staticsCount(db.cms_comments, space),\n            daily_sites: dailyStaticsCount(db.cms_sites, space),\n            daily_posts: dailyStaticsCount(db.cms_posts, space),\n            daily_comments: dailyStaticsCount(db.cms_comments, space),\n            daily_posts_attachments_size: dailyPostsAttachments(db.cms_posts, space)\n          }\n        });\n      });\n      \n      console.timeEnd('statistics');\n\n      go_next = true;\n\n    }, function (e) {\n      console.log('Failed to bind environment: statistics.js');\n      console.log(e.stack);\n    }));\n\n  }\n\n})\n\n\n\n\n","Meteor.startup ->\n    Migrations.add\n        version: 1\n        name: '在线编辑时，需给文件增加lock 属性，防止多人同时编辑 #429, 附件页面使用cfs显示'\n        up: ->\n            console.time('upgrade_cfs_instance')\n            try\n                update_cfs_instance = (parent_id, space_id, instance_id, attach_version, isCurrent)->\n                    metadata = {parent: parent_id, owner: attach_version['created_by'], owner_name: attach_version['created_by_name'], space: space_id, instance: instance_id, approve: attach_version['approve']}\n                    if isCurrent\n                        metadata.current = true\n\n                    cfs.instances.update({_id: attach_version['_rev']}, {$set: {metadata: metadata}})\n                i = 0\n                db.instances.find({\"attachments.current\": {$exists: true}}, {sort: {modified: -1}, fields: {space: 1, attachments: 1}}).forEach (ins) ->\n                    attachs = ins.attachments\n                    space_id = ins.space\n                    instance_id = ins._id\n                    attachs.forEach (att)->\n                        current_ver = att.current\n                        parent_id = current_ver._rev\n                        update_cfs_instance(parent_id, space_id, instance_id, current_ver, true)\n\n                        if att.historys\n                            att.historys.forEach (his) ->\n                                update_cfs_instance(parent_id, space_id, instance_id, his, false)\n\n                    i++\n\n            catch e\n                console.error(e)\n\n            console.timeEnd('upgrade_cfs_instance')\n        down: ->\n            console.log('version 1 down')","Meteor.startup(function() {\n  return Migrations.add({\n    version: 1,\n    name: '在线编辑时，需给文件增加lock 属性，防止多人同时编辑 #429, 附件页面使用cfs显示',\n    up: function() {\n      var e, i, update_cfs_instance;\n      console.time('upgrade_cfs_instance');\n      try {\n        update_cfs_instance = function(parent_id, space_id, instance_id, attach_version, isCurrent) {\n          var metadata;\n          metadata = {\n            parent: parent_id,\n            owner: attach_version['created_by'],\n            owner_name: attach_version['created_by_name'],\n            space: space_id,\n            instance: instance_id,\n            approve: attach_version['approve']\n          };\n          if (isCurrent) {\n            metadata.current = true;\n          }\n          return cfs.instances.update({\n            _id: attach_version['_rev']\n          }, {\n            $set: {\n              metadata: metadata\n            }\n          });\n        };\n        i = 0;\n        db.instances.find({\n          \"attachments.current\": {\n            $exists: true\n          }\n        }, {\n          sort: {\n            modified: -1\n          },\n          fields: {\n            space: 1,\n            attachments: 1\n          }\n        }).forEach(function(ins) {\n          var attachs, instance_id, space_id;\n          attachs = ins.attachments;\n          space_id = ins.space;\n          instance_id = ins._id;\n          attachs.forEach(function(att) {\n            var current_ver, parent_id;\n            current_ver = att.current;\n            parent_id = current_ver._rev;\n            update_cfs_instance(parent_id, space_id, instance_id, current_ver, true);\n            if (att.historys) {\n              return att.historys.forEach(function(his) {\n                return update_cfs_instance(parent_id, space_id, instance_id, his, false);\n              });\n            }\n          });\n          return i++;\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_cfs_instance');\n    },\n    down: function() {\n      return console.log('version 1 down');\n    }\n  });\n});\n","Meteor.startup ->\n    Migrations.add\n        version: 2\n        name: '组织结构允许一个人属于多个部门 #379'\n        up: ->\n            console.log 'version 2 up'\n            console.time 'upgrade_space_user'\n            try\n                collection = db.space_users\n                collection.find({organizations: {$exists: false}}, {fields: {organization: 1}}).forEach (su)->\n                    if su.organization\n                        collection.direct.update(su._id, {$set: {organizations: [su.organization]}})\n\n            catch e\n                console.error e\n\n            console.timeEnd 'upgrade_space_user'\n        down: ->\n            console.log 'version 2 down'\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 2,\n    name: '组织结构允许一个人属于多个部门 #379',\n    up: function() {\n      var collection, e;\n      console.log('version 2 up');\n      console.time('upgrade_space_user');\n      try {\n        collection = db.space_users;\n        collection.find({\n          organizations: {\n            $exists: false\n          }\n        }, {\n          fields: {\n            organization: 1\n          }\n        }).forEach(function(su) {\n          if (su.organization) {\n            return collection.direct.update(su._id, {\n              $set: {\n                organizations: [su.organization]\n              }\n            });\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_space_user');\n    },\n    down: function() {\n      return console.log('version 2 down');\n    }\n  });\n});\n","Meteor.startup ->\n    Migrations.add\n        version: 3\n        name: '给space_users表email字段赋值'\n        up: ->\n            console.log 'version 3 up'\n            console.time 'upgrade_space_user_email'\n            try\n                collection = db.space_users\n                collection.find({email: {$exists: false}}, {fields: {user: 1}}).forEach (su)->\n                    if su.user\n                        u = db.users.findOne({_id: su.user}, {fields: {emails: 1}})\n                        if u && u.emails && u.emails.length > 0\n                            if /^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(u.emails[0].address)\n                                address = u.emails[0].address\n                                collection.direct.update(su._id, {$set: {email: address}})\n                        \n\n            catch e\n                console.error e\n\n            console.timeEnd 'upgrade_space_user_email'\n        down: ->\n            console.log 'version 3 down'\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 3,\n    name: '给space_users表email字段赋值',\n    up: function() {\n      var collection, e;\n      console.log('version 3 up');\n      console.time('upgrade_space_user_email');\n      try {\n        collection = db.space_users;\n        collection.find({\n          email: {\n            $exists: false\n          }\n        }, {\n          fields: {\n            user: 1\n          }\n        }).forEach(function(su) {\n          var address, u;\n          if (su.user) {\n            u = db.users.findOne({\n              _id: su.user\n            }, {\n              fields: {\n                emails: 1\n              }\n            });\n            if (u && u.emails && u.emails.length > 0) {\n              if (/^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(u.emails[0].address)) {\n                address = u.emails[0].address;\n                return collection.direct.update(su._id, {\n                  $set: {\n                    email: address\n                  }\n                });\n              }\n            }\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_space_user_email');\n    },\n    down: function() {\n      return console.log('version 3 down');\n    }\n  });\n});\n","Meteor.startup ->\n    Migrations.add\n        version: 4\n        name: '给organizations表设置sort_no'\n        up: ->\n            console.log 'version 4 up'\n            console.time 'upgrade_organizations_sort_no'\n            try\n                db.organizations.direct.update({sort_no: {$exists: false}}, {$set: {sort_no: 100}}, {multi: true})\n            catch e\n                console.error e\n\n            console.timeEnd 'upgrade_organizations_sort_no'\n        down: ->\n            console.log 'version 4 down'\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 4,\n    name: '给organizations表设置sort_no',\n    up: function() {\n      var e;\n      console.log('version 4 up');\n      console.time('upgrade_organizations_sort_no');\n      try {\n        db.organizations.direct.update({\n          sort_no: {\n            $exists: false\n          }\n        }, {\n          $set: {\n            sort_no: 100\n          }\n        }, {\n          multi: true\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_organizations_sort_no');\n    },\n    down: function() {\n      return console.log('version 4 down');\n    }\n  });\n});\n","Meteor.startup ->\n\tMigrations.add\n\t\tversion: 5\n\t\tname: '解决删除organization导致space_user数据错误的问题'\n\t\tup: ->\n\t\t\tconsole.log 'version 5 up'\n\t\t\tconsole.time 'fix_space_user_organizations'\n\t\t\ttry\n\n\t\t\t\tdb.space_users.find().forEach (su)->\n\t\t\t\t\tif not su.organizations\n\t\t\t\t\t\treturn\n\t\t\t\t\tif su.organizations.length is 1\n\t\t\t\t\t\tcheck_count = db.organizations.find(su.organizations[0]).count()\n\t\t\t\t\t\tif check_count is 0\n\t\t\t\t\t\t\troot_org = db.organizations.findOne({space: su.space, parent: null})\n\t\t\t\t\t\t\tif root_org\n\t\t\t\t\t\t\t\tr = db.space_users.direct.update({_id: su._id}, {$set: {organizations: [root_org._id], organization: root_org._id}})\n\t\t\t\t\t\t\t\tif r\n\t\t\t\t\t\t\t\t\troot_org.updateUsers()\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tconsole.error \"fix_space_user_organizations\"\n\t\t\t\t\t\t\t\tconsole.error su._id\n\t\t\t\t\telse if su.organizations.length > 1\n\t\t\t\t\t\tremoved_org_ids = []\n\t\t\t\t\t\tsu.organizations.forEach (o)->\n\t\t\t\t\t\t\tcheck_count = db.organizations.find(o).count()\n\t\t\t\t\t\t\tif check_count is 0\n\t\t\t\t\t\t\t\tremoved_org_ids.push(o)\n\t\t\t\t\t\tif removed_org_ids.length > 0\n\t\t\t\t\t\t\tnew_org_ids = _.difference(su.organizations, removed_org_ids)\n\t\t\t\t\t\t\tif new_org_ids.includes(su.organization)\n\t\t\t\t\t\t\t\tdb.space_users.direct.update({_id: su._id}, {$set: {organizations: new_org_ids}})\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tdb.space_users.direct.update({_id: su._id}, {$set: {organizations: new_org_ids, organization: new_org_ids[0]}})\n\n\t\t\tcatch e\n\t\t\t\tconsole.error \"fix_space_user_organizations\"\n\t\t\t\tconsole.error e.stack\n\n\t\t\tconsole.timeEnd 'fix_space_user_organizations'\n\t\tdown: ->\n\t\t\tconsole.log 'version 5 down'\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 5,\n    name: '解决删除organization导致space_user数据错误的问题',\n    up: function() {\n      var e;\n      console.log('version 5 up');\n      console.time('fix_space_user_organizations');\n      try {\n        db.space_users.find().forEach(function(su) {\n          var check_count, new_org_ids, r, removed_org_ids, root_org;\n          if (!su.organizations) {\n            return;\n          }\n          if (su.organizations.length === 1) {\n            check_count = db.organizations.find(su.organizations[0]).count();\n            if (check_count === 0) {\n              root_org = db.organizations.findOne({\n                space: su.space,\n                parent: null\n              });\n              if (root_org) {\n                r = db.space_users.direct.update({\n                  _id: su._id\n                }, {\n                  $set: {\n                    organizations: [root_org._id],\n                    organization: root_org._id\n                  }\n                });\n                if (r) {\n                  return root_org.updateUsers();\n                }\n              } else {\n                console.error(\"fix_space_user_organizations\");\n                return console.error(su._id);\n              }\n            }\n          } else if (su.organizations.length > 1) {\n            removed_org_ids = [];\n            su.organizations.forEach(function(o) {\n              check_count = db.organizations.find(o).count();\n              if (check_count === 0) {\n                return removed_org_ids.push(o);\n              }\n            });\n            if (removed_org_ids.length > 0) {\n              new_org_ids = _.difference(su.organizations, removed_org_ids);\n              if (new_org_ids.includes(su.organization)) {\n                return db.space_users.direct.update({\n                  _id: su._id\n                }, {\n                  $set: {\n                    organizations: new_org_ids\n                  }\n                });\n              } else {\n                return db.space_users.direct.update({\n                  _id: su._id\n                }, {\n                  $set: {\n                    organizations: new_org_ids,\n                    organization: new_org_ids[0]\n                  }\n                });\n              }\n            }\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(\"fix_space_user_organizations\");\n        console.error(e.stack);\n      }\n      return console.timeEnd('fix_space_user_organizations');\n    },\n    down: function() {\n      return console.log('version 5 down');\n    }\n  });\n});\n","Meteor.startup ->\n\tMigrations.add\n\t\tversion: 6\n\t\tname: '财务系统升级'\n\t\tup: ->\n\t\t\tconsole.log 'version 6 up'\n\t\t\tconsole.time 'billing upgrade'\n\t\t\ttry\n\t\t\t\t# 清空modules表\n\t\t\t\tdb.modules.remove({})\n\n\t\t\t\tdb.modules.insert({\n\t\t\t\t\t\"_id\": \"workflow.standard\",\n\t\t\t\t\t\"name_en\": \"Workflow Standard\",\n\t\t\t\t\t\"name\": \"workflow.standard\",\n\t\t\t\t\t\"name_zh\": \"审批王基础版\",\n\t\t\t\t\t\"listprice\": 1.0,\n\t\t\t\t\t\"listprice_rmb\": 2\n\t\t\t\t})\n\n\t\t\t\tdb.modules.insert({\n\t\t\t\t\t\"_id\": \"workflow.professional\",\n\t\t\t\t\t\"name_en\": \"Workflow Professional\",\n\t\t\t\t\t\"name\": \"workflow.professional\",\n\t\t\t\t\t\"name_zh\": \"审批王专业版扩展包\",\n\t\t\t\t\t\"listprice\": 3.0,\n\t\t\t\t\t\"listprice_rmb\": 18\n\t\t\t\t})\n\n\t\t\t\tdb.modules.insert({\n\t\t\t\t\t\"_id\": \"workflow.enterprise\",\n\t\t\t\t\t\"name_en\": \"Workflow Enterprise\",\n\t\t\t\t\t\"name\": \"workflow.enterprise\",\n\t\t\t\t\t\"name_zh\": \"审批王企业版扩展包\",\n\t\t\t\t\t\"listprice\": 6.0,\n\t\t\t\t\t\"listprice_rmb\": 40\n\t\t\t\t})\n\n\n\t\t\t\tstart_date = new Date(moment(new Date).format(\"YYYY-MM-DD\"))\n\t\t\t\tdb.spaces.find({is_paid: true, user_limit: {$exists: false}, modules: {$exists: true}}).forEach (s)->\n\t\t\t\t\ttry\n\t\t\t\t\t\tset_obj = {}\n\t\t\t\t\t\tuser_count = db.space_users.find({space: s._id, user_accepted: true}).count()\n\t\t\t\t\t\tset_obj.user_limit = user_count\n\t\t\t\t\t\tbalance = s.balance\n\t\t\t\t\t\tif balance > 0\n\t\t\t\t\t\t\tmonths = 0\n\t\t\t\t\t\t\tlistprices = 0\n\t\t\t\t\t\t\t_.each s.modules, (pm)->\n\t\t\t\t\t\t\t\tmodule = db.modules.findOne({name: pm})\n\t\t\t\t\t\t\t\tif module and module.listprice\n\t\t\t\t\t\t\t\t\tlistprices += module.listprice\n\t\t\t\t\t\t\tmonths = parseInt((balance/(listprices*user_count)).toFixed()) + 1\n\t\t\t\t\t\t\tend_date = new Date\n\t\t\t\t\t\t\tend_date.setMonth(end_date.getMonth()+months)\n\t\t\t\t\t\t\tend_date = new Date(moment(end_date).format(\"YYYY-MM-DD\"))\n\t\t\t\t\t\t\tset_obj.start_date = start_date\n\t\t\t\t\t\t\tset_obj.end_date = end_date\n\n\t\t\t\t\t\telse if balance <= 0\n\t\t\t\t\t\t\tset_obj.start_date = start_date\n\t\t\t\t\t\t\tset_obj.end_date = new Date\n\n\t\t\t\t\t\ts.modules.push(\"workflow.standard\")\n\t\t\t\t\t\tset_obj.modules = _.uniq(s.modules)\n\t\t\t\t\t\tdb.spaces.direct.update({_id: s._id}, {$set: set_obj})\n\t\t\t\t\tcatch e\n\t\t\t\t\t\tconsole.error \"billing space upgrade\"\n\t\t\t\t\t\tconsole.error(s._id)\n\t\t\t\t\t\tconsole.error(set_obj)\n\t\t\t\t\t\tconsole.error e.stack\n\n\t\t\tcatch e\n\t\t\t\tconsole.error \"billing upgrade\"\n\t\t\t\tconsole.error e.stack\n\n\t\t\tconsole.timeEnd 'billing upgrade'\n\t\tdown: ->\n\t\t\tconsole.log 'version 6 down'\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 6,\n    name: '财务系统升级',\n    up: function() {\n      var e, start_date;\n      console.log('version 6 up');\n      console.time('billing upgrade');\n      try {\n        db.modules.remove({});\n        db.modules.insert({\n          \"_id\": \"workflow.standard\",\n          \"name_en\": \"Workflow Standard\",\n          \"name\": \"workflow.standard\",\n          \"name_zh\": \"审批王基础版\",\n          \"listprice\": 1.0,\n          \"listprice_rmb\": 2\n        });\n        db.modules.insert({\n          \"_id\": \"workflow.professional\",\n          \"name_en\": \"Workflow Professional\",\n          \"name\": \"workflow.professional\",\n          \"name_zh\": \"审批王专业版扩展包\",\n          \"listprice\": 3.0,\n          \"listprice_rmb\": 18\n        });\n        db.modules.insert({\n          \"_id\": \"workflow.enterprise\",\n          \"name_en\": \"Workflow Enterprise\",\n          \"name\": \"workflow.enterprise\",\n          \"name_zh\": \"审批王企业版扩展包\",\n          \"listprice\": 6.0,\n          \"listprice_rmb\": 40\n        });\n        start_date = new Date(moment(new Date).format(\"YYYY-MM-DD\"));\n        db.spaces.find({\n          is_paid: true,\n          user_limit: {\n            $exists: false\n          },\n          modules: {\n            $exists: true\n          }\n        }).forEach(function(s) {\n          var balance, e, end_date, listprices, months, set_obj, user_count;\n          try {\n            set_obj = {};\n            user_count = db.space_users.find({\n              space: s._id,\n              user_accepted: true\n            }).count();\n            set_obj.user_limit = user_count;\n            balance = s.balance;\n            if (balance > 0) {\n              months = 0;\n              listprices = 0;\n              _.each(s.modules, function(pm) {\n                var module;\n                module = db.modules.findOne({\n                  name: pm\n                });\n                if (module && module.listprice) {\n                  return listprices += module.listprice;\n                }\n              });\n              months = parseInt((balance / (listprices * user_count)).toFixed()) + 1;\n              end_date = new Date;\n              end_date.setMonth(end_date.getMonth() + months);\n              end_date = new Date(moment(end_date).format(\"YYYY-MM-DD\"));\n              set_obj.start_date = start_date;\n              set_obj.end_date = end_date;\n            } else if (balance <= 0) {\n              set_obj.start_date = start_date;\n              set_obj.end_date = new Date;\n            }\n            s.modules.push(\"workflow.standard\");\n            set_obj.modules = _.uniq(s.modules);\n            return db.spaces.direct.update({\n              _id: s._id\n            }, {\n              $set: set_obj\n            });\n          } catch (error) {\n            e = error;\n            console.error(\"billing space upgrade\");\n            console.error(s._id);\n            console.error(set_obj);\n            return console.error(e.stack);\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(\"billing upgrade\");\n        console.error(e.stack);\n      }\n      return console.timeEnd('billing upgrade');\n    },\n    down: function() {\n      return console.log('version 6 down');\n    }\n  });\n});\n","Meteor.startup ()->\n    rootURL = Meteor.absoluteUrl()\n    if !Meteor.settings.public.webservices\n        Meteor.settings.public.webservices = {\n            \"creator\": {\n                \"url\": rootURL\n            }\n        }\n\n    if !Meteor.settings.public.webservices.creator\n        Meteor.settings.public.webservices.creator = {\n            \"url\": rootURL\n        }\n\n    if !Meteor.settings.public.webservices.creator.url\n        Meteor.settings.public.webservices.creator.url = rootURL","Meteor.startup(function() {\n  var rootURL;\n  rootURL = Meteor.absoluteUrl();\n  if (!Meteor.settings[\"public\"].webservices) {\n    Meteor.settings[\"public\"].webservices = {\n      \"creator\": {\n        \"url\": rootURL\n      }\n    };\n  }\n  if (!Meteor.settings[\"public\"].webservices.creator) {\n    Meteor.settings[\"public\"].webservices.creator = {\n      \"url\": rootURL\n    };\n  }\n  if (!Meteor.settings[\"public\"].webservices.creator.url) {\n    return Meteor.settings[\"public\"].webservices.creator.url = rootURL;\n  }\n});\n","if(process.env.CREATOR_NODE_ENV == 'development'){\n\t//Meteor 版本升级到1.9 及以上时(node 版本 11+)，可以删除此代码\n\tObject.defineProperty(Array.prototype, 'flat', {\n\t\tvalue: function(depth = 1) {\n\t\t\treturn this.reduce(function (flat, toFlatten) {\n\t\t\t\treturn flat.concat((Array.isArray(toFlatten) && (depth>1)) ? toFlatten.flat(depth-1) : toFlatten);\n\t\t\t}, []);\n\t\t}\n\t});\n}","Meteor.startup ()->\n\tnew Tabular.Table\n\t\tname: \"customize_apps\",\n\t\tcollection: db.apps,\n\t\tcolumns: [\n\t\t\t{\n\t\t\t\tdata: \"name\"\n\t\t\t\torderable: false\n\t\t\t}\n\t\t]\n\t\tdom: \"tp\"\n\t\textraFields: [\"_id\", \"space\"]\n\t\tlengthChange: false\n\t\tordering: false\n\t\tpageLength: 10\n\t\tinfo: false\n\t\tsearching: true\n\t\tautoWidth: true\n\t\tchangeSelector: (selector, userId) ->\n\t\t\tunless userId\n\t\t\t\treturn {_id: -1}\n\t\t\tspace = selector.space\n\t\t\tunless space\n\t\t\t\tif selector?.$and?.length > 0\n\t\t\t\t\tspace = selector.$and.getProperty('space')[0]\n\t\t\tunless space\n\t\t\t\treturn {_id: -1}\n\t\t\treturn selector","Meteor.startup(function() {\n  return new Tabular.Table({\n    name: \"customize_apps\",\n    collection: db.apps,\n    columns: [\n      {\n        data: \"name\",\n        orderable: false\n      }\n    ],\n    dom: \"tp\",\n    extraFields: [\"_id\", \"space\"],\n    lengthChange: false,\n    ordering: false,\n    pageLength: 10,\n    info: false,\n    searching: true,\n    autoWidth: true,\n    changeSelector: function(selector, userId) {\n      var ref, space;\n      if (!userId) {\n        return {\n          _id: -1\n        };\n      }\n      space = selector.space;\n      if (!space) {\n        if ((selector != null ? (ref = selector.$and) != null ? ref.length : void 0 : void 0) > 0) {\n          space = selector.$and.getProperty('space')[0];\n        }\n      }\n      if (!space) {\n        return {\n          _id: -1\n        };\n      }\n      return selector;\n    }\n  });\n});\n"]}